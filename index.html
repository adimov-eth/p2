<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLN Consensus Visual Debug</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            overflow-x: hidden; /* Prevent horizontal scroll on entire page */
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
            min-height: 100vh;
            color: #e8e8e8;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .admin-topbar {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 0 1px 0 rgba(255, 255, 255, 0.05) inset;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #007acc;
            font-weight: 600;
        }
        
        .logo-text {
            font-family: 'Monaco', 'Menlo', 'Consolas', 'Courier New', monospace;
            font-size: 20px;
            font-weight: 400;
            color: #ffffff;
            letter-spacing: 0.5px;
            text-transform: lowercase;
        }

        .logo-icon {
            font-size: 1.4em;
            color: #ffffff;
        }

        .admin-navigation {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            max-width: 600px;
        }

        .admin-select {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 14px;
            color: #e8e8e8;
            font-size: 0.9em;
            font-weight: 500;
            min-width: 180px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .admin-select:hover {
            border-color: rgba(0, 212, 170, 0.3);
            background: rgba(40, 40, 40, 0.9);
        }

        .admin-select:focus {
            outline: none;
            border-color: #00d4aa;
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.2), 0 4px 12px rgba(0, 0, 0, 0.3);
            background: rgba(35, 35, 35, 0.95);
        }

        .admin-select:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .admin-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Split View Controls */
        .split-view-controls {
            background: #252526;
            border: 1px solid #3e3e3e;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .add-entity-panel-btn {
            background: #007acc;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            color: white;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-entity-panel-btn:hover {
            background: #0086e6;
            transform: translateY(-1px);
        }

        /* Entity Panels Side-by-Side Layout */
        .entity-panels-container {
            display: flex;
            gap: 0;
            padding: 0;
            width: 100%;
            height: calc(100vh - 80px);
            overflow-x: auto;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #666 #2d2d2d;
        }

        .entity-panels-container::-webkit-scrollbar {
            height: 8px;
        }

        .entity-panels-container::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }

        .entity-panels-container::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 4px;
        }

        .entity-panel {
            background: #2d2d2d;
            border-right: 1px solid #3e3e3e;
            padding: 20px;
            flex: 1;
            min-width: 25vw;
        }

        /* Dynamic panel width based on number of panels */
        .entity-panels-container[data-panel-count="1"] .entity-panel {
            flex: 1;
            min-width: 100%;
        }

        .entity-panels-container[data-panel-count="2"] .entity-panel {
            flex: 1;
            min-width: 50%;
        }

        .entity-panels-container[data-panel-count="3"] .entity-panel {
            flex: 1;
            min-width: 33.333%;
        }

        .entity-panels-container[data-panel-count="4"] .entity-panel,
        .entity-panels-container[data-panel-count="5"] .entity-panel,
        .entity-panels-container[data-panel-count="6"] .entity-panel,
        .entity-panels-container[data-panel-count="7"] .entity-panel,
        .entity-panels-container[data-panel-count="8"] .entity-panel,
        .entity-panels-container[data-panel-count="9"] .entity-panel,
        .entity-panels-container[data-panel-count="10"] .entity-panel {
            flex: 0 0 25vw;
            min-width: 25vw;
        }





        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #3e3e3e;
            gap: 12px;
        }

        .panel-header .unified-dropdown {
            flex: 1;
        }

        /* Collapsible Component System */
        .panel-component {
            background: #252526;
            border: 1px solid #3e3e3e;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .component-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #3e3e3e;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        .component-header:hover {
            background: #333333;
        }

        .component-title {
            font-size: 0.9em;
            font-weight: 500;
            color: #d4d4d4;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .component-toggle {
            color: #9d9d9d;
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .component-header.collapsed .component-toggle {
            transform: rotate(-90deg);
        }

        .component-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }

        .component-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        /* Consensus State Component */
        .consensus-state {
            padding: 12px;
            font-size: 0.85em;
        }

        .consensus-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #3e3e3e;
        }

        .consensus-item:last-child {
            border-bottom: none;
        }

        .consensus-label {
            color: #9d9d9d;
        }

        .consensus-value {
            color: #d4d4d4;
            font-weight: 500;
        }

        .consensus-status-locked {
            color: #f14c4c;
        }

        .consensus-status-unlocked {
            color: #4ade80;
        }

        /* Scrollable Components (Chat, Proposals, History) */
        .scrollable-component {
            height: 25vh;
            overflow-y: auto;
            padding: 8px;
        }

        .scrollable-component::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-component::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .scrollable-component::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
            font-size: 0.9em;
        }

        /* Chat Component */
        .chat-message {
            background: #2d2d2d;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #007acc;
        }

        .chat-meta {
            font-size: 0.75em;
            color: #9d9d9d;
            margin-bottom: 4px;
        }

        .chat-content {
            color: #d4d4d4;
            font-size: 0.85em;
        }

        /* Proposals Component */
        .proposal-item {
            background: #2d2d2d;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #7c3aed;
        }

        .proposal-title {
            font-weight: 500;
            color: #d4d4d4;
            margin-bottom: 4px;
            font-size: 0.85em;
        }

        .proposal-meta {
            font-size: 0.75em;
            color: #9d9d9d;
            display: flex;
            justify-content: space-between;
        }
        
        .proposal-item.executed {
            border-left-color: #22c55e;
            background: #1e3a2e;
        }
        
        .executed-badge {
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
        }
        
        .proposal-progress {
            margin-top: 8px;
        }
        
        .progress-bar {
            background: #3d3d3d;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #7c3aed, #a855f7);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 0.75em;
            color: #888;
        }
        
        .vote-details {
            margin-top: 6px;
            font-size: 0.75em;
            color: #aaa;
            line-height: 1.3;
        }

        /* Transaction History Component */
        .tx-item {
            background: #2d2d2d;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #fb923c;
        }

        .tx-meta {
            font-size: 0.75em;
            color: #9d9d9d;
            margin-bottom: 4px;
        }

        .tx-details {
            color: #d4d4d4;
            font-size: 0.85em;
        }

        /* Controls Component */
        .controls-section {
            padding: 12px;
        }

        .controls-dropdown {
            width: 100%;
            padding: 8px;
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            margin-bottom: 12px;
        }

        .controls-form {
            transition: all 0.3s ease;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            color: #9d9d9d;
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 6px 8px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 0.85em;
            resize: vertical;
        }

        .form-textarea {
            min-height: 60px;
        }

        .form-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background-color 0.2s ease;
        }

        .form-button:hover {
            background: #0086e6;
        }

        /* Universal horizontal scroll for all components */
        .panel-component .component-content,
        .board-container,
        .consensus-item,
        .chat-message,
        .proposal-item,
        .frame-item,
        .tx-item {
            overflow-x: auto;
            overflow-y: auto;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
            scrollbar-width: thin;
            scrollbar-color: #666 #2d2d2d;
        }

        /* Webkit scrollbar styling for all components */
        .panel-component .component-content::-webkit-scrollbar,
        .board-container::-webkit-scrollbar,
        .consensus-item::-webkit-scrollbar,
        .chat-message::-webkit-scrollbar,
        .proposal-item::-webkit-scrollbar,
        .frame-item::-webkit-scrollbar,
        .tx-item::-webkit-scrollbar {
            height: 4px;
            width: 4px;
        }

        .panel-component .component-content::-webkit-scrollbar-thumb,
        .board-container::-webkit-scrollbar-thumb,
        .consensus-item::-webkit-scrollbar-thumb,
        .chat-message::-webkit-scrollbar-thumb,
        .proposal-item::-webkit-scrollbar-thumb,
        .frame-item::-webkit-scrollbar-thumb,
        .tx-item::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 2px;
        }

        .panel-component .component-content::-webkit-scrollbar-track,
        .board-container::-webkit-scrollbar-track,
        .consensus-item::-webkit-scrollbar-track,
        .chat-message::-webkit-scrollbar-track,
        .proposal-item::-webkit-scrollbar-track,
        .frame-item::-webkit-scrollbar-track,
        .tx-item::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 2px;
        }

        /* Board Component Styling */
        .board-container {
            width: 100%;
        }

        .board-header {
            font-size: 0.8em;
            color: #007acc;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .board-members {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 120px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #666 #2d2d2d;
        }

        .board-members::-webkit-scrollbar {
            width: 4px;
        }

        .board-members::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 2px;
        }

        .board-members::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 2px;
        }

        .board-member {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.8em;
        }

        .board-member:hover {
            background: #404040;
        }

        .board-member.current-signer {
            background: #1e3a5f;
            border: 1px solid #007acc;
        }

        .board-avatar {
            width: 16px;
            height: 16px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .board-name {
            flex: 1;
            color: #d4d4d4;
            font-size: 0.8em;
        }

        .board-weight {
            background: #404040;
            color: #007acc;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 4px;
            min-width: 20px;
            text-align: center;
        }

        .proposer-badge,
        .current-badge {
            font-size: 0.7em;
        }

        .proposer-badge {
            color: #ffd700;
        }

        .current-badge {
            color: #007acc;
        }

        /* Entity History Panel Styling */
        .entity-history-panel {
            background: #1e1e1e;
        }

        .entity-history-container {
            height: 40vh;
            overflow-y: auto;
            padding: 0;
        }

        .frame-item {
            border-bottom: 1px solid #3e3e3e;
            padding: 12px;
            margin-bottom: 0;
        }

        .frame-item:last-child {
            border-bottom: none;
        }

        .frame-item.current-frame {
            background: #1e3a5f;
            border-left: 3px solid #007acc;
        }

        .frame-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
            font-weight: 500;
            color: #007acc;
        }

        .frame-time {
            font-size: 0.8em;
            color: #9d9d9d;
        }

        .frame-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .frame-inputs,
        .frame-outputs {
            background: #2d2d2d;
            border-radius: 4px;
            padding: 8px;
        }

        .frame-section-title {
            font-size: 0.8em;
            font-weight: 500;
            color: #d4d4d4;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .frame-item-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .frame-data-item {
            background: #1a1a1a;
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 0.75em;
            color: #d4d4d4;
            border-left: 2px solid #555;
        }

        .frame-data-item.input {
            border-left-color: #4ade80;
        }

        .frame-data-item.output {
            border-left-color: #fb923c;
        }

        .frame-data-item.server-tx {
            border-left-color: #007acc;
        }

        .frame-empty {
            color: #666;
            font-style: italic;
            font-size: 0.75em;
            padding: 8px;
            text-align: center;
        }

        .frame-inactive {
            color: #666;
            font-style: italic;
            font-size: 0.8em;
            padding: 8px 12px;
            text-align: center;
            border-left: 2px solid #555;
        }

        .activity-badge {
            font-size: 0.8em;
            margin-left: 8px;
        }

        .frame-item.has-activity {
            border-left: 2px solid #4ade80;
        }

        .frame-item.no-activity {
            opacity: 0.6;
            border-left: 2px solid #666;
        }

        .panel-header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-add-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #007acc;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .panel-add-btn:hover {
            background: #0086e6;
            transform: scale(1.1);
        }

        .panel-title {
            color: #007acc;
            font-size: 1.1em;
            font-weight: 600;
            margin: 0;
        }

        .panel-close-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #666;
            color: white;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .panel-close-btn:hover {
            background: #888;
            transform: scale(1.1);
        }

        .tab-entity-selector {
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tab-dropdown-label {
            color: #9d9d9d;
            font-size: 0.85em;
            font-weight: 500;
            min-width: 80px;
        }

        /* Responsive Design for Side-by-Side Panels */
        @media (max-width: 1200px) {
            .entity-panel {
                min-width: 350px;
            }
        }

        @media (max-width: 768px) {
            .entity-panel {
                min-width: 300px;
            }
            
            .tab-entity-selector {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .tab-dropdown-label {
                min-width: auto;
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            .entity-panel {
                min-width: 280px;
                padding: 16px;
            }
        }

        .admin-btn {
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 6px;
            padding: 8px 10px;
            color: #d4d4d4;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
        }

        .admin-btn:hover {
            background: #404040;
            border-color: #007acc;
            color: #007acc;
        }

        #dropdownModeBtn {
            position: relative;
        }

        #dropdownModeBtn:after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            background: #007acc;
            border-radius: 50%;
        }

        /* Entity Profile Section */
        .entity-profile-section {
            background: #1e1e1e;
            border: 1px solid #3e3e3e;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            min-height: 80px;
        }

        .entity-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .profile-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #007acc;
            box-shadow: 0 2px 8px rgba(0, 122, 204, 0.3);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .profile-details {
            font-size: 0.85em;
            color: #cccccc;
            line-height: 1.4;
        }

        .profile-role {
            display: inline-block;
            background: #007acc;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            margin-right: 8px;
        }

        .profile-board {
            margin-top: 12px;
        }

        .board-title {
            margin-bottom: 8px;
            color: #cccccc;
            font-size: 0.85em;
        }

        .board-members-list {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
            margin-top: 8px;
        }

        .board-member-row {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            min-height: 24px;
            font-size: 0.8em;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
        }

        .board-member-row:hover {
            background: #3e3e3e;
        }

        .board-member-row.current-signer {
            background: #2d4a6b;
            border: 1px solid #007acc;
        }

        .mini-avatar {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1px solid #666;
        }

        .validator-name {
            flex: 1;
            color: #ffffff;
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .validator-weight {
            background: #007acc;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
            font-weight: bold;
            min-width: 16px;
            text-align: center;
        }

        .mini-badge {
            font-size: 0.8em;
        }

        /* Banking-style transaction list */
        .banking-transactions {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .banking-transaction-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #2d2d2d;
            border-radius: 6px;
            min-height: 48px;
            border-left: 3px solid #007acc;
            transition: background 0.2s;
        }

        .banking-transaction-item:hover {
            background: #353535;
        }

        .banking-transaction-item.banking-input {
            border-left-color: #4ade80;
        }

        .banking-transaction-item.banking-output {
            border-left-color: #fb923c;
        }

        .banking-transaction-item.banking-import {
            border-left-color: #8b5cf6;
            background: #2a2540;
        }

        .transaction-icon {
            font-size: 1.2em;
            margin-right: 12px;
            min-width: 24px;
            text-align: center;
        }

        .transaction-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .transaction-primary {
            font-weight: 600;
            color: #ffffff;
            font-size: 0.9em;
        }

        .transaction-secondary {
            color: #cccccc;
            font-size: 0.8em;
            line-height: 1.3;
        }

        .transaction-amount {
            color: #007acc;
            font-size: 0.8em;
            font-weight: 500;
            text-align: right;
            min-width: 60px;
        }

        /* Banking-style History I/O Section */
        .history-io-section {
            background: #2d2d2d;
            border: 1px solid #3e3e3e;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .history-header {
            background: #252526;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e3e;
        }

        .history-header h3 {
            margin: 0;
            color: #d4d4d4;
            font-size: 1em;
            font-weight: 500;
        }

        .collapse-btn {
            background: none;
            border: none;
            color: #9d9d9d;
            cursor: pointer;
            font-size: 0.9em;
            transition: transform 0.2s ease;
        }

        .collapse-btn:hover {
            color: #007acc;
        }

        .collapse-btn.collapsed {
            transform: rotate(-90deg);
        }

        .history-content {
            display: block;
            transition: all 0.3s ease;
        }

        .history-content.collapsed {
            display: none;
        }

        .server-io-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            margin: 0;
        }

        /* Unified Hierarchical Dropdown */
        .unified-dropdown {
            position: relative;
            display: inline-block;
        }

        .unified-dropdown-btn {
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 6px;
            color: #d4d4d4;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 300px;
            transition: all 0.2s ease;
        }

        .unified-dropdown-btn:hover {
            background: #404040;
            border-color: #007acc;
        }

        .dropdown-icon {
            font-size: 16px;
        }

        .dropdown-text {
            flex: 1;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-arrow {
            transition: transform 0.2s ease;
            color: #9d9d9d;
        }

        .unified-dropdown-btn.open .dropdown-arrow,
        .unified-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .unified-dropdown-content {
            display: none;
            position: absolute;
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 350px;
            max-height: 300px;
            overflow-y: auto;
            top: 100%;
            left: 0;
            margin-top: 4px;
        }
        
        /* Dark theme scrollbar */
        .unified-dropdown-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .unified-dropdown-content::-webkit-scrollbar-track {
            background: #1e1e1e;
            border-radius: 4px;
        }
        
        .unified-dropdown-content::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        
        .unified-dropdown-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .unified-dropdown-content.show {
            display: block;
        }

        .unified-dropdown.open .unified-dropdown-content {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #3e3e3e;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-item:hover {
            background: #404040;
        }

        .dropdown-item img {
            width: 20px;
            height: 20px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .dropdown-item .entity-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-search-container {
            padding: 8px;
            border-bottom: 2px solid #555;
            background: #252525;
        }

        .dropdown-search-input {
            width: 100%;
            padding: 6px 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
            outline: none;
        }

        .dropdown-search-input:focus {
            border-color: #007acc;
            background: #1e1e1e;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item.header {
            background: #252526;
            color: #007acc;
            font-weight: 500;
            cursor: default;
            font-size: 13px;
            padding: 8px 16px;
        }

        .dropdown-item.header:hover {
            background: #252526;
        }

        .dropdown-item.indent-1 {
            padding-left: 24px;
        }

        .dropdown-item.indent-2 {
            padding-left: 36px;
        }

        .dropdown-item .item-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
        }

        .dropdown-item .item-text {
            flex: 1;
            color: #d4d4d4;
        }

        .dropdown-item.selected {
            background: #007acc;
            color: #ffffff;
        }

        .dropdown-item.selected .item-text {
            color: #ffffff;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: -0.5px;
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            font-family: monospace;
            backdrop-filter: blur(10px);
        }

        .entity-filter {
            background: rgba(255,255,255,0.9);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .entity-filter label {
            font-weight: bold;
            color: #2c3e50;
        }

        .entity-filter select {
            padding: 5px 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .entity-filter select:focus {
            outline: none;
            border-color: #3498db;
        }

        .entity-formation-section {
            background: rgba(255,255,255,0.95);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .entity-formation-section h3 {
            margin: 0 0 15px 0;
            color: #28a745;
            font-size: 1.2em;
        }

        .formation-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .formation-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .formation-group label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .formation-group input, .formation-group select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .formation-group input:focus, .formation-group select:focus {
            outline: none;
            border-color: #28a745;
        }

        .formation-group input::placeholder {
            color: #999;
        }

        .simple-formation-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Jurisdictions Tab Styles */
        .jurisdictions-panel {
            padding: 20px;
        }

        .jurisdiction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .jurisdiction-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .jurisdiction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .jurisdiction-header h4 {
            margin: 0;
            color: #2c3e50;
        }

        .connection-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status.checking {
            background: #fff3cd;
            color: #856404;
        }

        .jurisdiction-details {
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f1f3f4;
            font-size: 13px;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row span:first-child {
            font-weight: 500;
            color: #495057;
        }

        .detail-row span:last-child {
            color: #6c757d;
            text-align: right;
        }

        .entities-section {
            margin-top: 15px;
        }

        .entities-section h5 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }

        .entities-list {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            min-height: 60px;
            font-size: 12px;
            font-family: monospace;
        }

        .entity-item {
            padding: 4px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .entity-item:last-child {
            border-bottom: none;
        }

        .jurisdiction-actions {
            text-align: center;
            padding: 20px;
            border-top: 1px solid #dee2e6;
        }

        .jurisdiction-actions .btn {
            margin: 0 10px;
        }

        .validators-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .validators-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .validator-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .validator-name {
            flex: 2;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .validator-weight {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .validator-selector-container {
            flex: 2;
            position: relative;
        }

        .validator-selector {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            min-height: 40px;
            transition: border-color 0.2s;
        }

        .validator-selector:hover {
            border-color: #007bff;
        }

        .validator-selector.open {
            border-color: #007bff;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .validator-display {
            flex: 1;
            color: #333;
        }

        .validator-avatar {
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .dropdown-arrow {
            color: #666;
            font-size: 12px;
            margin-left: 8px;
            transition: transform 0.2s;
        }

        .validator-selector.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .validator-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #007bff;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .validator-search {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .validator-search input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
        }

        .validator-search input:focus {
            border-color: #007bff;
        }

        .validator-options {
            max-height: 150px;
            overflow-y: auto;
        }

        .validator-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: background-color 0.2s;
        }

        .validator-option:hover {
            background-color: #f8f9fa;
        }

        .validator-option:last-child {
            border-bottom: none;
        }

        .validator-option img {
            width: 20px;
            height: 20px;
            border-radius: 10px;
            margin-right: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .validator-option .signer-name {
            font-size: 13px;
            color: #333;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
            min-width: auto;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .threshold-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .threshold-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #495057;
        }

        #thresholdSlider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            margin-bottom: 10px;
        }

        #thresholdSlider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #28a745;
            cursor: pointer;
        }

        #thresholdSlider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #28a745;
            cursor: pointer;
            border: none;
        }

        .threshold-info {
            color: #6c757d;
            font-size: 14px;
        }

        #thresholdValue {
            font-weight: bold;
            color: #28a745;
        }

        #totalWeight {
            font-weight: bold;
            color: #007bff;
        }

        .entities-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
            margin-bottom: 30px;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
        }





        .entity-card {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid #3e3e3e;
            transition: all 0.2s ease;
            width: 100%;
            cursor: pointer;
            margin-bottom: 8px;
            user-select: none;
        }

        .entity-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            border-color: #007acc;
            background: #333333;
        }

        .entity-card.expanded {
            border-color: #007acc;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        .entity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .entity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expand-indicator {
            color: #9d9d9d;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }

        .entity-card:hover .expand-indicator {
            color: #007acc;
        }

        .expand-icon {
            transition: transform 0.2s ease;
        }

        .entity-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .entity-details {
            border-top: 1px solid #404040;
            padding-top: 16px;
            margin-top: 16px;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .entity-details > div {
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .entity-identity {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .jurisdiction-info {
            background: #1e3a5f;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #007acc;
        }

        .replica-stats {
            background: #2a2a2a;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .messages-section, .proposals-section {
            background: #252526;
            padding: 8px;
            border-radius: 4px;
            color: #d4d4d4;
        }

        .message {
            padding: 4px 8px;
            margin: 4px 0;
            background: #2d2d2d;
            border-radius: 3px;
            font-size: 0.8em;
            color: #d4d4d4;
            border-left: 2px solid #007acc;
        }

        .proposal {
            padding: 6px;
            margin: 4px 0;
            background: #3d1a5c;
            border-radius: 3px;
            border-left: 3px solid #bb86fc;
            color: #d4d4d4;
        }

        .entity-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .entity-mode {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 500;
            background: #404040;
            color: #d4d4d4;
            border: 1px solid #555555;
        }

        .mode-proposer-based {
            background: #1e3a5f;
            color: #5DADE2;
            border-color: #007acc;
        }

        .mode-gossip-based {
            background: #3d1a5c;
            color: #bb86fc;
            border-color: #7c3aed;
        }

        .entity-metrics {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #404040;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .metric-value {
            font-size: 0.95em;
            font-weight: 600;
            color: #ffffff;
        }

        .metric-label {
            font-size: 0.72em;
            color: #9d9d9d;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 500;
        }

        .replica-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .replica-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9em;
        }

        .replica-card.proposer {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .replica-card.validator {
            border-color: #28a745;
            background: #e8f5e9;
        }

        .replica-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .replica-stats {
            font-size: 0.8em;
            color: #666;
            line-height: 1.3;
        }

        .proposal-status {
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            display: inline-block;
        }

        .proposal-pending {
            background: #fff3cd;
            color: #856404;
        }

        .proposal-active {
            background: #d4edda;
            color: #155724;
        }

        .messages-section {
            margin-top: 15px;
            max-height: 280px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 0.85em;
        }

        .messages-section::-webkit-scrollbar {
            width: 6px;
        }

        .messages-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .messages-section::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .messages-section::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .message {
            margin: 5px 0;
            padding: 8px;
            font-size: 0.85em;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #fff;
            line-height: 1.4;
        }

        .message:last-child {
            margin-bottom: 0;
        }

        .message strong {
            color: #495057;
        }

        .message.collective {
            background: #e3f2fd;
            padding: 5px;
            border-radius: 5px;
            font-weight: bold;
            color: #1565c0;
        }

        .controls {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
            margin-top: 15px;
            backdrop-filter: blur(10px);
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }

        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            margin-left: auto; /* Pushes the button to the right */
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .reload-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 9999;
            pointer-events: none;
        }

        .reload-indicator.show {
            opacity: 1;
        }

        .debug-info {
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.8em;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .threshold-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 8px;
            margin-top: 10px;
            font-size: 0.85em;
        }

        .voting-power {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }

        .power-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .power-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        .time-machine {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 15, 0.96);
            backdrop-filter: blur(20px);
            padding: 12px 20px;
            border-top: 1px solid #007bff;
            z-index: 1000;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.4);
        }

        .time-machine-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 15px;
        }

        .time-info-compact {
            display: flex;
            align-items: center;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75em;
            color: #aaa;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .time-info-compact.current {
            color: #00ff88;
            font-weight: bold;
        }

        .time-nav-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .time-utility-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .time-btn-compact {
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            transition: all 0.15s ease;
            min-width: 28px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-btn-compact:hover {
            background: #007bff;
            border-color: #007bff;
            transform: translateY(-1px);
        }

        .time-btn-compact.primary {
            background: #007bff;
            border-color: #007bff;
        }

        .time-btn-compact.live {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
            font-weight: bold;
            padding: 4px 10px;
            min-width: 45px;
        }

        .time-btn-compact.live:hover {
            background: #00cc6a;
            border-color: #00cc6a;
        }

        .time-btn-mini {
            background: #333;
            color: #aaa;
            border: 1px solid #555;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7em;
            transition: all 0.15s ease;
            min-width: 22px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-btn-mini:hover {
            background: #555;
            color: white;
        }

        .time-btn-mini.warning {
            background: #ffc107;
            color: #212529;
            border-color: #ffc107;
        }

        .time-btn-mini.warning:hover {
            background: #e0a800;
            border-color: #e0a800;
        }

        .time-slider-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            --progress: 0%;
        }

        .time-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(90deg, 
                #007acc 0%, 
                #00ff88 var(--progress), 
                #404040 var(--progress), 
                #555 100%);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
            transition: background 0.1s ease;
        }

        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007acc, #005a9a);
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,122,204,0.4);
            transition: all 0.2s ease;
        }

        .time-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,122,204,0.6);
        }

        .time-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007acc, #005a9a);
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 4px rgba(0,122,204,0.4);
        }

        .server-input-section {
            background: rgba(255,255,255,0.95);
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85em;
        }

        .server-io-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .server-column {
            background: #2d2d2d;
            border: 2px solid #007acc;
            border-radius: 8px;
            padding: 15px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 0.85em;
            color: #d4d4d4;
        }

        .server-column-header {
            font-weight: bold;
            color: #007acc;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .server-section {
            margin-bottom: 20px;
        }

        .server-section:last-child {
            margin-bottom: 0;
        }

        .server-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 0.9em;
            font-weight: bold;
        }

        .input-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .input-item:last-child {
            margin-bottom: 0;
        }

        .server-input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .server-input-title {
            font-weight: bold;
            color: #007bff;
        }

        .server-input-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .input-group {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
        }

        .input-group h4 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 0.85em;
        }

        .input-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 5px 8px;
            margin: 3px 0;
            font-size: 0.8em;
        }

        .no-inputs {
            color: #6c757d;
            font-style: italic;
        }



        body {
            padding-bottom: 70px; /* Make room for compact time machine */
        }

        /* Tab Styles */
        .actionable-tabs-container {
            background: #2d2d2d;
            border: 2px solid #007acc;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            background: #252526;
            border-bottom: 1px solid #3e3e3e;
        }

        .tab-button {
            flex: 1;
            background: transparent;
            border: none;
            padding: 15px 20px;
            font-size: 0.95em;
            font-weight: 500;
            color: #9d9d9d;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-button:hover {
            background: rgba(0, 122, 204, 0.15);
            color: #007acc;
        }

        .tab-button.active {
            background: #2d2d2d;
            color: #007acc;
            border-bottom: 2px solid #007acc;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
            background: #2d2d2d;
            color: #d4d4d4;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .entity-filter .actions {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }
        
        /* Settings Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--text-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background-color: var(--hover-color);
            border-radius: 50%;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .setting-group {
            margin-bottom: 25px;
        }
        
        .setting-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 14px;
        }
        
        .setting-group small {
            color: var(--text-muted);
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 10px 0;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #007acc;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        /* Slider */
        .slider-container {
            margin: 10px 0;
        }
        
        .slider-container input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007acc;
            cursor: pointer;
        }
        
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007acc;
            cursor: pointer;
            border: none;
        }
        
        .slider-value {
            text-align: center;
            margin-top: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        /* Proposal Status Styles */
        .proposal-item.failed {
            opacity: 0.7;
            border-left: 3px solid #dc3545;
        }
        
        .failed-badge {
            background: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .vote-entry {
            margin-bottom: 4px;
        }
        
        .vote-comment {
            font-style: italic;
            color: var(--text-muted);
            margin-left: 16px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="reload-indicator" id="reloadIndicator" style="display: none;">
        🔄 Reloading...
    </div>
    
    <div class="container">
        <!-- Admin Top Bar -->
        <div class="admin-topbar">
            <div class="admin-logo">
                <span class="logo-text">xln</span>
            </div>
            
            <div class="admin-navigation">
                <!-- Removed unified dropdown - moved to individual tabs -->
            </div>
            
            <div class="admin-controls">
                <button class="admin-btn" onclick="runDemoAndRefresh()" title="Run Demo">
                    <span>▶️</span>
                </button>
                <button class="admin-btn" onclick="XLN.clearDatabase()" title="Clear Database">
                    <span>🗑️</span>
                </button>
                <button class="admin-btn" onclick="showEntityCreator()" title="Create New Entity">
                    <span>➕</span>
                </button>
                <button class="admin-btn theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <span id="theme-icon">🌙</span>
                </button>
                <button class="admin-btn" onclick="showSettings()" title="Settings">
                    <span>⚙️</span>
                </button>
                <button class="admin-btn" onclick="toggleDropdownMode()" title="Toggle Dropdown Mode" id="dropdownModeBtn">
                    <span>🔄</span>
                </button>
            </div>
        </div>





        <!-- Split View Entity Panels -->

        <!-- Entity Panels Container -->
        <div class="entity-panels-container" id="entityPanelsContainer">
            <!-- Entity panels will be populated here -->
        </div>
        
        <!-- Hidden: Original entities grid (for reference) -->
        <div class="entities-grid" id="entitiesGrid" style="display: none;">
            <!-- Entity cards will be populated here -->
        </div>

        <!-- History I/O Area (Banking App Style) -->
        <div class="history-io-section" id="historyIOSection">
            <div class="history-header">
                <h3>📊 Transaction History & I/O</h3>
                <button class="collapse-btn" onclick="toggleHistoryIO()" id="historyToggle">▼</button>
            </div>
            <div class="history-content" id="historyContent">
                <div class="server-io-container" id="serverIOContainer">
            <div class="server-column">
                <div class="server-column-header">
                    📨 Server Input (What's happening this tick)
                            <span id="serverInputStatus" style="font-weight: normal; color: #9d9d9d; font-size: 0.85em;"></span>
                </div>
                
                <div class="server-section">
                    <h4>🖥️ Server Transactions</h4>
                    <div id="serverTxsList"></div>
                </div>
                
                <div class="server-section">
                    <h4>🔄 Entity Inputs</h4>
                    <div id="entityInputsList"></div>
                </div>
            </div>
            
            <div class="server-column">
                <div class="server-column-header">
                    📤 Server Output (What's being sent and where)
                            <span id="serverOutputStatus" style="font-weight: normal; color: #9d9d9d; font-size: 0.85em;"></span>
                </div>
                
                <div class="server-section">
                    <h4>🚀 Entity Outputs</h4>
                    <div id="entityOutputsList"></div>
                </div>
            </div>
        </div>
            </div>
        </div>

        <div class="actionable-tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" onclick="switchTab('formation')" id="formationTab">
                    🏗️ Entity Formation
                </button>
                <button class="tab-button" onclick="switchTab('jurisdictions')" id="jurisdictionsTab">
                    🏛️ Jurisdictions
                </button>
            </div>
            
            <div id="formationTabContent" class="tab-content active">
                <div class="simple-formation-panel">
                    <div class="formation-group">
                        <label for="jurisdictionSelect">🏛️ Jurisdiction:</label>
                        <select id="jurisdictionSelect" onchange="onJurisdictionChange()">
                            <option value="8545" selected>Ethereum Mainnet (Port 8545)</option>
                            <option value="8546">Polygon Network (Port 8546)</option>
                            <option value="8547">Arbitrum One (Port 8547)</option>
                        </select>
                        <div class="jurisdiction-info" id="jurisdictionInfo" style="display: block; padding: 10px; background: #e8f5e8; border-left: 4px solid #4caf50; margin: 10px 0; border-radius: 4px;">
                            <small><strong>📡 Network:</strong> <span id="networkName">Ethereum Mainnet</span><br>
                            <strong>🔗 RPC Port:</strong> <span id="rpcPort">8545</span><br>
                            <strong>📝 Contract:</strong> <span id="contractAddress">Loading...</span></small>
                        </div>
                    </div>

                    <div class="formation-group">
                        <label for="entityTypeSelect">🆔 Entity Type:</label>
                        <select id="entityTypeSelect" onchange="onEntityTypeChange()">
                            <option value="lazy">🔒 Lazy Entity (Free - ID = Quorum Hash)</option>
                            <option value="numbered">🔢 Numbered Entity (Gas Required - Sequential ID)</option>
                            <option value="named">🏷️ Named Entity (Premium Gas + Admin Approval)</option>
                        </select>
                        <div class="entity-type-info" id="entityTypeInfo">
                            <small class="text-muted">
                                <strong>🔒 Lazy:</strong> Free to create, entityId = hash(validators), works immediately.<br>
                                <strong>🔢 Numbered:</strong> Small gas cost, get sequential number like #42, on-chain registered.<br>
                                <strong>🏷️ Named:</strong> Premium gas + admin approval, get custom name like "coinbase".
                            </small>
                        </div>
                        <div class="next-number-info" id="nextNumberInfo" style="display: none; padding: 10px; background: #e8f5e8; border-left: 4px solid #4caf50; margin: 10px 0; border-radius: 4px;">
                            <small><strong>🔢 Next Available Number:</strong> <span id="nextNumberDisplay">Loading...</span></small>
                        </div>
                    </div>
                    
                    <div class="formation-group">
                        <label for="entityNameInput">🏷️ Entity Name:</label>
                        <input type="text" id="entityNameInput" placeholder="e.g., trading, chat, governance" value="ACME" oninput="updateExpectedEntityId()">
                        <small class="text-muted" id="entityNameHint">
                            Display name for your entity (not used for ID generation in lazy mode)
                        </small>
                    </div>
                    
                    <div class="validators-section">
                        <h4>👥 Validators:</h4>
                        <div id="validatorsList">
                            <div class="validator-row" data-validator-id="0">
                                <div class="validator-selector-container">
                                    <div class="validator-selector" onclick="openValidatorDropdown(0)">
                                        <img class="validator-avatar" src="" alt="" style="width: 24px; height: 24px; border-radius: 12px; margin-right: 8px; display: none;">
                                        <span class="validator-display">Select signer...</span>
                                        <span class="dropdown-arrow">▼</span>
                            </div>
                                    <div class="validator-dropdown" id="validatorDropdown0" style="display: none;">
                                        <div class="validator-search">
                                            <input type="text" placeholder="Search signers..." oninput="searchValidators(0, this.value)" onclick="event.stopPropagation()">
                            </div>
                                        <div class="validator-options" id="validatorOptions0">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                </div>
                                <input type="number" class="validator-weight" placeholder="1" value="1" min="1" oninput="updateTotalWeight(); updateExpectedEntityId()">
                                <button class="btn btn-danger btn-small" onclick="removeValidator(this)" style="visibility: hidden;">❌</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="addValidatorRow()">➕ Add New Validator</button>
                        <small class="text-muted" style="display: block; margin-top: 8px;">
                            💡 Start with a single signer for personal use, or add more for multisig/corporate entities
                        </small>
                    </div>
                    
                    <div class="threshold-section">
                        <label for="thresholdSlider">🎯 Threshold: <span id="thresholdValue">1</span></label>
                        <input type="range" id="thresholdSlider" min="1" max="2" value="1" oninput="updateThreshold()">
                        <div class="threshold-info">
                            <span>Total Weight: <span id="totalWeight">1</span></span>
                        </div>
                    </div>
                    
                    <!-- Quorum Hash Display - Right below threshold -->
                    <div class="quorum-hash-section" style="padding: 12px; background: #e9ecef; border: 2px solid #6c757d; border-radius: 8px; margin: 10px 0;">
                        <label style="font-weight: bold; color: #495057;">🔒 Quorum Hash:</label>
                        <div id="quorumHash" style="font-family: monospace; font-size: 12px; padding: 6px; background: white; border: 1px solid #ced4da; border-radius: 4px; color: #495057; word-break: break-all; margin-top: 5px;">
                            Configure validators and threshold to see quorum hash
                        </div>
                        <small class="text-muted" style="display: block; margin-top: 3px; font-size: 11px;">
                            Hash of validator configuration (used as entity ID for lazy entities)
                        </small>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="createSimpleEntity()">🚀 Create Entity</button>
                        <button class="btn btn-secondary" onclick="clearSimpleForm()">🗑️ Clear Form</button>
                    </div>
                    
                    <!-- Expected Entity ID Display - Below buttons -->
                    <div class="expected-id-section" style="padding: 12px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; margin: 10px 0;">
                        <label style="font-weight: bold; color: #495057;">🆔 Expected Entity ID:</label>
                        <div id="expectedEntityId" style="font-family: monospace; font-size: 12px; padding: 6px; background: white; border: 1px solid #ced4da; border-radius: 4px; color: #495057; margin-top: 5px;">
                            Click to preview entity ID
                        </div>
                        <small class="text-muted" style="display: block; margin-top: 3px; font-size: 11px;">
                            Preview updates automatically as you change settings
                        </small>
                </div>
            </div>
        </div>

            <!-- Jurisdictions Tab Content -->
            <div id="jurisdictionsTabContent" class="tab-content">
                <div class="jurisdictions-panel">
                    <h3>🏛️ Blockchain Jurisdictions Status</h3>
                    <div class="jurisdiction-grid">
                        <!-- Ethereum Mainnet -->
                        <div class="jurisdiction-card" id="jurisdiction-8545">
                            <div class="jurisdiction-header">
                                <h4>🔷 Ethereum Mainnet</h4>
                                <span class="connection-status" id="status-8545">🔄 Checking...</span>
                            </div>
                            <div class="jurisdiction-details">
                                <div class="detail-row">
                                    <span>📡 RPC Port:</span>
                                    <span>8545</span>
                                </div>
                                <div class="detail-row">
                                    <span>🔗 Chain ID:</span>
                                    <span id="chainId-8545">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>📊 Block Number:</span>
                                    <span id="blockNumber-8545">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>⏰ Last Update:</span>
                                    <span id="lastUpdate-8545">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>📝 Contract:</span>
                                    <span id="contract-8545" style="font-family: monospace; font-size: 11px;">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>🔢 Next Entity #:</span>
                                    <span id="nextNumber-8545">-</span>
                                </div>
                            </div>
                            <div class="entities-section">
                                <h5>📋 Registered Entities:</h5>
                                <div id="entities-8545" class="entities-list">Loading...</div>
                            </div>
                        </div>
                        
                        <!-- Polygon Network -->
                        <div class="jurisdiction-card" id="jurisdiction-8546">
                            <div class="jurisdiction-header">
                                <h4>🟣 Polygon Network</h4>
                                <span class="connection-status" id="status-8546">🔄 Checking...</span>
                            </div>
                            <div class="jurisdiction-details">
                                <div class="detail-row">
                                    <span>📡 RPC Port:</span>
                                    <span>8546</span>
                                </div>
                                <div class="detail-row">
                                    <span>🔗 Chain ID:</span>
                                    <span id="chainId-8546">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>📊 Block Number:</span>
                                    <span id="blockNumber-8546">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>⏰ Last Update:</span>
                                    <span id="lastUpdate-8546">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>📝 Contract:</span>
                                    <span id="contract-8546" style="font-family: monospace; font-size: 11px;">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>🔢 Next Entity #:</span>
                                    <span id="nextNumber-8546">-</span>
                                </div>
                            </div>
                            <div class="entities-section">
                                <h5>📋 Registered Entities:</h5>
                                <div id="entities-8546" class="entities-list">Loading...</div>
                            </div>
                        </div>
                        
                        <!-- Arbitrum One -->
                        <div class="jurisdiction-card" id="jurisdiction-8547">
                            <div class="jurisdiction-header">
                                <h4>🔵 Arbitrum One</h4>
                                <span class="connection-status" id="status-8547">🔄 Checking...</span>
                            </div>
                            <div class="jurisdiction-details">
                                <div class="detail-row">
                                    <span>📡 RPC Port:</span>
                                    <span>8547</span>
                                </div>
                                <div class="detail-row">
                                    <span>🔗 Chain ID:</span>
                                    <span id="chainId-8547">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>📊 Block Number:</span>
                                    <span id="blockNumber-8547">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>⏰ Last Update:</span>
                                    <span id="lastUpdate-8547">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>📝 Contract:</span>
                                    <span id="contract-8547" style="font-family: monospace; font-size: 11px;">-</span>
                                </div>
                                <div class="detail-row">
                                    <span>🔢 Next Entity #:</span>
                                    <span id="nextNumber-8547">-</span>
                                </div>
                            </div>
                            <div class="entities-section">
                                <h5>📋 Registered Entities:</h5>
                                <div id="entities-8547" class="entities-list">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="jurisdiction-actions">
                        <button class="btn btn-primary" onclick="refreshAllJurisdictions()">🔄 Refresh All</button>
                        <button class="btn btn-secondary" onclick="deployContracts()">🚀 Deploy Contracts</button>
                    </div>
                </div>
            </div>
        </div>



    </div>

    <!-- Fixed Time Machine Bar -->
    <div class="time-machine">
        <div class="time-machine-main">
            <div class="time-info-compact" id="timeInfo">
                <span>⏰ No history yet</span>
                <span></span>
                <span></span>
            </div>
            <div class="time-nav-controls">
                <button class="time-btn-compact" onclick="stepBackward()" title="Step Back (← arrow)">⏪</button>
                <button class="time-btn-compact" onclick="stepForward()" title="Step Forward (→ arrow)">⏩</button>
                <button class="time-btn-compact live" onclick="goToHistoryEnd()" title="Go to Current (End key)">⚡ LIVE</button>
            </div>
            <div class="time-utility-controls">
                <button class="time-btn-mini" onclick="goToHistoryStart()" title="Go to Start (Home key)">⏮️</button>
            </div>
        </div>
        <div class="time-slider-container">
            <input type="range" id="timeSlider" class="time-slider" min="0" max="0" value="0" disabled>
        </div>
    </div>

    <script type="module">
        import * as XLN from './dist/server.js';
        
        // Use server.js functions directly - no legacy compatibility layer needed

        // Global state
        let xlnEnv = null;
        let lastModified = null;
        let currentTimeIndex = -1; // -1 means current time, >= 0 means historical snapshot
        
        // Make XLN available globally for debugging
        window.xlnEnv = null;
        
        // Initialize server delay from localStorage
        window.serverDelay = parseInt(localStorage.getItem('xln-server-delay') || '0');

        // Tab Management System
        const STORAGE_KEY = 'xln-entity-tabs';
        let tabSystem = {
            tabs: [],
            activeTabId: null,
            nextTabId: 1
        };

        // Initialize tab system
        function initializeTabSystem() {
            loadTabsFromStorage();
            if (tabSystem.tabs.length === 0) {
                // Create 3 default panels for demo
                addTab(); // Panel 1
                addTab(); // Panel 2 
                addTab(); // Panel 3
            }
            renderTabs();
        }

        // Generate unique tab ID
        function generateTabId() {
            return `tab-${tabSystem.nextTabId++}`;
        }

        // Save tabs to localStorage
        function saveTabsToStorage() {
            try {
                const tabData = {
                    tabs: tabSystem.tabs,
                    activeTabId: tabSystem.activeTabId,
                    nextTabId: tabSystem.nextTabId
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(tabData));
                console.log('💾 Tabs saved to localStorage:', tabData);
            } catch (error) {
                console.error('❌ Failed to save tabs:', error);
            }
        }

        // Load tabs from localStorage
        function loadTabsFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const tabData = JSON.parse(saved);
                    tabSystem.tabs = tabData.tabs || [];
                    tabSystem.activeTabId = tabData.activeTabId || null;
                    tabSystem.nextTabId = tabData.nextTabId || 1;
                    console.log('📁 Tabs loaded from localStorage:', tabData);
                }
            } catch (error) {
                console.error('❌ Failed to load tabs:', error);
                // Initialize with empty tab system on error
                tabSystem.tabs = [];
                tabSystem.activeTabId = null;
                tabSystem.nextTabId = 1;
            }
        }

        // Add new tab
        function addTab() {
            const panelNumber = tabSystem.tabs.length + 1;
            
            // Auto-select first available entity for new tabs (always use first entity found)
            let defaultJurisdiction = '';
            let defaultSigner = '';
            let defaultEntityId = '';
            
            if (xlnEnv && xlnEnv.replicas && xlnEnv.replicas.size > 0) {
                const firstReplica = Array.from(xlnEnv.replicas.values())[0];
                if (firstReplica) {
                    defaultJurisdiction = firstReplica.state?.config?.jurisdiction?.name || 'Ethereum';
                    defaultSigner = firstReplica.signerId || 'alice.eth';
                    defaultEntityId = firstReplica.entityId || '';
                }
            }
            
            const newTab = {
                id: generateTabId(),
                title: `Entity Panel ${panelNumber}`,
                jurisdiction: defaultJurisdiction,
                signer: defaultSigner,
                entityId: defaultEntityId,
                isActive: false
            };

            tabSystem.tabs.push(newTab);
            setActiveTab(newTab.id);
            renderTabs();
            saveTabsToStorage();

            console.log('➕ Added new panel:', newTab);
        }

        // Close tab
        function closeTab(tabId) {
            console.log('❌ Closing tab:', tabId);
            
            if (tabSystem.tabs.length <= 1) {
                console.log('⚠️ Cannot close last tab');
                return; // Keep at least one tab
            }

            const tabIndex = tabSystem.tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;

            tabSystem.tabs.splice(tabIndex, 1);

            // If closed tab was active, switch to first remaining tab
            if (tabSystem.activeTabId === tabId) {
                tabSystem.activeTabId = tabSystem.tabs[0].id;
            }

            renderTabs();
            saveTabsToStorage();
        }

        // Set active tab
        function setActiveTab(tabId) {
            console.log('🎯 Setting active tab:', tabId);
            
            // Update tab states
            tabSystem.tabs.forEach(tab => {
                tab.isActive = tab.id === tabId;
            });
            tabSystem.activeTabId = tabId;

            renderTabs();
            saveTabsToStorage();
        }

        // Get active tab
        function getActiveTab() {
            return tabSystem.tabs.find(tab => tab.id === tabSystem.activeTabId);
        }

        // Update tab title and data
        function updateTab(tabId, updates) {
            const tab = tabSystem.tabs.find(t => t.id === tabId);
            if (tab) {
                Object.assign(tab, updates);
                // Update the dropdown text for this specific tab
                updateTabDropdownDisplay(tabId);
                // Refresh the entity display for this tab to show the new signer
                renderEntityInTab(tabId);
                saveTabsToStorage();
            }
        }

        // Update dropdown display for specific tab only
        function updateTabDropdownDisplay(tabId) {
            const tab = tabSystem.tabs.find(t => t.id === tabId);
            if (!tab) return;

            const dropdownText = document.getElementById(`dropdownText-${tabId}`);
            if (dropdownText && tab.jurisdiction && tab.signer && tab.entityId) {
                const entityDisplay = XLN.formatEntityDisplay ? XLN.formatEntityDisplay(tab.entityId) : tab.entityId;
                const signerDisplay = XLN.formatSignerDisplay ? XLN.formatSignerDisplay(tab.signer) : tab.signer;
                dropdownText.textContent = `${tab.jurisdiction} → ${signerDisplay} → ${entityDisplay}`;
            }
        }

        // Render entity panels in grid layout
        function renderTabs() {
            renderEntityPanels();
        }

        // Render all entity panels
        function renderEntityPanels() {
            const container = document.getElementById('entityPanelsContainer');
            if (!container) return;

            container.innerHTML = '';
            
            // Set panel count attribute for responsive CSS
            container.setAttribute('data-panel-count', tabSystem.tabs.length);

            tabSystem.tabs.forEach((tab, index) => {
                const panel = document.createElement('div');
                panel.className = 'entity-panel';
                panel.setAttribute('data-panel-id', tab.id);
                
                const isLastPanel = index === tabSystem.tabs.length - 1;
                const showCloseButton = tabSystem.tabs.length > 1;

                panel.innerHTML = `
                    <div class="panel-header">
                        <div class="unified-dropdown" id="dropdown-${tab.id}">
                            <button class="unified-dropdown-btn" onclick="toggleTabDropdown('${tab.id}')" style="width: 100%;">
                                <span class="dropdown-icon">🏛️</span>
                                <span class="dropdown-text" id="dropdownText-${tab.id}">Select Entity</span>
                                <span class="dropdown-arrow">▼</span>
                            </button>
                            <div class="unified-dropdown-content" id="dropdownContent-${tab.id}">
                                <!-- Tree structure will be populated here -->
                            </div>
                        </div>
                        <div class="panel-header-controls">
                            ${isLastPanel ? '<button class="panel-add-btn" onclick="addTab()" title="Add Entity Panel">➕</button>' : ''}
                            ${showCloseButton ? `<button class="panel-close-btn" onclick="closeTab('${tab.id}')" title="Close panel">×</button>` : ''}
                        </div>
                    </div>
                    
                    <!-- Entity Profile Section -->
                    <div class="entity-profile-section" id="entityProfile-${tab.id}">
                        <div class="empty-state">- select entity to view profile</div>
                    </div>
                    
                    <!-- Consensus State Component -->
                    <div class="panel-component" id="consensus-${tab.id}">
                        <div class="component-header" onclick="toggleComponent('consensus-${tab.id}')">
                            <div class="component-title">
                                <span>⚖️</span>
                                <span>Consensus State</span>
                            </div>
                            <div class="component-toggle">▼</div>
                        </div>
                        <div class="component-content" style="max-height: 200px;">
                            <div class="consensus-state" id="consensusContent-${tab.id}">
                                <div class="empty-state">- select entity to view consensus state</div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Component -->
                    <div class="panel-component" id="chat-${tab.id}">
                        <div class="component-header" onclick="toggleComponent('chat-${tab.id}')">
                            <div class="component-title">
                                <span>💬</span>
                                <span>Chat</span>
                            </div>
                            <div class="component-toggle">▼</div>
                        </div>
                        <div class="component-content" style="max-height: 25vh;">
                            <div class="scrollable-component" id="chatContent-${tab.id}">
                                <div class="empty-state">- no messages</div>
                            </div>
                        </div>
                    </div>

                    <!-- Proposals Component -->
                    <div class="panel-component" id="proposals-${tab.id}">
                        <div class="component-header collapsed" onclick="toggleComponent('proposals-${tab.id}')">
                            <div class="component-title">
                                <span>📋</span>
                                <span>Proposals</span>
                            </div>
                            <div class="component-toggle">▼</div>
                        </div>
                        <div class="component-content collapsed" style="max-height: 25vh;">
                            <div class="scrollable-component" id="proposalsContent-${tab.id}">
                                <div class="empty-state">- no proposals</div>
                            </div>
                        </div>
                    </div>

                    <!-- Entity Frame History (Vertical Panel) -->
                    <div class="panel-component entity-history-panel" id="history-${tab.id}">
                        <div class="component-header collapsed" onclick="toggleComponent('history-${tab.id}')">
                            <div class="component-title">
                                <span>🗂️</span>
                                <span>History</span>
                            </div>
                            <div class="component-toggle">▼</div>
                        </div>
                        <div class="component-content collapsed" style="max-height: 40vh;">
                            <div class="entity-history-container" id="historyContent-${tab.id}">
                                <div class="empty-state">- no frame history</div>
                            </div>
                        </div>
                    </div>

                    <!-- Controls Component -->
                    <div class="panel-component" id="controls-${tab.id}">
                        <div class="component-header collapsed" onclick="toggleComponent('controls-${tab.id}')">
                            <div class="component-title">
                                <span>⚙️</span>
                                <span>Controls</span>
                            </div>
                            <div class="component-toggle">▼</div>
                        </div>
                        <div class="component-content collapsed" style="max-height: 400px;">
                            <div class="controls-section" id="controlsContent-${tab.id}">
                                <select class="controls-dropdown" onchange="updateControlsForm('${tab.id}', this.value)">
                                    <option value="chat" selected>💬 Create chat message</option>
                                    <option value="proposal">📋 Add proposal</option>
                                    <option value="vote">🗳️ Vote on proposal</option>
                                    <option value="entity">🏛️ Form new entity</option>
                                    <option value="jtx">💸 Send J-tx</option>
                                    <option value="settings">⚙️ Update settings</option>
                                </select>
                                <div class="controls-form" id="controlsForm-${tab.id}">
                                    <div class="form-group">
                                        <label class="form-label">Message:</label>
                                        <textarea class="form-textarea" placeholder="Enter your message..."></textarea>
                                    </div>
                                    <button class="form-button" onclick="submitChatMessage('${tab.id}')">Send Message</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // No click behavior needed - panels are just display containers

                container.appendChild(panel);
                
                // Apply component states and auto-render content
                applyComponentStates(tab.id);
                
                // Auto-render entity content if tab has an entity selected
                if (tab.entityId) {
                    renderEntityInTab(tab.id, tab.signer, tab.entityId);
                }
            });
        }

        // Toggle dropdown for specific tab
        function toggleTabDropdown(tabId) {
            console.log('🔽 Toggle dropdown for tab:', tabId);
            const dropdown = document.getElementById(`dropdown-${tabId}`);
            const content = document.getElementById(`dropdownContent-${tabId}`);
            
            if (!dropdown || !content) {
                console.error('❌ Dropdown elements not found:', { dropdown, content });
                return;
            }

            const isOpen = dropdown.classList.contains('open');
            console.log('📊 Dropdown state:', { isOpen, xlnEnv: !!xlnEnv });
            
            // Close all other dropdowns
            document.querySelectorAll('.unified-dropdown').forEach(d => {
                d.classList.remove('open');
            });

            if (!isOpen) {
                dropdown.classList.add('open');
                populateTabDropdown(tabId);
            }
        }

        // Populate dropdown for specific tab
        function populateTabDropdown(tabId) {
            console.log('📝 Populating dropdown for tab:', tabId);
            const content = document.getElementById(`dropdownContent-${tabId}`);
            if (!content) {
                console.error('❌ Content element not found for tab:', tabId);
                return;
            }
            if (!xlnEnv) {
                console.error('❌ xlnEnv not available:', xlnEnv);
                return;
            }
            console.log('✅ xlnEnv available with replicas:', xlnEnv.replicas?.size || 0);

            content.innerHTML = `
                <div class="dropdown-search-container">
                    <input type="text" class="dropdown-search-input" placeholder="🔍 Search jurisdictions, signers, entities..." 
                           oninput="handleTabDropdownSearch('${tabId}', this.value)" 
                           onclick="event.stopPropagation()">
                </div>
                <div class="dropdown-results" id="dropdownResults-${tabId}">
                    <!-- Results will be populated here -->
                </div>
            `;

            updateTabDropdownResults(tabId, '');
        }

        // Handle search in tab dropdown
        function handleTabDropdownSearch(tabId, searchTerm) {
            updateTabDropdownResults(tabId, searchTerm);
        }

        // Update dropdown results for tab
        function updateTabDropdownResults(tabId, searchTerm) {
            const resultsContainer = document.getElementById(`dropdownResults-${tabId}`);
            if (!resultsContainer || !xlnEnv) return;

            resultsContainer.innerHTML = '';

            // Get all available jurisdictions
            const jurisdictions = [
                { name: 'Ethereum', id: 'ethereum' },
                { name: 'Polygon', id: 'polygon' },
                { name: 'Arbitrum', id: 'arbitrum' }
            ];

            if (dropdownMode === 'signer-first') {
                // Original mode: Jurisdiction → Signer → Entity
                renderSignerFirstDropdown(tabId, jurisdictions, resultsContainer, searchTerm);
            } else {
                // New mode: Jurisdiction → Entity → Signers
                renderEntityFirstDropdown(tabId, jurisdictions, resultsContainer, searchTerm);
            }
        }

        // Original dropdown: Jurisdiction → Signer → Entity
        function renderSignerFirstDropdown(tabId, jurisdictions, resultsContainer, searchTerm) {
            jurisdictions.forEach((jurisdiction, jIndex) => {
                // Get replicas for this jurisdiction
                const replicas = Array.from(xlnEnv.replicas.values()).filter(replica => 
                    replica.state?.config?.jurisdiction?.name === jurisdiction.name
                );

                if (replicas.length === 0) return;

                // Group replicas by signer
                const signerGroups = {};
                replicas.forEach(replica => {
                    const signerId = replica.signerId;
                    if (!signerGroups[signerId]) {
                        signerGroups[signerId] = [];
                    }
                    signerGroups[signerId].push(replica);
                });

                // Add jurisdiction header
                const isLastJurisdiction = jIndex === jurisdictions.length - 1;
                const jurisdictionItem = createTabDropdownTreeItem(
                    `🏛️ ${jurisdiction.name}`, 
                    '', 
                    0, 
                    false, 
                    false,
                    searchTerm
                );
                resultsContainer.appendChild(jurisdictionItem);

                // Add signers and their entities
                const signerKeys = Object.keys(signerGroups);
                signerKeys.forEach((signerId, sIndex) => {
                    const signerEntities = signerGroups[signerId];
                    const isLastSigner = sIndex === signerKeys.length - 1;

                    // Add signer
                    const signerItem = createTabDropdownTreeItem(
                        `👤 ${XLN.formatSignerDisplay ? XLN.formatSignerDisplay(signerId) : signerId}`, 
                        '', 
                        1, 
                        false, 
                        isLastSigner && isLastJurisdiction,
                        searchTerm
                    );
                    resultsContainer.appendChild(signerItem);

                    // Add entities for this signer
                    signerEntities.forEach((replica, eIndex) => {
                        const isLastEntity = eIndex === signerEntities.length - 1;
                        const entityDisplay = XLN.formatEntityDisplay ? XLN.formatEntityDisplay(replica.entityId) : replica.entityId;
                        
                        const entityItem = createTabDropdownTreeItem(
                            `🏢 ${entityDisplay}`, 
                            `${jurisdiction.name}:${signerId}:${replica.entityId}`, 
                            2, 
                            true, 
                            isLastEntity && isLastSigner && isLastJurisdiction,
                            searchTerm
                        );
                        
                        entityItem.onclick = () => selectTabEntity(tabId, jurisdiction.name, signerId, replica.entityId);
                        resultsContainer.appendChild(entityItem);
                    });
                });
            });
        }

        // New dropdown: Jurisdiction → Entity → Signers  
        function renderEntityFirstDropdown(tabId, jurisdictions, resultsContainer, searchTerm) {
            jurisdictions.forEach((jurisdiction, jIndex) => {
                // Get replicas for this jurisdiction
                const replicas = Array.from(xlnEnv.replicas.values()).filter(replica => 
                    replica.state?.config?.jurisdiction?.name === jurisdiction.name
                );

                if (replicas.length === 0) return;

                // Group replicas by entity
                const entityGroups = {};
                replicas.forEach(replica => {
                    const entityId = replica.entityId;
                    if (!entityGroups[entityId]) {
                        entityGroups[entityId] = [];
                    }
                    entityGroups[entityId].push(replica);
                });

                // Add jurisdiction header
                const isLastJurisdiction = jIndex === jurisdictions.length - 1;
                const jurisdictionItem = createTabDropdownTreeItem(
                    `🏛️ ${jurisdiction.name}`, 
                    '', 
                    0, 
                    false, 
                    false,
                    searchTerm
                );
                resultsContainer.appendChild(jurisdictionItem);

                // Add entities and their signers
                const entityKeys = Object.keys(entityGroups);
                entityKeys.forEach((entityId, eIndex) => {
                    const entitySigners = entityGroups[entityId];
                    const isLastEntity = eIndex === entityKeys.length - 1;
                    const entityDisplay = XLN.formatEntityDisplay ? XLN.formatEntityDisplay(entityId) : entityId;

                    // Add entity
                    const entityItem = createTabDropdownTreeItem(
                        `🏢 ${entityDisplay} (${entitySigners.length} signers)`, 
                        '', 
                        1, 
                        false, 
                        isLastEntity && isLastJurisdiction,
                        searchTerm
                    );
                    resultsContainer.appendChild(entityItem);

                    // Add signers for this entity
                    entitySigners.forEach((replica, sIndex) => {
                        const isLastSigner = sIndex === entitySigners.length - 1;
                        
                        const signerItem = createTabDropdownTreeItem(
                            `👤 ${XLN.formatSignerDisplay ? XLN.formatSignerDisplay(replica.signerId) : replica.signerId}`, 
                            `${jurisdiction.name}:${replica.signerId}:${replica.entityId}`, 
                            2, 
                            true, 
                            isLastSigner && isLastEntity && isLastJurisdiction,
                            searchTerm
                        );
                        
                        signerItem.onclick = () => selectTabEntity(tabId, jurisdiction.name, replica.signerId, replica.entityId);
                        resultsContainer.appendChild(signerItem);
                    });
                });
            });
        }

        // Create tree-structured dropdown item with ASCII art
        function createTabDropdownTreeItem(text, value, level, isSelectable, isLast, searchTerm) {
            const item = document.createElement('div');
            item.className = `dropdown-item ${level > 0 ? `indent-${level}` : ''}`;
            
            // Create ASCII tree structure
            let prefix = '';
            if (level === 1) {
                prefix = '├─ ';
            } else if (level === 2) {
                prefix = '│  └─ ';
            }
            
            item.innerHTML = `
                <span class="tree-prefix" style="color: #666; font-family: monospace;">${prefix}</span>
                <span class="item-text">${text}</span>
            `;
            
            if (isSelectable) {
                item.style.cursor = 'pointer';
                item.dataset.value = value;
            } else {
                item.style.cursor = 'default';
                item.style.color = '#9d9d9d';
            }

            // Apply search highlighting if needed
            if (searchTerm && text.toLowerCase().includes(searchTerm.toLowerCase())) {
                highlightSearchTerm(item, searchTerm);
            }
            
            return item;
        }

        // Select entity in specific tab (wrapper for dropdown selection)
        function selectTabEntity(tabId, jurisdiction, signerId, entityId) {
            selectEntityInTab(tabId, jurisdiction, signerId, entityId);
        }

        // Select entity in specific tab
        function selectEntityInTab(tabId, jurisdiction, signerId, entityId) {
            console.log(`🎯 Selecting entity in tab ${tabId}:`, { jurisdiction, signerId, entityId });

            // Ensure jurisdiction is a string (it might be an object)
            const jurisdictionName = typeof jurisdiction === 'string' ? jurisdiction : jurisdiction?.name || 'Unknown';

            // Update tab data
            const entityDisplay = XLN.formatEntityDisplay ? XLN.formatEntityDisplay(entityId) : entityId;
            updateTab(tabId, {
                title: `Entity ${entityDisplay}`,
                jurisdiction: jurisdictionName,
                signer: signerId,
                entityId: entityId
            });

            // Dropdown text will be updated by updateTab -> updateTabDropdownDisplay

            // Close dropdown
            const dropdown = document.getElementById(`dropdown-${tabId}`);
            if (dropdown) {
                dropdown.classList.remove('open');
            }

            // Render entity profile for this tab
            renderEntityInTab(tabId, signerId, entityId);
        }

        // Render entity profile in specific tab
        function renderEntityInTab(tabId, signerId, entityId) {
            if (!xlnEnv) return;

            // Get current or historical replica
            let replica;
            if (currentTimeIndex === -1) {
                // Current time - get from current environment
                replica = Array.from(xlnEnv.replicas.values()).find(r => 
                    r.signerId === signerId && r.entityId === entityId
                );
            } else {
                // Historical time - get from snapshot
                const snapshot = XLN.getHistory()[currentTimeIndex];
                if (snapshot && snapshot.replicas) {
                    replica = Array.from(snapshot.replicas.values()).find(r => 
                        r.signerId === signerId && r.entityId === entityId
                    );
                }
            }

            if (!replica) {
                // Clear all components if entity not found
                ['consensusContent', 'chatContent', 'proposalsContent', 'historyContent'].forEach(compPrefix => {
                    const elem = document.getElementById(`${compPrefix}-${tabId}`);
                    if (elem) elem.innerHTML = '<div class="empty-state">Entity not found</div>';
                });
                return;
            }

            console.log(`🎯 Rendering entity in tab ${tabId}:`, replica);

            // Update tab data to match exactly what we're showing (reactive binding)
            const tab = tabSystem.tabs.find(t => t.id === tabId);
            if (tab) {
                const jurisdictionName = replica.state?.config?.jurisdiction?.name || 'Ethereum';
                tab.jurisdiction = jurisdictionName;
                tab.signer = signerId;
                tab.entityId = entityId;
                
                // Update dropdown display to match panel content exactly
                updateTabDropdownDisplay(tabId);
                saveTabsToStorage();
            }

            // Render entity profile and all components with the replica data
            renderEntityProfile(tabId, replica);
            renderConsensusState(tabId, replica);
            renderChatMessages(tabId, replica);
            renderProposals(tabId, replica);
            renderTransactionHistory(tabId, replica);
        }

        // Render entity profile with identicon
        function renderEntityProfile(tabId, replica) {
            const container = document.getElementById(`entityProfile-${tabId}`);
            if (!container || !replica) {
                if (container) container.innerHTML = '<div class="empty-state">- select entity to view profile</div>';
                return;
            }

            const config = replica.state?.config || {};
            const validators = config.validators || [];
            const weights = config.weights || [];
            const threshold = config.threshold || 1;
            const entityNumber = replica.entityId.startsWith('0x0000000000000000000000000000000000000000000000000000000000000000') ? 
                parseInt(replica.entityId.slice(-2), 16) : null;
            
            // Generate avatar for the ENTITY (not signer) - use entityId for consistent avatars
            const avatarSvg = XLN.generateSignerAvatar ? XLN.generateSignerAvatar(replica.entityId) : null;
            
            // Determine role
            const isProposer = validators.length > 0 && validators[0] === replica.signerId;
            
            // Create board list with weights
            const boardList = validators.map((validator, index) => {
                const weight = weights[index] || 1;
                const isCurrentSigner = validator === replica.signerId;
                const isValidatorProposer = index === 0;
                const validatorAvatar = XLN.generateSignerAvatar ? XLN.generateSignerAvatar(validator) : null;
                
                return `
                    <div class="board-member-row ${isCurrentSigner ? 'current-signer' : ''}" 
                         onclick="switchToValidator('${tabId}', '${validator}')" 
                         title="Click to view ${validator}">
                        ${validatorAvatar ? `<img src="${validatorAvatar}" class="mini-avatar">` : ''}
                        <span class="validator-name">${validator}</span>
                        <span class="validator-weight">${weight}</span>
                        ${isValidatorProposer ? '<span class="mini-badge">👑</span>' : ''}
                        ${isCurrentSigner ? '<span class="mini-badge">👈</span>' : ''}
                    </div>
                `;
            }).join('');
            
            const profileHTML = `
                <div class="entity-profile">
                    ${avatarSvg ? `<img src="${avatarSvg}" class="profile-avatar" onerror="this.style.display='none'">` : ''}
                    <div class="profile-info">
                        <div class="profile-name">
                            ${entityNumber !== null ? `Entity ${entityNumber}` : `Entity ${replica.entityId.slice(-4)}`}
                            ${isProposer ? '<span class="profile-role">Proposer</span>' : ''}
                        </div>

                        <div class="profile-board">
                            <div class="board-title"><strong>Board:</strong> ${threshold}/${validators.length} threshold</div>
                            <div class="board-members-list">
                                ${boardList}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = profileHTML;
        }

        // Generate entity profile HTML (extracted from existing renderSelectedEntity)
        function generateEntityProfileHTML(replica) {
            const config = replica.state?.config || {};
            const state = replica.state || {};
            
            // Generate avatar URLs
            const entityAvatarSvg = XLN.generateAvatar ? XLN.generateAvatar(replica.entityId, 64) : '';
            const signerAvatarSvg = XLN.generateAvatar ? XLN.generateAvatar(replica.signerId, 32) : '';
            
            const entityAvatarUrl = entityAvatarSvg.startsWith('data:') ? entityAvatarSvg : `data:image/svg+xml;charset=utf-8,${encodeURIComponent(entityAvatarSvg)}`;
            const signerAvatarUrl = signerAvatarSvg.startsWith('data:') ? signerAvatarSvg : `data:image/svg+xml;charset=utf-8,${encodeURIComponent(signerAvatarSvg)}`;
            
            const entityAvatarImg = `<img src="${entityAvatarUrl}" style="width: 64px; height: 64px; border-radius: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><div style="width: 64px; height: 64px; border-radius: 32px; background: #333; display: none; align-items: center; justify-content: center; color: #9d9d9d; font-size: 24px;">🏢</div>`;
            
            const signerAvatarImg = `<img src="${signerAvatarUrl}" style="width: 32px; height: 32px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); margin-right: 8px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><div style="width: 32px; height: 32px; border-radius: 16px; background: #333; display: none; align-items: center; justify-content: center; color: #9d9d9d; font-size: 16px; margin-right: 8px;">👤</div>`;

            // Continue with the rest of the existing entity profile HTML generation...
            // This is a simplified version - you would include all the existing profile sections
            return `
                <div class="entity-profile-page">
                    <div class="profile-header">
                        <div class="entity-avatar" style="margin-right: 20px;">
                            ${entityAvatarImg}
                        </div>
                        <div class="entity-title-section">
                            <h1 style="margin: 0 0 8px 0; color: #007acc; font-size: 1.8em;">Entity ${XLN.formatEntityDisplay ? XLN.formatEntityDisplay(replica.entityId) : replica.entityId}</h1>
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                ${signerAvatarImg}
                                <span style="color: #9d9d9d; font-size: 18px;">${XLN.formatSignerDisplay ? XLN.formatSignerDisplay(replica.signerId) : replica.signerId}</span>
                            </div>

                        </div>
                    </div>
                    
                    <div class="profile-content">
                        <!-- Minimal entity info -->
                        <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 0.75em; color: #aaa;">
                            <img src="${XLN.generateEntityAvatar(replica.entityId)}" style="width: 16px; height: 16px; border-radius: 50%;" />
                            <span style="color: #fff;">Entity ${XLN.extractNumberFromEntityId ? XLN.extractNumberFromEntityId(replica.entityId) || replica.entityId.slice(0,4) : replica.entityId.slice(0,4)}</span>
                            <span style="margin-left: 4px;">${Object.entries(state.config?.board || {}).map(([signer, weight]) => `${signer}:${weight}`).join(' ')}</span>
                        </div>
                        

                    </div>
                </div>
            `;
        }

        // Highlight search term in dropdown items
        function highlightSearchTerm(element, searchTerm) {
            if (!searchTerm) return;
            
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            textNodes.forEach(textNode => {
                const text = textNode.textContent;
                const lowerText = text.toLowerCase();
                const lowerSearchTerm = searchTerm.toLowerCase();
                
                if (lowerText.includes(lowerSearchTerm)) {
                    const index = lowerText.indexOf(lowerSearchTerm);
                    const before = text.substring(0, index);
                    const match = text.substring(index, index + searchTerm.length);
                    const after = text.substring(index + searchTerm.length);
                    
                    const highlightSpan = document.createElement('span');
                    highlightSpan.style.backgroundColor = '#ffd700';
                    highlightSpan.style.color = '#000';
                    highlightSpan.style.padding = '2px 4px';
                    highlightSpan.style.borderRadius = '3px';
                    highlightSpan.textContent = match;
                    
                    const fragment = document.createDocumentFragment();
                    if (before) fragment.appendChild(document.createTextNode(before));
                    fragment.appendChild(highlightSpan);
                    if (after) fragment.appendChild(document.createTextNode(after));
                    
                    textNode.parentNode.replaceChild(fragment, textNode);
                }
            });
        }

        // Component Layout State Management
        let componentStates = {};

        // Load component states from localStorage and URL hash
        function loadComponentStates() {
            try {
                // First try to load from URL hash
                if (location.hash) {
                    const hashData = location.hash.substring(1);
                    const decodedData = atob(hashData);
                    const urlStates = JSON.parse(decodedData);
                    if (urlStates.componentStates) {
                        componentStates = urlStates.componentStates;
                        return;
                    }
                }
                
                // Fallback to localStorage
                const saved = localStorage.getItem('xlnComponentStates');
                if (saved) {
                    componentStates = JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Failed to load component states:', e);
                componentStates = {};
            }
        }

        // Save component states to localStorage and URL hash
        function saveComponentStates() {
            try {
                localStorage.setItem('xlnComponentStates', JSON.stringify(componentStates));
                
                // Also save to URL hash for sharing
                const exportData = {
                    componentStates: componentStates,
                    timestamp: Date.now(),
                    version: '1.0'
                };
                const encoded = btoa(JSON.stringify(exportData));
                history.replaceState(null, '', '#' + encoded);
            } catch (e) {
                console.warn('Failed to save component states:', e);
            }
        }

        // Get component state (default: consensus and chat expanded)
        function getComponentState(componentId) {
            if (componentStates[componentId] !== undefined) {
                return componentStates[componentId];
            }
            
            // Default states: consensus and chat expanded, others collapsed
            return componentId.includes('consensus-') || componentId.includes('chat-');
        }

        // Toggle component collapse/expand
        function toggleComponent(componentId) {
            const component = document.getElementById(componentId);
            if (!component) return;

            const header = component.querySelector('.component-header');
            const content = component.querySelector('.component-content');
            const toggle = component.querySelector('.component-toggle');

            const isCollapsed = header.classList.contains('collapsed');
            
            if (isCollapsed) {
                // Expand
                header.classList.remove('collapsed');
                content.classList.remove('collapsed');
                componentStates[componentId] = true;
            } else {
                // Collapse
                header.classList.add('collapsed');
                content.classList.add('collapsed');
                componentStates[componentId] = false;
            }

            saveComponentStates();
        }

        // Apply saved component states to a panel
        function applyComponentStates(tabId) {
            const components = ['consensus', 'chat', 'proposals', 'history', 'controls'];
            
            components.forEach(comp => {
                const componentId = `${comp}-${tabId}`;
                const isExpanded = getComponentState(componentId);
                const component = document.getElementById(componentId);
                
                if (component) {
                    const header = component.querySelector('.component-header');
                    const content = component.querySelector('.component-content');
                    
                    if (isExpanded) {
                        header.classList.remove('collapsed');
                        content.classList.remove('collapsed');
                    } else {
                        header.classList.add('collapsed');
                        content.classList.add('collapsed');
                    }
                }
            });
        }

        // Update controls form based on dropdown selection
        function updateControlsForm(tabId, action) {
            const formContainer = document.getElementById(`controlsForm-${tabId}`);
            if (!formContainer) return;

            let formHTML = '';

            switch (action) {
                case 'chat':
                    formHTML = `
                        <div class="form-group">
                            <label class="form-label">Message:</label>
                            <textarea class="form-textarea" placeholder="Enter your message..."></textarea>
                        </div>
                        <button class="form-button" onclick="submitChatMessage('${tabId}')">Send Message</button>
                    `;
                    break;
                    
                case 'proposal':
                    formHTML = `
                        <div class="form-group">
                            <label class="form-label">Proposal Title:</label>
                            <input type="text" class="form-input" placeholder="Enter proposal title...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description:</label>
                            <textarea class="form-textarea" placeholder="Describe your proposal..."></textarea>
                        </div>
                        <button class="form-button" onclick="submitProposal('${tabId}')">Create Proposal</button>
                    `;
                    break;
                    
                case 'vote':
                    // Get current replica to populate proposals
                    const activeTab = tabSystem.tabs.find(tab => tab.id === tabId);
                    const replica = activeTab ? xlnEnv?.replicas?.get(`${activeTab.signer}:${activeTab.entityId}`) : null;
                    
                    console.log('🗳️ Vote form - Active tab:', activeTab);
                    console.log('🗳️ Vote form - Replica:', replica);
                    console.log('🗳️ Vote form - All replicas:', Array.from(xlnEnv?.replicas?.keys() || []));
                    
                    let proposalOptions = '<option value="">Select a proposal...</option>';
                    let proposalCount = 0;
                    let allProposals = new Map();
                    
                    if (activeTab && xlnEnv?.replicas) {
                        // Check all replicas for the same entity to get all proposals
                        Array.from(xlnEnv.replicas.values()).forEach(r => {
                            if (r.entityId === activeTab.entityId && r.state?.proposals) {
                                console.log(`🗳️ Checking replica ${r.signerId} for proposals...`);
                                console.log('🗳️ Replica proposals:', r.state.proposals);
                                console.log('🗳️ Proposals type:', typeof r.state.proposals);
                                
                                if (r.state.proposals instanceof Map) {
                                    console.log('🗳️ Processing Map proposals, size:', r.state.proposals.size);
                                    r.state.proposals.forEach((proposal, key) => {
                                        allProposals.set(key, proposal);
                                    });
                                } else if (typeof r.state.proposals === 'object') {
                                    console.log('🗳️ Processing object proposals, keys:', Object.keys(r.state.proposals));
                                    Object.entries(r.state.proposals).forEach(([key, proposal]) => {
                                        allProposals.set(key, proposal);
                                    });
                                }
                            }
                        });
                    }
                    
                    console.log('🗳️ All proposals found across replicas:', allProposals);
                    
                    // Convert to options
                    allProposals.forEach((proposal, key) => {
                        console.log('🗳️ Processing proposal:', key, proposal);
                        const proposalText = proposal.action?.data?.message || 'Unknown proposal';
                        const proposer = proposal.proposer || 'Unknown';
                        proposalOptions += `<option value="${escapeHtml(key)}">${escapeHtml(proposalText)} (by ${escapeHtml(proposer)})</option>`;
                        proposalCount++;
                    });
                    
                    console.log('🗳️ Total proposals found:', proposalCount);
                    console.log('🗳️ Final proposal options HTML:', proposalOptions);
                    
                    formHTML = `
                        <div class="form-group">
                            <label class="form-label">Select Proposal:</label>
                            <select class="form-input" id="proposalSelect-${tabId}">
                                ${proposalOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vote:</label>
                            <select class="form-input" id="voteChoice-${tabId}">
                                <option value="yes">✅ Yes</option>
                                <option value="no">❌ No</option>
                                <option value="abstain">⚪ Abstain</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comment (optional):</label>
                            <textarea class="form-textarea" id="voteComment-${tabId}" placeholder="Add a comment to explain your vote..."></textarea>
                        </div>
                        <button class="form-button" onclick="submitVote('${tabId}')">Submit Vote</button>
                    `;
                    break;
                    
                case 'entity':
                    formHTML = `
                        <div class="form-group">
                            <label class="form-label">🏛️ Jurisdiction:</label>
                            <select class="form-input" id="jurisdiction-${tabId}">
                                <option value="8545" selected>Ethereum Mainnet (Port 8545)</option>
                                <option value="8546">Polygon Network (Port 8546)</option>
                                <option value="8547">Arbitrum One (Port 8547)</option>
                            </select>
                            <div style="padding: 6px; background: #e8f5e8; border-left: 3px solid #4caf50; margin: 6px 0; border-radius: 3px; font-size: 0.8em;">
                                <strong>📡 Network:</strong> Ethereum Mainnet<br>
                                <strong>🔗 RPC Port:</strong> 8545
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🆔 Entity Type:</label>
                            <select class="form-input" id="entityType-${tabId}" onchange="onEntityTypeChangeTab('${tabId}'); updateTabQuorumHash('${tabId}')">
                                <option value="lazy">🔒 Lazy Entity (Free - ID = Quorum Hash)</option>
                                <option value="numbered">🔢 Numbered Entity (Gas Required - Sequential ID)</option>
                                <option value="named">🏷️ Named Entity (Premium Gas + Admin Approval)</option>
                            </select>
                            <div style="padding: 6px; background: #f8f9fa; border-left: 3px solid #6c757d; margin: 6px 0; border-radius: 3px; font-size: 0.75em; color: #666;">
                                <strong>🔒 Lazy:</strong> Free to create, entityId = hash(validators), works immediately.<br>
                                <strong>🔢 Numbered:</strong> Small gas cost, get sequential number like #42, on-chain registered.<br>
                                <strong>🏷️ Named:</strong> Premium gas + admin approval, get custom name like "coinbase".
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🏷️ Entity Name:</label>
                            <input type="text" class="form-input" id="entityName-${tabId}" placeholder="e.g., trading, chat, governance" value="ACME" oninput="updateTabQuorumHash('${tabId}')">
                            <div style="font-size: 0.75em; color: #666; margin-top: 4px;">
                                Display name for your entity (not used for ID generation in lazy mode)
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">👥 Validators:</label>
                            <div id="validatorsList-${tabId}">
                                <div class="validator-row-simple" data-validator-id="0" style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
                                    <select class="form-input" id="validator0-${tabId}" style="flex: 1;" onchange="updateTabQuorumHash('${tabId}')">
                                        <option value="">Select signer...</option>
                                        <option value="alice.eth">alice.eth</option>
                                        <option value="bob.eth">bob.eth</option>
                                        <option value="carol.eth">carol.eth</option>
                                    </select>
                                    <input type="number" class="form-input" style="width: 60px;" placeholder="1" value="1" min="1" oninput="updateTabQuorumHash('${tabId}')">
                                </div>
                            </div>
                            <button type="button" class="form-button" style="margin-top: 8px; background: #666; font-size: 0.8em; padding: 6px 12px;" onclick="addValidatorToTab('${tabId}')">➕ Add Validator</button>
                            <div style="font-size: 0.75em; color: #666; margin-top: 4px;">
                                💡 Start with a single signer for personal use, or add more for multisig/corporate entities
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🎯 Threshold: <span id="thresholdValue-${tabId}">1</span></label>
                            <input type="range" class="form-input" id="threshold-${tabId}" min="1" max="2" value="1" style="width: 100%;" oninput="updateThresholdTab('${tabId}')">
                            <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #666;">
                                <span>Total Weight: <span id="totalWeight-${tabId}">1</span></span>
                                <span>Required: <span id="thresholdValue-${tabId}">1</span></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🔒 Quorum Hash:</label>
                            <div id="quorumHash-${tabId}" style="font-family: monospace; font-size: 0.7em; padding: 6px; background: #e9ecef; border: 2px solid #6c757d; border-radius: 6px; color: #495057; word-break: break-all;">
                                Configure validators and threshold to see quorum hash
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🆔 Expected Entity ID:</label>
                            <div id="expectedEntityId-${tabId}" style="font-family: monospace; font-size: 0.7em; padding: 6px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #d4d4d4; word-break: break-all;">
                                Configure validators and threshold to see entity ID
                            </div>
                        </div>
                        
                        <button class="form-button" onclick="submitEntityFormation('${tabId}')">🚀 Create Entity</button>
                    `;
                    break;
                    
                case 'jtx':
                    formHTML = `
                        <div class="form-group">
                            <label class="form-label">To Entity:</label>
                            <input type="text" class="form-input" placeholder="Entity ID or name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount:</label>
                            <input type="number" class="form-input" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message (optional):</label>
                            <input type="text" class="form-input" placeholder="Transaction note">
                        </div>
                        <button class="form-button" onclick="submitJTx('${tabId}')">Send J-tx</button>
                    `;
                    break;
                    
                case 'settings':
                    formHTML = `
                        <div class="form-group">
                            <label class="form-label">Update Type:</label>
                            <select class="form-input">
                                <option value="threshold">Change Threshold</option>
                                <option value="validators">Update Validators</option>
                                <option value="metadata">Update Metadata</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Value:</label>
                            <input type="text" class="form-input" placeholder="Enter new value...">
                        </div>
                        <button class="form-button" onclick="submitSettingsUpdate('${tabId}')">Update Settings</button>
                    `;
                    break;
                    
                default:
                    formHTML = '<div class="empty-state">Select an action above</div>';
            }

            formContainer.innerHTML = formHTML;
        }

        // Render consensus state for an entity
        function renderConsensusState(tabId, replica) {
            const container = document.getElementById(`consensusContent-${tabId}`);
            if (!container || !replica) {
                container.innerHTML = '<div class="empty-state">- select entity to view consensus state</div>';
                return;
            }

            const state = replica.state || {};
            const config = state.config || {};
            const isLocked = replica.lockedFrame ? true : false;
            const isProposing = replica.proposal ? true : false;
            const frameHeight = toNumber(replica.blockHeight || 0);
            const proposalHeight = replica.proposal?.height ? toNumber(replica.proposal.height) : 'N/A';
            const lockedHeight = replica.lockedFrame?.height ? toNumber(replica.lockedFrame.height) : 'N/A';
            
            // Determine role: first signer in validators list = proposer
            const validators = config.validators || [];
            const isCurrentProposer = validators.length > 0 && validators[0] === replica.signerId;
            const role = isCurrentProposer ? '👑 Proposer' : (isProposing ? `📝 Proposing (${proposalHeight})` : '👁️ Validator');

            container.innerHTML = `
                <div class="consensus-item">
                    <span class="consensus-label">Status:</span>
                    <span class="consensus-value ${isLocked ? 'consensus-status-locked' : 'consensus-status-unlocked'}">
                        ${isLocked ? `🔒 Locked (${lockedHeight})` : '🔓 Unlocked'}
                    </span>
                </div>
                <div class="consensus-item">
                    <span class="consensus-label">Role:</span>
                    <span class="consensus-value">${role}</span>
                </div>
                <div class="consensus-item">
                    <span class="consensus-label">Frame Height:</span>
                    <span class="consensus-value">${frameHeight}</span>
                </div>
                <div class="consensus-item">
                    <span class="consensus-label">Messages:</span>
                    <span class="consensus-value">${state.messages?.length || 0}</span>
                </div>
                <div class="consensus-item">
                    <span class="consensus-label">Proposals:</span>
                    <span class="consensus-value">${state.proposals?.size || 0}</span>
                </div>
            `;
        }

        // Render clickable board with avatars
        function renderClickableBoard(tabId, config, currentSignerId) {
            const validators = config.validators || [];
            const threshold = toNumber(config.threshold || 1);
            
            if (validators.length === 0) {
                return '<span>No validators</span>';
            }

            console.log('🔍 Board config:', { validators, threshold, config });

            const boardHTML = validators.map((validator, index) => {
                const isCurrentSigner = validator === currentSignerId;
                const isProposer = index === 0; // First signer = proposer
                const avatarSvg = XLN.generateSignerAvatar ? XLN.generateSignerAvatar(validator) : null;
                
                return `
                    <div class="board-member ${isCurrentSigner ? 'current-signer' : ''}" 
                         onclick="switchToValidator('${tabId}', '${validator}')" 
                         title="Click to view ${validator}">
                        ${avatarSvg ? `<img src="${avatarSvg}" class="board-avatar" onerror="this.style.display='none'">` : ''}
                        <span class="board-name">${validator}</span>
                        ${isProposer ? '<span class="proposer-badge">👑</span>' : ''}
                        ${isCurrentSigner ? '<span class="current-badge">👈</span>' : ''}
                    </div>
                `;
            }).join('');

            return `
                <div class="board-container">
                    <div class="board-header">Threshold: ${threshold}/${validators.length}</div>
                    <div class="board-members">${boardHTML}</div>
                </div>
            `;
        }

        // Switch panel to view a different validator
        function switchToValidator(tabId, validatorId) {
            console.log(`🔄 Switching tab ${tabId} to validator: ${validatorId}`);
            
            // Find replica for this validator
            const targetReplica = Array.from(xlnEnv.replicas.values()).find(r => r.signerId === validatorId);
            if (!targetReplica) {
                console.warn('Validator replica not found:', validatorId);
                return;
            }

            // Update tab data
            updateTab(tabId, {
                signer: validatorId,
                entityId: targetReplica.entityId,
                jurisdiction: targetReplica.state?.config?.jurisdiction?.name || 'Ethereum'
            });
        }

        // HTML escaping function to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Universal BigInt conversion utility
        function toNumber(value) {
            if (typeof value === 'bigint') {
                return Number(value);
            }
            return value;
        }

        // Safe arithmetic operations that handle BigInt
        function safeAdd(a, b) {
            return toNumber(a) + toNumber(b);
        }

        function safeDivide(a, b) {
            return toNumber(a) / toNumber(b);
        }

        function safeMultiply(a, b) {
            return toNumber(a) * toNumber(b);
        }

        // Safe JSON stringify that handles BigInt
        function safeStringify(obj, maxLength = null) {
            try {
                const result = JSON.stringify(obj, (key, value) => 
                    typeof value === 'bigint' ? value.toString() : value
                );
                return maxLength ? result.slice(0, maxLength) + (result.length > maxLength ? '...' : '') : result;
            } catch (error) {
                return '[Serialization Error]';
            }
        }

        // Render chat messages for an entity
        function renderChatMessages(tabId, replica) {
            const container = document.getElementById(`chatContent-${tabId}`);
            if (!container || !replica) {
                container.innerHTML = '<div class="empty-state">- no messages</div>';
                return;
            }

            const messages = replica.state?.messages || [];
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state">- no messages</div>';
                return;
            }

            // Messages are simple strings in the actual data structure
            container.innerHTML = messages.map((msg, index) => `
                <div class="chat-message">
                    <div class="chat-meta">Message #${index + 1} • ${escapeHtml(replica.signerId)}</div>
                    <div class="chat-content">${escapeHtml(msg)}</div>
                </div>
            `).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Render proposals for an entity
        function renderProposals(tabId, replica) {
            const container = document.getElementById(`proposalsContent-${tabId}`);
            if (!container || !replica) {
                container.innerHTML = '<div class="empty-state">- no proposals</div>';
                return;
            }

            // Debug: log the proposals structure
            console.log(`📋 Rendering proposals for ${replica.signerId}:${replica.entityId?.slice(0,8)}...`);
            console.log(`📋 Replica state:`, replica.state);
            console.log(`📋 Proposals:`, replica.state?.proposals);
            console.log(`📋 Proposals type:`, typeof replica.state?.proposals);
            console.log(`📋 Proposals constructor:`, replica.state?.proposals?.constructor?.name);

            // Get proposals from current state and history
            const currentProposals = replica.state?.proposals;
            let allProposals = [];
            
            // Add current proposals - handle both Map and Object cases
            if (currentProposals) {
                if (currentProposals instanceof Map && currentProposals.size > 0) {
                    allProposals = Array.from(currentProposals.entries()).map(([key, proposal], index) => ({
                        key,
                        proposal,
                        type: 'current',
                        index: index + 1
                    }));
                } else if (typeof currentProposals === 'object' && Object.keys(currentProposals).length > 0) {
                    // Handle if proposals is a plain object instead of Map
                    allProposals = Object.entries(currentProposals).map(([key, proposal], index) => ({
                        key,
                        proposal,
                        type: 'current',
                        index: index + 1
                    }));
                }
            }
            
            // Add proposals from history
            if (xlnEnv.history) {
                xlnEnv.history.forEach((snapshot, frameIndex) => {
                    const historicalReplica = Array.from(snapshot.replicas.values()).find(r => r.entityId === replica.entityId);
                    if (historicalReplica?.state?.proposals && historicalReplica.state.proposals.size > 0) {
                        Array.from(historicalReplica.state.proposals.entries()).forEach(([key, proposal]) => {
                            // Avoid duplicates
                            if (!allProposals.find(p => p.key === key)) {
                                allProposals.push({
                                    key,
                                    proposal,
                                    type: 'historical',
                                    frame: frameIndex,
                                    index: allProposals.length + 1
                                });
                            }
                        });
                    }
                });
            }
            
            if (allProposals.length === 0) {
                container.innerHTML = '<div class="empty-state">- no proposals</div>';
                return;
            }
            
            container.innerHTML = allProposals.map(item => {
                const proposal = item.proposal;
                const proposalText = proposal.action?.data?.message || 'Unknown proposal';
                const proposer = proposal.proposer || 'Unknown';
                const votes = proposal.votes ? Array.from(proposal.votes.entries()) : [];
                const yesVotes = votes.filter(([_, vote]) => vote === true || vote === 'yes');
                const noVotes = votes.filter(([_, vote]) => vote === false || vote === 'no');
                const abstainVotes = votes.filter(([_, vote]) => vote === 'abstain');
                
                // Calculate voting power correctly using shares, not just count
                const config = replica.state?.config;
                const threshold = toNumber(config?.threshold || 1);
                const shares = config?.shares || {};
                
                // Calculate total voting power of YES votes
                const yesVotingPower = yesVotes.reduce((total, [voter, _]) => {
                    const voterShares = toNumber(shares[voter] || 0);
                    return total + voterShares;
                }, 0);
                
                // Calculate total voting power that has voted
                const totalVoted = votes.reduce((total, [voter, _]) => {
                    const voterShares = toNumber(shares[voter] || 0);
                    return total + voterShares;
                }, 0);
                
                // Calculate total possible voting power
                const totalPossiblePower = Object.values(shares).reduce((total, power) => {
                    return total + toNumber(power);
                }, 0);
                
                // Calculate remaining voting power that could still vote
                const remainingPower = totalPossiblePower - totalVoted;
                
                // Check if proposal can still reach threshold
                const maxPossibleYes = yesVotingPower + remainingPower;
                const canStillPass = maxPossibleYes >= threshold;
                const isFailed = !canStillPass && proposal.status !== 'executed';
                
                const progressPercent = Math.min(safeDivide(safeMultiply(yesVotingPower, 100), threshold), 100);
                const isExecuted = proposal.status === 'executed' || yesVotingPower >= threshold;
                
                // Debug: log vote processing
                console.log(`🗳️ Rendering proposal ${item.key}:`, proposal);
                console.log(`🗳️ Raw votes for proposal ${item.key}:`, proposal.votes);
                console.log(`🗳️ Votes array:`, votes);
                
                // Build vote details with comments
                const voteDetails = votes.map(([voter, voteData]) => {
                    console.log(`🗳️ Processing vote from ${voter}:`, voteData, typeof voteData);
                    
                    // Handle both old format (boolean) and new format (object with choice and comment)
                    const vote = typeof voteData === 'object' ? voteData.choice : voteData;
                    const comment = typeof voteData === 'object' ? voteData.comment : null;
                    
                    const voteIcon = vote === 'yes' || vote === true ? '✅' : vote === 'no' || vote === false ? '❌' : '⚪';
                    const voteText = vote === 'yes' || vote === true ? 'yes' : vote === 'no' || vote === false ? 'no' : 'abstain';
                    
                    let voteDisplay = `<div class="vote-entry">${escapeHtml(voter)} - ${voteIcon} ${voteText}`;
                    if (comment && comment.trim()) {
                        voteDisplay += `<br/><span class="vote-comment">"${escapeHtml(comment.trim())}"</span>`;
                    }
                    voteDisplay += '</div>';
                    return voteDisplay;
                }).join('');
                
                console.log(`🗳️ Final vote details for proposal ${item.key}:`, voteDetails);
                
                return `
                    <div class="proposal-item ${isExecuted ? 'executed' : ''} ${isFailed ? 'failed' : ''}">
                        <div class="proposal-title">${escapeHtml(proposalText)}</div>
                        <div class="proposal-meta">
                            <span>By: ${escapeHtml(proposer)}</span>
                            ${isExecuted ? '<span class="executed-badge">✅ EXECUTED</span>' : ''}
                            ${isFailed ? '<span class="failed-badge">❌ FAILED</span>' : ''}
                        </div>
                        <div class="proposal-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="progress-text">${yesVotingPower}/${threshold} votes (${Math.round(progressPercent)}%)</div>
                        </div>
                        ${voteDetails ? `<div class="vote-details">${voteDetails}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Banking-style horizontal transaction rendering
        function renderBankingInput(input) {
            // Get primary transaction info
            let primaryInfo = 'Entity Input';
            let secondaryInfo = '';
            let amount = '';
            
            if (input.entityTxs && input.entityTxs.length > 0) {
                // Show ALL transactions, not just first one
                if (input.entityTxs.length === 1) {
                    const tx = input.entityTxs[0];
                    if (tx.type === 'chat') {
                        primaryInfo = '💬 Chat Message';
                        secondaryInfo = `"${tx.data.message}" from ${tx.data.from}`;
                    } else if (tx.type === 'propose') {
                        primaryInfo = '📝 Proposal';
                        secondaryInfo = `${tx.data.action?.data?.message || 'New proposal'} by ${tx.data.proposer}`;
                    } else if (tx.type === 'vote') {
                        primaryInfo = '🗳️ Vote';
                        secondaryInfo = `${tx.data.choice} on ${tx.data.proposalId?.slice(0,8)}... from ${tx.data.voter || 'unknown'}`;
                    } else {
                        primaryInfo = `⚙️ ${tx.type}`;
                        secondaryInfo = safeStringify(tx.data, 40);
                    }
                } else {
                    // Multiple transactions - show summary
                    primaryInfo = `📦 ${input.entityTxs.length} Transactions`;
                    const types = input.entityTxs.map(tx => tx.type).join(', ');
                    secondaryInfo = `Types: ${types}`;
                    amount = `${input.entityTxs.length} txs`;
                }
            }
            
            if (input.precommits && input.precommits.size > 0) {
                const signers = Array.from(input.precommits.keys()).join(', ');
                if (primaryInfo === 'Entity Input') {
                    primaryInfo = '🔐 Precommits';
                    secondaryInfo = `${input.precommits.size} signatures from ${signers}`;
                } else {
                    amount = `${input.precommits.size} precommits`;
                }
            }
            
            if (input.proposedFrame) {
                if (primaryInfo === 'Entity Input') {
                    primaryInfo = '📋 Frame Proposal';
                    secondaryInfo = `${input.proposedFrame.hash?.slice(0,12)}... from ${input.signerId}`;
                }
            }
            
            return `
                <div class="banking-transaction-item banking-input">
                    <div class="transaction-icon">📥</div>
                    <div class="transaction-details">
                        <div class="transaction-primary">${primaryInfo}</div>
                        <div class="transaction-secondary">${secondaryInfo}</div>
                    </div>
                    <div class="transaction-amount">${amount}</div>
                </div>
            `;
        }

        function renderBankingImport(serverTx) {
            let primaryInfo = '🔄 Replica Import';
            let secondaryInfo = `Imported from server`;
            let amount = '';
            
            if (serverTx.type === 'importReplica') {
                primaryInfo = '🔄 Replica Import';
                secondaryInfo = `Server imported ${serverTx.data.signerId} (proposer: ${serverTx.data.isProposer ? 'Yes' : 'No'})`;
                amount = 'IMPORT';
            }
            
            return `
                <div class="banking-transaction-item banking-import">
                    <div class="transaction-icon">🔄</div>
                    <div class="transaction-details">
                        <div class="transaction-primary">${primaryInfo}</div>
                        <div class="transaction-secondary">${secondaryInfo}</div>
                    </div>
                    <div class="transaction-amount">${amount}</div>
                </div>
            `;
        }

        function renderBankingOutput(output) {
            // Get primary transaction info
            let primaryInfo = 'Entity Output';
            let secondaryInfo = '';
            let amount = '';
            
            if (output.entityTxs && output.entityTxs.length > 0) {
                // Show ALL transactions, not just first one
                if (output.entityTxs.length === 1) {
                    const tx = output.entityTxs[0];
                    const recipients = output.destinations?.join(', ') || 'network';
                    if (tx.type === 'chat') {
                        primaryInfo = '💬 Chat Sent';
                        secondaryInfo = `"${tx.data.message}" to ${recipients}`;
                    } else if (tx.type === 'propose') {
                        primaryInfo = '📝 Proposal Sent';
                        secondaryInfo = `${tx.data.action?.data?.message || 'New proposal'} to ${recipients}`;
                    } else if (tx.type === 'vote') {
                        primaryInfo = '🗳️ Vote Sent';
                        secondaryInfo = `${tx.data.choice} on ${tx.data.proposalId?.slice(0,8)}... to ${recipients}`;
                    } else {
                        primaryInfo = `⚙️ ${tx.type} Sent`;
                        secondaryInfo = `${safeStringify(tx.data, 30)} to ${recipients}`;
                    }
                } else {
                    // Multiple transactions - show summary
                    primaryInfo = `📦 ${output.entityTxs.length} Transactions Sent`;
                    const types = output.entityTxs.map(tx => tx.type).join(', ');
                    const recipients = output.destinations?.join(', ') || 'network';
                    secondaryInfo = `Types: ${types} to ${recipients}`;
                    amount = `${output.entityTxs.length} txs`;
                }
            }
            
            if (output.precommits && output.precommits.size > 0) {
                if (primaryInfo === 'Entity Output') {
                    primaryInfo = '🔐 Precommits Sent';
                    secondaryInfo = `${output.precommits.size} signatures to ${output.destinations?.join(', ') || 'validators'}`;
                } else {
                    amount = `${output.precommits.size} precommits`;
                }
            }
            
            if (output.proposedFrame) {
                if (primaryInfo === 'Entity Output') {
                    primaryInfo = '📋 Frame Sent';
                    secondaryInfo = `${output.proposedFrame.hash?.slice(0,12)}... to ${output.destinations?.join(', ') || 'network'}`;
                }
            }
            
            return `
                <div class="banking-transaction-item banking-output">
                    <div class="transaction-icon">📤</div>
                    <div class="transaction-details">
                        <div class="transaction-primary">${primaryInfo}</div>
                        <div class="transaction-secondary">${secondaryInfo}</div>
                    </div>
                    <div class="transaction-amount">${amount}</div>
                </div>
            `;
        }

        // Render FULL server history filtered by this replica's activity
        function renderTransactionHistory(tabId, replica) {
            const container = document.getElementById(`historyContent-${tabId}`);
            if (!container || !replica) {
                container.innerHTML = '<div class="empty-state">- no frame history</div>';
                return;
            }

            // Check multiple possible history sources
            const history = xlnEnv.history || XLN.getHistory() || [];
            console.log(`🗂️ History check: xlnEnv.history=${xlnEnv.history?.length}, XLN.getHistory()=${XLN.getHistory()?.length}`);
            
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="empty-state">- no server history available</div>';
                return;
            }

            console.log(`🗂️ Rendering history for replica ${replica.signerId}:${replica.entityId}, total frames: ${history.length}`);
                        console.log(`🗂️ First few snapshots:`, history.slice(0, 3).map((s, i) => ({ 
                frame: i, 
                keys: Object.keys(s), 
                serverInput: s.serverInput ? Object.keys(s.serverInput) : 'missing',
                entityInputsCount: s.serverInput?.entityInputs?.length || s.entityInputs?.length || 0,
                serverOutputsCount: s.serverOutputs?.length || s.outputs?.length || 0
            })));

            // Show ENTIRE server history, highlighting this replica's activity
            const serverFrames = history.map((snapshot, frameIndex) => {
                // Get entity inputs from the correct location: serverInput.entityInputs
                const entityInputs = snapshot.serverInput?.entityInputs || snapshot.entityInputs || [];
                const serverOutputs = snapshot.serverOutputs || snapshot.outputs || [];
                
                console.log(`🔍 Frame ${frameIndex}: entityInputs=${entityInputs.length}, serverOutputs=${serverOutputs.length}, snapshot keys:`, Object.keys(snapshot));
                
                            // Find ONLY this specific replica's activity (strict filtering)
            const replicaInputs = entityInputs.filter(input => {
                // Only inputs TO this specific replica (entityId + signerId combo)
                const match = input.entityId === replica.entityId && input.signerId === replica.signerId;
                if (match) {
                    console.log(`✅ Found replica input in frame ${frameIndex}:`, { entityId: input.entityId, signerId: input.signerId, type: input.type || 'unknown' });
                }
                return match;
            }) || [];
            
            const replicaOutputs = serverOutputs.filter(output => {
                // Only outputs FROM this specific replica
                const match = output.entityId === replica.entityId && output.signerId === replica.signerId;
                if (match) {
                    console.log(`✅ Found replica output in frame ${frameIndex}:`, { entityId: output.entityId, signerId: output.signerId, type: output.type || 'unknown' });
                }
                return match;
            }) || [];

            // Also include serverTx imports related to this replica
            const serverTxs = snapshot.serverTxs || snapshot.serverInput?.serverTxs || [];
            
            const replicaImports = serverTxs.filter(serverTx => {
                if (serverTx.type === 'importReplica') {
                    const match = serverTx.entityId === replica.entityId && serverTx.data.signerId === replica.signerId;
                    if (match) {
                        console.log(`✅ Found replica import in frame ${frameIndex}:`, { entityId: serverTx.entityId, signerId: serverTx.data.signerId });
                    }
                    return match;
                }
                return false;
            }) || [];

                // Also check serverTxs that might relate to this replica
                const relevantServerTxs = snapshot.serverTxs?.filter(tx =>
                    tx.entityId === replica.entityId || tx.from === replica.signerId
                ) || [];
                
                return {
                    frameIndex,
                    snapshot,
                    inputs: replicaInputs,
                    outputs: replicaOutputs,
                    imports: replicaImports,
                    serverTxs: relevantServerTxs,
                    timestamp: snapshot.timestamp || (Date.now() - (xlnEnv.history.length - frameIndex) * 1000),
                    hasActivity: replicaInputs.length > 0 || replicaOutputs.length > 0 || replicaImports.length > 0
                };
            });

            console.log(`📊 Found ${serverFrames.filter(f => f.hasActivity).length} frames with activity out of ${serverFrames.length} total`);

            // Render ALL server frames (chronological order, newest first)
            container.innerHTML = serverFrames.slice().reverse().map(frame => {
                const isCurrentFrame = typeof currentTimeIndex !== 'undefined' && frame.frameIndex === currentTimeIndex;
                const hasActivity = frame.hasActivity;
                
                return `
                    <div class="frame-item ${isCurrentFrame ? 'current-frame' : ''} ${hasActivity ? 'has-activity' : 'no-activity'}" data-frame="${frame.frameIndex}">
                        <div class="frame-header">
                            <span>Server Frame ${frame.frameIndex}</span>
                            <span class="frame-time">${new Date(frame.timestamp).toLocaleTimeString()}</span>
                            ${hasActivity ? '<span class="activity-badge">🟢</span>' : '<span class="activity-badge">⚪</span>'}
                        </div>
                        ${hasActivity ? `
                        <div class="frame-content">
                            <div class="banking-transactions">
                                ${frame.imports.map(imp => renderBankingImport(imp)).join('')}
                                ${frame.inputs.map(input => renderBankingInput(input)).join('')}
                                ${frame.outputs.map(output => renderBankingOutput(output)).join('')}
                            </div>
                        </div>
                        ` : '<div class="frame-inactive">No activity from this replica in this frame</div>'}
                    </div>
                `;
            }).join('');

            // Auto-focus current server frame 
                    setTimeout(() => {
                if (typeof currentTimeIndex !== 'undefined' && currentTimeIndex >= 0) {
                    const currentFrameElement = container.querySelector(`[data-frame="${currentTimeIndex}"]`);
                    if (currentFrameElement) {
                        currentFrameElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        console.log(`🎯 Auto-focused frame ${currentTimeIndex}`);
                    }
                }
            }, 100);
        }

        // Form submission functions
        function submitChatMessage(tabId) {
            const tab = tabSystem.tabs.find(t => t.id === tabId);
            if (!tab || !tab.entityId) return;
            
            const messageTextarea = document.querySelector(`#controlsForm-${tabId} textarea`);
            if (!messageTextarea || !messageTextarea.value.trim()) return;
            
            const message = messageTextarea.value.trim();
            
            // Submit message to XLN system
            try {
                // First apply the input
                const result = XLN.applyServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: [{
                        entityId: tab.entityId,
                        signerId: tab.signer,
                        entityTxs: [{
                            type: 'chat',
                            data: { from: tab.signer, message: message }
                        }]
                    }]
                });
                
                // Then process until empty to complete all cascading operations
                let outputs = result.entityOutbox;
                let iterationCount = 0;
                console.log(`💬 Starting cascade processing with ${outputs.length} initial outputs`);
                
                // Debug: check proposer status
                const proposerReplicas = Array.from(xlnEnv.replicas.values()).filter(r => 
                    r.entityId === tab.entityId && r.isProposer
                );
                console.log(`💬 Found ${proposerReplicas.length} proposer replicas for entity:`, 
                    proposerReplicas.map(r => r.signerId)
                );
                
                XLN.processUntilEmpty(xlnEnv, outputs);
                
                console.log(`💬 Chat message sent and processed:`, message);
                messageTextarea.value = '';
                
                // Refresh ALL entity displays since other replicas may have been affected
                refreshAllEntityDisplays();
            } catch (error) {
                console.error('Failed to send chat message:', error);
            }
        }
        
        function submitProposal(tabId) {
            const tab = tabSystem.tabs.find(t => t.id === tabId);
            if (!tab || !tab.entityId) return;
            
            const titleInput = document.querySelector(`#controlsForm-${tabId} input[type="text"]`);
            const descTextarea = document.querySelector(`#controlsForm-${tabId} textarea`);
            if (!titleInput || !descTextarea || !titleInput.value.trim()) return;
            
            const title = titleInput.value.trim();
            const description = descTextarea.value.trim();
            const proposalText = title + (description ? ': ' + description : '');
            
            // Submit proposal to XLN system
            try {
                // First apply the input
                const result = XLN.applyServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: [{
                        entityId: tab.entityId,
                        signerId: tab.signer,
                        entityTxs: [{
                            type: 'propose',
                            data: {
                                action: { type: 'collective_message', data: { message: proposalText } },
                                proposer: tab.signer
                            }
                        }]
                    }]
                });
                
                // Then process until empty to complete all cascading operations
                XLN.processUntilEmpty(xlnEnv, result.entityOutbox);
                
                console.log('📝 Proposal sent and processed:', proposalText);
                titleInput.value = '';
                descTextarea.value = '';
                
                // Refresh ALL entity displays since other replicas may have been affected
                refreshAllEntityDisplays();
            } catch (error) {
                console.error('Failed to send proposal:', error);
            }
        }
        
        function submitVote(tabId) {
            console.log('🗳️ Submitting vote for', tabId);
            
            // Get current tab info
            const tab = tabSystem.tabs.find(t => t.id === tabId);
            if (!tab || !tab.entityId || !tab.signer) {
                alert('Invalid tab or missing entity/signer information');
                return;
            }
            
            // Get replica for this tab
            const replicaKey = `${tab.entityId}:${tab.signer}`;
            const tabReplica = xlnEnv.replicas.get(replicaKey);
            if (!tabReplica) {
                alert('Replica not found for current tab');
                return;
            }
            
            // Get form values
            const proposalId = document.getElementById(`proposalSelect-${tabId}`)?.value;
            const voteChoice = document.getElementById(`voteChoice-${tabId}`)?.value;
            const comment = document.getElementById(`voteComment-${tabId}`)?.value?.trim() || '';
            
            console.log('🗳️ Vote form data:', { proposalId, voteChoice, comment });
            
            if (!proposalId) {
                alert('Please select a proposal to vote on');
                return;
            }
            
            // Check if user already voted on this proposal
            const currentProposal = tabReplica.state.proposals.get(proposalId);
            if (currentProposal && currentProposal.votes.has(tabReplica.signerId)) {
                alert(`You have already voted on this proposal as "${currentProposal.votes.get(tabReplica.signerId)}".`);
                return;
            }
            
            if (!voteChoice) {
                alert('Please select your vote choice');
                return;
            }
            
            console.log('🗳️ Found replica:', tabReplica);
            
            // Create vote transaction
            const voteValue = voteChoice === 'yes' ? 'yes' : voteChoice === 'no' ? 'no' : 'abstain';
            const entityTx = {
                type: 'vote',
                data: {
                    proposalId,
                    voter: tabReplica.signerId,
                    choice: voteValue,
                    comment: comment || undefined // Only include comment if provided
                }
            };
            
            console.log('🗳️ Created vote transaction:', entityTx);
            console.log('🗳️ Vote from:', tabReplica.signerId, 'for entity:', tabReplica.entityId.slice(0,8) + '...');
            
            try {
                console.log('🔥 VOTE-INVOKE: Starting clean vote transaction');
                console.log('🔥 VOTE-INVOKE: Current env state:', {
                    serverTxs: xlnEnv.serverInput.serverTxs.length,
                    entityInputs: xlnEnv.serverInput.entityInputs.length,
                    height: xlnEnv.height
                });
                
                // Apply the vote transaction
                let result = XLN.applyServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: [{
                        entityId: tabReplica.entityId,
                        signerId: tabReplica.signerId,
                        entityTxs: [entityTx]
                    }]
                });
                
                console.log('🔥 VOTE-INVOKE: Initial result:', result);
                console.log('🔥 VOTE-INVOKE: EntityOutbox length:', result.entityOutbox.length);
                
                // Process until empty for full consensus cascade
                console.log('🔥 VOTE-INVOKE: Starting processUntilEmpty cascade');
                XLN.processUntilEmpty(xlnEnv, result.entityOutbox);
                
                console.log('✅ Vote submitted and processed successfully');
                
                // Log current proposal state from all replicas
                Array.from(xlnEnv.replicas.values()).forEach(r => {
                    if (r.entityId === tabReplica.entityId) {
                        console.log(`🗳️ After vote - Replica ${r.signerId} proposals:`, r.state?.proposals);
                        if (r.state?.proposals) {
                            const proposal = r.state.proposals.get ? r.state.proposals.get(proposalId) : r.state.proposals[proposalId];
                            console.log(`🗳️ After vote - Proposal ${proposalId} state in ${r.signerId}:`, proposal);
                            if (proposal?.votes) {
                                console.log(`🗳️ After vote - Votes in ${r.signerId}:`, Array.from(proposal.votes.entries ? proposal.votes.entries() : Object.entries(proposal.votes)));
                            }
                        }
                    }
                });
                
                // Clear the form
                document.getElementById(`proposalSelect-${tabId}`).value = '';
                document.getElementById(`voteChoice-${tabId}`).value = 'yes';
                document.getElementById(`voteComment-${tabId}`).value = '';
                
                // Refresh all displays
                refreshAllEntityDisplays();
                
            } catch (error) {
                console.error('❌ Failed to submit vote:', error);
                alert(`Failed to submit vote: ${error.message}`);
            }
        }

        function refreshAllEntityDisplays() {
            console.log('🔄 Refreshing all entity displays...');
            
            // Refresh all active tabs
            tabSystem.tabs.forEach(tab => {
                const replica = Array.from(xlnEnv.replicas.values()).find(r => 
                    r.entityId === tab.entityId && r.signerId === tab.signer
                );
                
                if (replica) {
                    console.log(`🔄 Refreshing tab ${tab.id} (${tab.signer}:${tab.entityId?.slice(0, 8)}...)`);
                    renderChatMessages(tab.id, replica);
                    renderProposals(tab.id, replica);
                    renderTransactionHistory(tab.id, replica);
                    
                    // Refresh controls form if it's set to vote (to update proposal dropdown)
                    const controlsDropdown = document.querySelector(`#controlsContent-${tab.id} .controls-dropdown`);
                    if (controlsDropdown && controlsDropdown.value === 'vote') {
                        updateControlsForm(tab.id, 'vote');
                    }
                }
            });
            
            console.log('✅ All entity displays refreshed');
        }

        // Remove the old voteOnProposal function since we're moving to dropdown-based voting
        async function submitEntityFormation(tabId) { 
            if (!xlnEnv) return;
            
            // Always go to current time when creating entities
            currentTimeIndex = -1;
            
            // Get form values from tab-specific elements
            const entityType = document.getElementById(`entityType-${tabId}`)?.value || 'lazy';
            const entityName = document.getElementById(`entityName-${tabId}`)?.value || 'ACME';
            const threshold = parseInt(document.getElementById(`threshold-${tabId}`)?.value) || 1;
            const selectedJurisdiction = 8545; // Default to Ethereum for now
            
            // Validation
            if (!entityName.trim()) {
                alert('Please enter an entity name');
                return;
            }
            
            // Name validation for named entities
            if (entityType === 'named') {
                if (!/^[a-zA-Z0-9_-]+$/.test(entityName)) {
                    alert('Named entity names can only contain letters, numbers, underscores, and hyphens');
                    return;
                }
                if (entityName.length < 3 || entityName.length > 32) {
                    alert('Named entity names must be between 3 and 32 characters');
                    return;
                }
            }
            
            // Get validators from tab-specific form
            const validators = [];
            const validatorData = []; // For lazy entity ID generation with weights
            const shares = {};
            let totalShares = 0;
            
            const validatorsList = document.getElementById(`validatorsList-${tabId}`);
            if (validatorsList) {
                const validatorRows = validatorsList.querySelectorAll('.validator-row-simple');
                validatorRows.forEach((row, index) => {
                    const select = row.querySelector(`select`);
                    const weightInput = row.querySelector(`input[type="number"]`);
                    if (select?.value && weightInput) {
                        const weight = parseInt(weightInput.value) || 1;
                        if (weight > 0) {
                            validators.push(select.value);
                            validatorData.push({name: select.value, weight: weight});
                            shares[select.value] = BigInt(weight);
                            totalShares += weight;
                        }
                    }
                });
            }
            
            // Validation
            if (validators.length === 0) {
                alert('Please add at least one validator');
                return;
            }
            
            if (threshold > totalShares) {
                alert(`Threshold (${threshold}) cannot be greater than total weight (${totalShares})`);
                return;
            }
            
            // Check for duplicate validator names
            const uniqueValidators = new Set(validators);
            if (uniqueValidators.size !== validators.length) {
                alert('Validator names must be unique');
                return;
            }
            
            let jurisdictionConfig = await window.getJurisdictionByPort(selectedJurisdiction);
            if (!jurisdictionConfig) {
                alert('Invalid jurisdiction selected');
                return;
            }
            
            console.log(`🏛️ Creating ${entityType} entity: ${entityName}`);
            if (jurisdictionConfig) console.log(`   Jurisdiction: ${jurisdictionConfig.name}`);
            console.log(`   Validators: ${validators.join(', ')}`);
            console.log(`   Threshold: ${threshold}/${totalShares}`);
            
            let config;
            let entityId;
            let entityNumber;
            
            try {
                // Create entity using new 3-tier system
                if (entityType === 'lazy') {
                    config = XLN.createLazyEntity(entityName, validators, BigInt(threshold), jurisdictionConfig);
                    entityId = XLN.generateLazyEntityId(validatorData, BigInt(threshold)); // Use validatorData with weights
                    console.log(`🔒 Lazy Entity ID: ${entityId}`);
                    
                } else if (entityType === 'numbered') {
                    const result = await XLN.createNumberedEntity(entityName, validators, BigInt(threshold), jurisdictionConfig);
                    config = result.config;
                    entityNumber = result.entityNumber;
                    entityId = XLN.generateNumberedEntityId(entityNumber);
                    console.log(`🔢 Numbered Entity: #${entityNumber}`);
                    console.log(`🆔 Entity ID: ${entityId}`);
                    
                    // Simulate blockchain registration
                    try {
                        const regResult = await XLN.registerNumberedEntityOnChain(config, entityName);
                        console.log(`✅ Entity registered on-chain: ${regResult.txHash}`);
                        alert(`Numbered entity #${regResult.entityNumber} created successfully!\nTransaction: ${regResult.txHash.slice(0, 10)}...`);
                    } catch (error) {
                        console.error('❌ Registration failed:', error);
                        alert(`Registration failed: ${error.message}`);
                        return;
                    }
                    
                } else if (entityType === 'named') {
                    // First create a numbered entity
                    const result = await XLN.createNumberedEntity(entityName, validators, BigInt(threshold), jurisdictionConfig);
                    config = result.config;
                    entityNumber = result.entityNumber;
                    entityId = XLN.generateNumberedEntityId(entityNumber);
                    
                    // Register the numbered entity first
                    const regResult = await XLN.registerNumberedEntityOnChain(config, entityName);
                    console.log(`🔢 Created numbered entity #${regResult.entityNumber} for name assignment`);
                    
                    // Request name assignment from admin
                    try {
                        const requestId = await XLN.requestNamedEntity(entityName, regResult.entityNumber, jurisdictionConfig);
                        console.log(`🏷️ Name assignment requested: ${requestId}`);
                        alert(`Named entity request submitted!\n\nEntity Number: #${regResult.entityNumber}\nName: "${entityName}"\nRequest ID: ${requestId}\n\nYour entity is functional now. Admin will assign the name later.`);
                    } catch (error) {
                        console.error('❌ Name request failed:', error);
                        alert(`Name request failed: ${error.message}\n\nYour numbered entity #${regResult.entityNumber} is still functional.`);
                    }
                }
                
                // Check if entity already exists with this ID
                const existingEntity = Array.from(xlnEnv.replicas.keys()).find(key => 
                    key.startsWith(entityId + ':') || key.startsWith(entityName + ':')
                );
                if (existingEntity) {
                    alert(`Entity with this configuration already exists: ${existingEntity}`);
                    return;
                }
                
                // Create server transactions for all validators using the generated entityId
                const serverTxs = validators.map((signerId, index) => ({
                    type: 'importReplica',
                    entityId: entityId, // Use the generated entity ID
                    signerId: signerId,
                    data: {
                        config: config,
                        isProposer: index === 0 // First validator is proposer
                    }
                }));
                
                // Process the server transactions (fix: applyServerInput returns {entityOutbox, mergedInputs})
                let result = XLN.applyServerInput(xlnEnv, {
                    serverTxs: serverTxs,
                    entityInputs: []
                });
                let outputs = result.entityOutbox;
                
                // Process outputs until empty
                while (outputs && outputs.length > 0) {
                    const newResult = XLN.applyServerInput(xlnEnv, {
                        serverTxs: [],
                        entityInputs: outputs
                    });
                    outputs = newResult.entityOutbox;
                }
                
                // Perform jurisdiction registration if selected
                if (jurisdictionConfig) {
                    console.log(`🏛️  Entity "${entityName}" configured with jurisdiction "${jurisdictionConfig.name}"`);
                    console.log(`    EntityProvider: ${jurisdictionConfig.entityProviderAddress}`);
                    console.log(`    Depository: ${jurisdictionConfig.depositoryAddress}`);
                    console.log(`    Chain ID: ${jurisdictionConfig.chainId}`);
                    console.log(`    📝 Note: Full blockchain registration will be implemented in next iteration`);
                }
                
                // Success feedback - only for lazy entities (numbered/named have specific alerts)
                if (entityType === 'lazy') {
                    const jurisdictionMessage = jurisdictionConfig 
                        ? `\n🏛️ Jurisdiction: ${jurisdictionConfig.name}` 
                        : '\n⚠️ Warning: No jurisdiction selected';
                    
                    alert(`✅ Entity "${entityName}" created successfully!${jurisdictionMessage}\n\nValidators: ${validators.join(', ')}\nThreshold: ${threshold}/${totalShares}`);
                }
                
                // Refresh all entity displays
                renderEntityPanels();
                
            } catch (error) {
                console.error('Failed to create entity:', error);
                alert(`Failed to create entity: ${error.message}`);
            }
        }
        
        function addValidatorToTab(tabId) {
            const validatorsList = document.getElementById(`validatorsList-${tabId}`);
            if (!validatorsList) return;
            
            const validatorCount = validatorsList.querySelectorAll('.validator-row-simple').length;
            const newRow = document.createElement('div');
            newRow.className = 'validator-row-simple';
            newRow.setAttribute('data-validator-id', validatorCount);
            
            newRow.innerHTML = `
                <select class="form-input" id="validator${validatorCount}-${tabId}" onchange="updateTabQuorumHash('${tabId}')">
                    <option value="">Select signer...</option>
                    <option value="alice.eth">alice.eth</option>
                    <option value="bob.eth">bob.eth</option>
                    <option value="carol.eth">carol.eth</option>
                </select>
                <input type="number" class="form-input" style="width: 60px; margin-left: 8px;" placeholder="1" value="1" min="1" oninput="updateTabQuorumHash('${tabId}')">
                <button type="button" class="form-button" style="margin-left: 8px; background: #f14c4c; padding: 4px 8px;" onclick="this.parentElement.remove(); updateTabQuorumHash('${tabId}')">❌</button>
            `;
            
            validatorsList.appendChild(newRow);
        }
        
        function onEntityTypeChangeTab(tabId) {
            // Update entity type info or preview if needed
            console.log('Entity type changed for tab:', tabId);
        }
        
        function updateThresholdTab(tabId) {
            const thresholdInput = document.getElementById(`threshold-${tabId}`);
            const thresholdDisplay = document.getElementById(`thresholdValue-${tabId}`);
            if (thresholdInput && thresholdDisplay) {
                thresholdDisplay.textContent = thresholdInput.value;
            }
            
            // Update the quorum hash and entity ID preview
            updateTabQuorumHash(tabId);
        }
        
        function updateTabQuorumHash(tabId) {
            const entityType = document.getElementById(`entityType-${tabId}`)?.value || 'lazy';
            const entityName = document.getElementById(`entityName-${tabId}`)?.value || 'ACME';
            const threshold = parseInt(document.getElementById(`threshold-${tabId}`)?.value) || 1;
            
            // Get validators with weights
            const validatorData = [];
            const validatorsList = document.getElementById(`validatorsList-${tabId}`);
            if (validatorsList) {
                const validatorRows = validatorsList.querySelectorAll('.validator-row-simple');
                validatorRows.forEach((row, index) => {
                    const select = row.querySelector(`select`);
                    const weightInput = row.querySelector(`input[type="number"]`);
                    if (select?.value && weightInput) {
                        const weight = parseInt(weightInput.value) || 1;
                        if (weight > 0) {
                            validatorData.push({name: select.value, weight: weight});
                        }
                    }
                });
            }
            
            // Update total weight display
            const totalWeight = validatorData.reduce((sum, v) => sum + v.weight, 0);
            const totalWeightDisplay = document.getElementById(`totalWeight-${tabId}`);
            if (totalWeightDisplay) {
                totalWeightDisplay.textContent = totalWeight;
            }
            
            // Update threshold max
            const thresholdInput = document.getElementById(`threshold-${tabId}`);
            if (thresholdInput) {
                thresholdInput.max = totalWeight;
                if (parseInt(thresholdInput.value) > totalWeight) {
                    thresholdInput.value = totalWeight;
                    const thresholdDisplay = document.getElementById(`thresholdValue-${tabId}`);
                    if (thresholdDisplay) thresholdDisplay.textContent = totalWeight;
                }
            }
            
            // Generate quorum hash and entity ID preview
            try {
                if (validatorData.length > 0) {
                    const quorumHashDiv = document.getElementById(`quorumHash-${tabId}`);
                    const expectedEntityIdDiv = document.getElementById(`expectedEntityId-${tabId}`);
                    
                    if (entityType === 'lazy' && quorumHashDiv && expectedEntityIdDiv) {
                        // Generate entity ID for lazy entities using weights
                        const entityId = XLN.generateLazyEntityId(validatorData, BigInt(threshold));
                        const quorumData = {
                            validators: validatorData.slice().sort((a, b) => a.name.localeCompare(b.name)),
                            threshold: threshold.toString()
                        };
                        const quorumHash = XLN.hashBoard(JSON.stringify(quorumData));
                        
                        quorumHashDiv.textContent = quorumHash;
                        expectedEntityIdDiv.textContent = entityId;
                    } else if (quorumHashDiv && expectedEntityIdDiv) {
                        quorumHashDiv.textContent = 'Configure validators to see quorum hash';
                        expectedEntityIdDiv.textContent = 'Configure validators to see entity ID';
                    }
                }
            } catch (error) {
                console.error('Error updating quorum hash:', error);
            }
        }

        // Run demo and refresh all UI
        async function runDemoAndRefresh() {
            if (!window.xlnEnv) {
                console.error('❌ XLN environment not loaded');
                return;
            }

            try {
                console.log('🚀 Running demo and refreshing UI...');
                
                // Run the demo
                await XLN.runDemoWrapper(window.xlnEnv);
                
                // Refresh all entity panels
                renderEntityPanels();
                
                // Update time machine if it exists
                if (typeof updateTimeMachine === 'function') {
                    updateTimeMachine();
                }
                
                console.log('✅ Demo completed and UI refreshed!');
            } catch (error) {
                console.error('❌ Failed to run demo:', error);
            }
        }
        
        function submitJTx(tabId) { console.log('J-tx submitted for', tabId); }
        function submitSettingsUpdate(tabId) { console.log('Settings update submitted for', tabId); }

        // Dropdown mode management
        let dropdownMode = localStorage.getItem('xlnDropdownMode') || 'signer-first'; // 'signer-first' or 'entity-first'

        function toggleDropdownMode() {
            dropdownMode = dropdownMode === 'signer-first' ? 'entity-first' : 'signer-first';
            localStorage.setItem('xlnDropdownMode', dropdownMode);
            
            // Update button tooltip
            const btn = document.getElementById('dropdownModeBtn');
            if (btn) {
                btn.title = dropdownMode === 'signer-first' 
                    ? 'Current: Jurisdiction→Signer→Entity (Click for Entity→Signers)'
                    : 'Current: Jurisdiction→Entity→Signers (Click for Signer→Entity)';
            }
            
            // Refresh all dropdowns
            document.querySelectorAll('[id^="dropdownContent-"]').forEach(dropdown => {
                const tabId = dropdown.id.replace('dropdownContent-', '');
                populateTabDropdown(tabId);
            });
            
            console.log(`🔄 Dropdown mode changed to: ${dropdownMode}`);
        }

        // Initialize component states on page load
        loadComponentStates();

        // Initialize dropdown mode button tooltip
        const btn = document.getElementById('dropdownModeBtn');
        if (btn) {
            btn.title = dropdownMode === 'signer-first' 
                ? 'Current: Jurisdiction→Signer→Entity (Click for Entity→Signers)'
                : 'Current: Jurisdiction→Entity→Signers (Click for Signer→Entity)';
        }

        // Expose tab functions globally for onclick handlers
        window.addTab = addTab;
        window.closeTab = closeTab;
        window.setActiveTab = setActiveTab;
        window.toggleTabDropdown = toggleTabDropdown;
        window.handleTabDropdownSearch = handleTabDropdownSearch;
        window.toggleComponent = toggleComponent;
        window.updateControlsForm = updateControlsForm;
        window.switchToValidator = switchToValidator;
        window.addValidatorToTab = addValidatorToTab;
        window.onEntityTypeChangeTab = onEntityTypeChangeTab;
        window.runDemoAndRefresh = runDemoAndRefresh;
        window.toggleDropdownMode = toggleDropdownMode;
        window.updateThresholdTab = updateThresholdTab;
        window.updateTabQuorumHash = updateTabQuorumHash;
        window.submitEntityFormation = submitEntityFormation;

        window.XLN = XLN;

        // Auto-reload detection using HTTP polling
        async function checkForChanges() {
            try {
                const response = await fetch('./dist/server.js', { method: 'HEAD' });
                const modified = response.headers.get('last-modified');
                
                if (lastModified && modified !== lastModified) {
                    console.log('🔄 Server file changed, triggering reload...');
                    const indicator = document.getElementById('reloadIndicator');
                    if (indicator) {
                        indicator.style.display = 'block';
                        indicator.classList.add('show');
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    }
                }
                lastModified = modified;
            } catch (error) {
                console.log('Auto-reload check failed:', error);
            }
        }
        


        // Start auto-reload checking (every 10 seconds - much less frequent)
        setInterval(checkForChanges, 10000);

        // Environment initialization is now handled in main() function

        // Populate entity filter dropdown - OBSOLETE: Now handled by unified dropdown
        function populateEntityFilter() {
            // No longer needed - unified dropdown handles entity selection
            return;
        }

        // Cache for avoiding unnecessary re-renders
        let lastRenderState = null;

        // Render entities - each replica as separate card
        function renderEntities() {
            if (!xlnEnv) return;
            
            const entitiesGrid = document.getElementById('entitiesGrid');
            // Use unified dropdown state instead of old entitySelector
            // Note: This function is mostly obsolete with the new unified dropdown system
            const selectedEntity = (typeof dropdownData !== 'undefined' && dropdownData) ? dropdownData.selectedEntity : null;
            
            // Quick change detection
            const currentState = {
                selectedEntity,
                timeIndex: currentTimeIndex,
                envHeight: xlnEnv.height,
                replicasCount: xlnEnv.replicas.size
            };
            
            // Don't re-render if nothing important changed
            if (lastRenderState && 
                lastRenderState.selectedEntity === currentState.selectedEntity &&
                lastRenderState.timeIndex === currentState.timeIndex &&
                lastRenderState.envHeight === currentState.envHeight &&
                lastRenderState.replicasCount === currentState.replicasCount) {
                return; // Skip re-render
            }
            
            lastRenderState = currentState;
            
            // Clear existing content
            entitiesGrid.innerHTML = '';
            
            // Determine which state to show
            let replicasToShow, serverInputToShow, snapshot;
            let isHistorical = false;
            
            if (currentTimeIndex >= 0) {
                snapshot = XLN.getSnapshot(currentTimeIndex);
                if (snapshot) {
                    replicasToShow = snapshot.replicas;
                    serverInputToShow = snapshot.serverInput;
                    isHistorical = true;
                }
            }
            
            if (!replicasToShow) {
                replicasToShow = xlnEnv.replicas;
                // Get the most recent server input from history
                const history = XLN.getHistory();
                if (history.length > 0) {
                    serverInputToShow = history[history.length - 1].serverInput;
                }
                currentTimeIndex = -1; // Reset to current if snapshot not found
            }
            
            // Update entity filter dropdown
            populateEntityFilter();
            
            // Render server input section
            renderServerInput(serverInputToShow, isHistorical);
            
            // Get server outputs from snapshot 
            let serverOutputsToShow = [];
            if (isHistorical && snapshot) {
                serverOutputsToShow = snapshot.serverOutputs || [];
            } else if (!isHistorical) {
                // For current time, get outputs from most recent snapshot
                const history = XLN.getHistory();
                if (history.length > 0) {
                    serverOutputsToShow = history[history.length - 1].serverOutputs || [];
                }
            }
            
            // Render server output section
            renderServerOutput(serverOutputsToShow, isHistorical);
            
            // Filter replicas based on selection
            const filteredReplicas = new Map();
            replicasToShow.forEach((replica, key) => {
                if (selectedEntity === 'all' || replica.entityId === selectedEntity) {
                    filteredReplicas.set(key, replica);
                }
            });
            
            // Render each replica as a separate card
            filteredReplicas.forEach((replica, key) => {
                const entityCard = document.createElement('div');
                entityCard.className = 'entity-card';
                
                const config = replica.state.config;
                // Mode class removed - we don't show gossip/proposer distinction
                
                // Calculate total voting power
                const totalShares = Object.values(config.shares).reduce((sum, val) => sum + val, BigInt(0));
                const thresholdPercent = ((Number(config.threshold) / Number(totalShares)) * 100).toFixed(1);
                
                const isProposer = replica.isProposer;
                const shares = config.shares[replica.signerId] || BigInt(0);
                const sharePercent = ((Number(shares) / Number(totalShares)) * 100).toFixed(1);
                
                // Generate display data (reduced logging)
                let entityAvatar = '';
                let signerAvatar = '';
                
                try {
                    entityAvatar = XLN.generateEntityAvatar ? XLN.generateEntityAvatar(replica.entityId) : '';
                    signerAvatar = XLN.generateSignerAvatar ? XLN.generateSignerAvatar(replica.signerId) : '';
                } catch (error) {
                    console.error('❌ Avatar generation error:', error);
                }
                
                // Entity display using the proper format function
                const entityDisplay = XLN.formatEntityDisplay ? XLN.formatEntityDisplay(replica.entityId) : replica.entityId;
                
                // Signer display with name resolution (get clean name without emoji)
                const signerInfo = XLN.getSignerDisplayInfo ? XLN.getSignerDisplayInfo(replica.signerId) : { name: replica.signerId };
                const signerName = signerInfo.name || replica.signerId;

                // Create wallet-style structure
                const cardId = `card-${replica.entityId.slice(-4)}-${replica.signerId}`;
                entityCard.innerHTML = `
                    <div class="entity-header">
                        <div class="entity-title" id="title-${replica.entityId.slice(-4)}-${replica.signerId}">
                        </div>
                        <div class="entity-controls">
                        <div class="entity-mode ${modeClass}">${config.mode}</div>
                            <div class="expand-indicator">
                                <span class="expand-icon">▼</span>
                    </div>
                        </div>
                    </div>
                    <div class="entity-metrics">
                        <div class="metric-item">
                            <div class="metric-value">${sharePercent}%</div>
                            <div class="metric-label">Voting Power</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${replica.state.messages.length}</div>
                            <div class="metric-label">Messages</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${replica.state.proposals.size}</div>
                            <div class="metric-label">Proposals</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${replica.state.height}</div>
                            <div class="metric-label">Height</div>
                        </div>
                    </div>
                    
                    <!-- Expandable Details Section -->
                    <div class="entity-details" id="details-${cardId}" style="display: none;">
                        <div class="entity-identity">
                            <strong>Entity ID:</strong> <span style="word-break: break-all; color: #9d9d9d; font-family: monospace;">${replica.entityId}</span><br>
                            <strong>Signer:</strong> <span style="color: #9d9d9d; font-family: monospace;">${replica.signerId}</span><br>
                        <strong>Role:</strong> ${isProposer ? '👑 Proposer' : '✅ Validator'}<br>
                            <strong>Consensus:</strong> ${config.threshold}/${config.validators.length} threshold
                    </div>
                    
                    ${config.jurisdiction ? `
                            <div class="jurisdiction-info">
                            <strong>🏛️ Jurisdiction:</strong> ${config.jurisdiction.name}<br>
                                <small style="color: #9d9d9d;">
                                    <strong>Provider:</strong> ${config.jurisdiction.entityProviderAddress?.slice(0,10)}...<br>
                                    <strong>Depository:</strong> ${config.jurisdiction.depositoryAddress?.slice(0,10)}...
                            </small>
                        </div>
                        ` : ''}
                        
                        <div class="replica-stats">
                            <strong>📊 State Details:</strong><br>
                            <strong>📝 Mempool:</strong> ${replica.mempool.length} txs<br>
                            <strong>🔢 Nonces:</strong> ${replica.state.nonces.size || 'none'}<br>
                            ${replica.proposal ? `<strong style="color: #5DADE2;">📝 Proposing Block ${replica.proposal.height}</strong><br>` : ''}
                            ${replica.lockedFrame ? `<strong style="color: #f39c12;">🔒 Locked on Block ${replica.lockedFrame.height}</strong><br>` : ''}
                    </div>
                    
                        ${replica.state.messages.length > 0 ? `
                    <div class="messages-section">
                                <strong>💬 Recent Messages:</strong>
                                ${replica.state.messages.slice(-3).map(msg => `
                                    <div class="message">${msg}</div>
                                `).join('')}
                                ${replica.state.messages.length > 3 ? `<small>...and ${replica.state.messages.length - 3} more</small>` : ''}
                                </div>
                        ` : ''}
                    
                    ${replica.state.proposals.size > 0 ? `
                            <div class="proposals-section">
                                <strong>🗳️ Active Proposals:</strong>
                                ${Array.from(replica.state.proposals.values()).slice(0, 2).map(proposal => {
                                    const yesVotes = Array.from(proposal.votes.entries()).filter(([_, vote]) => vote === true).length;
                                    const noVotes = Array.from(proposal.votes.entries()).filter(([_, vote]) => vote === false).length;
                                    return `
                                    <div class="proposal">
                                        <strong>"${proposal.action.data.message}"</strong><br>
                                        <small>✅ ${yesVotes} Yes, ❌ ${noVotes} No • ${proposal.proposer}</small>
                                </div>`;
                            }).join('')}
                                ${replica.state.proposals.size > 2 ? `<small>...and ${replica.state.proposals.size - 2} more</small>` : ''}
                        </div>
                    ` : ''}
                    </div>
                `;
                entityCard.dataset.cardId = cardId;
                entityCard.onclick = () => toggleEntityDetails(cardId);
                
                // Now populate the title with DOM manipulation to avoid HTML escaping
                const titleDiv = entityCard.querySelector(`#title-${replica.entityId.slice(-4)}-${replica.signerId}`);
                
                // Add entity avatar
                if (entityAvatar) {
                    const entityImg = document.createElement('img');
                    entityImg.src = entityAvatar;
                    entityImg.alt = 'Entity Avatar';
                    entityImg.style.width = '24px';
                    entityImg.style.height = '24px';
                    entityImg.style.borderRadius = '4px';
                    titleDiv.appendChild(entityImg);
                } else {
                    titleDiv.appendChild(document.createTextNode('🏢'));
                }
                
                // Add entity name
                const entitySpan = document.createElement('span');
                entitySpan.textContent = `Entity #${entityDisplay}:`;
                titleDiv.appendChild(entitySpan);
                
                // Add signer avatar
                if (signerAvatar) {
                    const signerImg = document.createElement('img');
                    signerImg.src = signerAvatar;
                    signerImg.alt = 'Signer Avatar';
                    signerImg.style.width = '20px';
                    signerImg.style.height = '20px';
                    signerImg.style.borderRadius = '50%';
                    titleDiv.appendChild(signerImg);
                } else {
                    titleDiv.appendChild(document.createTextNode('👤'));
                }
                
                // Add signer name
                const signerSpan = document.createElement('span');
                signerSpan.textContent = signerName;
                titleDiv.appendChild(signerSpan);
                
                // Add historical indicator
                if (isHistorical) {
                    titleDiv.appendChild(document.createTextNode('🕰️'));
                }
                
                // Append card to grid
                entitiesGrid.appendChild(entityCard);
            });
            
            // Update time machine UI
            updateTimeMachineUI();
        };
        
        // Render server input section
        function renderServerInput(serverInput, isHistorical) {
            const historySection = document.getElementById('historyIOSection');
            const container = document.getElementById('serverIOContainer');
            const status = document.getElementById('serverInputStatus');
            const serverTxsList = document.getElementById('serverTxsList');
            const entityInputsList = document.getElementById('entityInputsList');
            
            // Show history section when there's data
            if (serverInput && (serverInput.serverTxs.length || serverInput.entityInputs.length)) {
                historySection.style.display = 'block';
            }
            
            // Always show the container
            container.style.display = 'grid';
            if (serverInput && (serverInput.serverTxs.length || serverInput.entityInputs.length)) {
                status.textContent = isHistorical ? ' 🕰️ Historical' : ' ⚡ Current';
            } else {
                status.textContent = '';
            }
            
            // Always render the input data (even if empty for consistency)
            if (!serverInput) {
                serverTxsList.innerHTML = '<div class="no-inputs">No server transactions</div>';
                entityInputsList.innerHTML = '<div class="no-inputs">No entity inputs</div>';
                return;
            }
            
            // Render server transactions
            if (serverInput.serverTxs.length > 0) {
                serverTxsList.innerHTML = serverInput.serverTxs.map(tx => {
                    let details = `<div class="input-item">
                        <strong>🖥️ ${tx.type}</strong>: ${tx.entityId}:${tx.signerId}
                        ${tx.data.isProposer ? ' (👑 Proposer)' : ' (✅ Validator)'}`;
                    
                    if (tx.data.config) {
                        details += `<br>⚙️ <strong>Config:</strong>
                            <br>  • Mode: ${tx.data.config.mode}
                            <br>  • Threshold: ${tx.data.config.threshold}
                            <br>  • Validators: [${tx.data.config.validators.join(', ')}]
                            <br>  • Voting Shares:`;
                        
                        for (const [validator, shares] of Object.entries(tx.data.config.shares)) {
                            details += `<br>    ${validator}: ${shares} shares`;
                        }
                    }
                    
                    details += `</div>`;
                    return details;
                }).join('');
            } else {
                serverTxsList.innerHTML = '<div class="no-inputs">No server transactions</div>';
            }
            
            // Show individual entity inputs (unmerged) to see all validators
            const individualInputs = serverInput.entityInputs || [];
            
            // Render entity inputs (individual)
            if (individualInputs.length > 0) {
                entityInputsList.innerHTML = individualInputs.map(input => {
                    let details = `<div class="input-item">
                        <strong>${input.entityId}:${input.signerId}</strong>`;
                    
                    // Show transactions in detail
                    if (input.entityTxs && input.entityTxs.length > 0) {
                        details += `<br>📝 <strong>${input.entityTxs.length} transactions:</strong>`;
                        input.entityTxs.forEach((tx, i) => {
                            if (tx.type === 'chat') {
                                details += `<br>  ${i+1}. 💬 Chat: "${tx.data.message}" (from: ${tx.data.from})`;
                            } else if (tx.type === 'propose') {
                                details += `<br>  ${i+1}. 📝 Propose: "${tx.data.action.data.message}" (by: ${tx.data.proposer})`;
                            } else if (tx.type === 'vote') {
                                details += `<br>  ${i+1}. 🗳️ Vote: ${tx.data.choice} on ${tx.data.proposalId.slice(0,12)}... (by: ${tx.data.voter})`;
                            }
                        });
                    }
                    
                                    // Show proposed frame details
                if (input.proposedFrame) {
                    // Distinguish between new proposals and commit notifications
                    const isCommitNotification = input.precommits && input.precommits.size > 0;
                    const frameType = isCommitNotification ? "📋 <strong>Commit Notification:</strong>" : "🎯 <strong>Proposed Frame:</strong>";
                    
                    details += `<br>${frameType}
<br>  • Hash: ${input.proposedFrame.hash}
<br>  • Height: ${input.proposedFrame.height}
<br>  • Transactions: ${input.proposedFrame.txs.length}
<br>  • Signatures: ${input.proposedFrame.signatures.size}`;
                }
                    
                    // Show precommits details
                    if (input.precommits && input.precommits.size > 0) {
                        details += `<br>✅ <strong>${input.precommits.size} precommits from:</strong>`;
                        for (const [signerId, signature] of input.precommits) {
                            details += `<br>  • ${signerId}: ${signature.slice(0,16)}...`;
                        }
                    }
                    
                    details += `</div>`;
                    return details;
                }).join('');
            } else {
                entityInputsList.innerHTML = '<div class="no-inputs">No entity inputs</div>';
            }
        }
        
        // Render server output section
        function renderServerOutput(serverOutputs, isHistorical) {
            const container = document.getElementById('serverIOContainer');
            const status = document.getElementById('serverOutputStatus');
            const entityOutputsList = document.getElementById('entityOutputsList');
            
            // Container is already shown by renderServerInput, just update status
            if (serverOutputs && serverOutputs.length) {
                status.textContent = isHistorical ? ' 🕰️ Historical' : ' ⚡ Current';
            } else {
                status.textContent = '';
            }
            
            // Always render the output data (even if empty for consistency)
            if (!serverOutputs || !serverOutputs.length) {
                entityOutputsList.innerHTML = '<div class="no-inputs">No entity outputs</div>';
                return;
            }
            
            // Render entity outputs
            entityOutputsList.innerHTML = serverOutputs.map((output, index) => {
                let details = `<div class="input-item">
                    <strong>📤 ${index + 1}. → ${output.signerId}</strong>`;
                
                // Show transactions being sent
                if (output.entityTxs && output.entityTxs.length > 0) {
                    details += `<br>📝 <strong>${output.entityTxs.length} transactions:</strong>`;
                    output.entityTxs.forEach((tx, i) => {
                        if (tx.type === 'chat') {
                            details += `<br>  ${i+1}. 💬 Chat: "${tx.data.message}" (from: ${tx.data.from})`;
                        } else if (tx.type === 'propose') {
                            details += `<br>  ${i+1}. 📝 Propose: "${tx.data.action.data.message}" (by: ${tx.data.proposer})`;
                        } else if (tx.type === 'vote') {
                            details += `<br>  ${i+1}. 🗳️ Vote: ${tx.data.choice} on ${tx.data.proposalId.slice(0,12)}... (by: ${tx.data.voter})`;
                        }
                    });
                }
                
                // Show proposed frame being sent
                if (output.proposedFrame) {
                    const isCommitNotification = output.precommits && output.precommits.size > 0;
                    const frameType = isCommitNotification ? "📋 <strong>Commit Notification:</strong>" : "🎯 <strong>Proposed Frame:</strong>";
                    
                    details += `<br>${frameType}
<br>  • Hash: ${output.proposedFrame.hash}
<br>  • Height: ${output.proposedFrame.height}
<br>  • Transactions: ${output.proposedFrame.txs.length}
<br>  • Signatures: ${output.proposedFrame.signatures.size}`;
                }
                
                // Show precommits being sent
                if (output.precommits && output.precommits.size > 0) {
                    details += `<br>✅ <strong>${output.precommits.size} precommits:</strong>`;
                    for (const [signerId, signature] of output.precommits) {
                        details += `<br>  • ${signerId}: ${signature.slice(0,16)}...`;
                    }
                }
                
                details += `</div>`;
                return details;
            }).join('');
        }
        
        // Merge entity inputs for display (same logic as server)
        function mergeEntityInputsForDisplay(entityInputs) {
            if (!entityInputs || entityInputs.length === 0) return [];
            
            const merged = new Map();
            
            for (const input of entityInputs) {
                const key = `${input.entityId}:${input.signerId}`;
                const existing = merged.get(key);
                
                if (existing) {
                    // Merge entityTxs
                    if (input.entityTxs?.length) {
                        existing.entityTxs = [...(existing.entityTxs || []), ...input.entityTxs];
                    }
                    
                    // Merge precommits
                    if (input.precommits?.size) {
                        if (!existing.precommits) existing.precommits = new Map();
                        for (const [key, value] of input.precommits) {
                            existing.precommits.set(key, value);
                        }
                    }
                    
                    // Take latest proposedFrame
                    if (input.proposedFrame) {
                        existing.proposedFrame = input.proposedFrame;
                    }
                } else {
                    merged.set(key, {
                        ...input,
                        precommits: input.precommits ? new Map(input.precommits) : undefined
                    });
                }
            }
            
            return Array.from(merged.values());
        }

        // Update time machine UI
        function updateTimeMachineUI() {
            const history = XLN.getHistory();
            const timeSlider = document.getElementById('timeSlider');
            const timeInfo = document.getElementById('timeInfo');
            const sliderContainer = document.querySelector('.time-slider-container');
            
            if (history.length === 0) {
                timeSlider.disabled = true;
                timeSlider.max = 0;
                timeInfo.innerHTML = '<span>⏰ No history yet</span><span></span><span></span>';
                timeInfo.className = 'time-info-compact';
                sliderContainer.style.setProperty('--progress', '0%');
                return;
            }
            
            timeSlider.disabled = false;
            const maxMeaningfulIndex = Math.max(0, history.length - 1);
            timeSlider.max = maxMeaningfulIndex + 1; // +1 to include live position
            
            let sliderValue, progressPercent;
            
            if (currentTimeIndex === -1) {
                // Current time (live)
                sliderValue = maxMeaningfulIndex + 1;
                progressPercent = 100;
                timeInfo.innerHTML = `
                    <span>⏰ LIVE</span>
                    <span>Height: ${xlnEnv.height}</span>
                    <span>${history.length} snapshots</span>
                `;
                timeInfo.className = 'time-info-compact current';
            } else {
                // Historical time
                sliderValue = currentTimeIndex;
                const sliderMax = maxMeaningfulIndex + 1;
                progressPercent = sliderMax > 0 ? (currentTimeIndex / sliderMax) * 100 : 0;
                const snapshot = history[currentTimeIndex];
                timeInfo.innerHTML = `
                    <span>📸 ${currentTimeIndex + 1}/${history.length}</span>
                    <span>Height: ${snapshot.height}</span>
                    <span>${snapshot.description}</span>
                `;
                timeInfo.className = 'time-info-compact';
            }
            
            timeSlider.value = sliderValue;
            sliderContainer.style.setProperty('--progress', `${progressPercent}%`);
        }

        // Interactive control functions
        // Removed populateReplicaSelect - replaced by new panel-based system



        // Removed populateProposalSelect - replaced by new panel-based proposal system

        function executeAction() {
            if (!xlnEnv) return;
            
            // Always go to current time when executing actions
            currentTimeIndex = -1;
            
            const replicaKey = document.getElementById('replicaSelect').value;
            const action = 'chat'; // Default to chat since we removed the dropdown
            const replica = xlnEnv.replicas.get(replicaKey);
            
            if (!replica) {
                alert('Please select a valid replica');
                return;
            }
            
            let entityTx;
            
            if (action === 'chat') {
                const message = document.getElementById('inputField').value.trim();
                if (!message) {
                    alert('Please enter a message');
                    return;
                }
                

                
                entityTx = {
                    type: 'chat',
                    data: { from: replica.signerId, message }
                };
                
                document.getElementById('inputField').value = '';
            } else if (action === 'propose') {
                const proposalText = document.getElementById('proposalField').value.trim();
                if (!proposalText) {
                    alert('Please enter a proposal');
                    return;
                }
                
                entityTx = {
                    type: 'propose',
                    data: {
                        action: { type: 'collective_message', data: { message: proposalText } },
                        proposer: replica.signerId
                    }
                };
                
                document.getElementById('proposalField').value = '';
            } else if (action === 'vote') {
                const proposalId = document.getElementById('proposalSelect').value;
                const voteChoice = document.getElementById('voteChoice').value;
                
                if (!proposalId) {
                    alert('No proposal selected or no pending proposals');
                    return;
                }
                
                entityTx = {
                    type: 'vote',
                    data: {
                        proposalId,
                        voter: replica.signerId,
                        choice: voteChoice
                    }
                };
            }
            
            // Send transaction to the replica
            let outputs = XLN.applyServerInput(xlnEnv, {
                serverTxs: [],
                entityInputs: [{
                    entityId: replica.entityId,
                    signerId: replica.signerId,
                    entityTxs: [entityTx]
                }]
            });
            
            // Process outputs until empty
            while (outputs.length > 0) {
                const newOutputs = XLN.applyServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: outputs
                });
                outputs.splice(0, outputs.length, ...newOutputs);
            }
            
            renderEntities();

        }

        // Make functions global
        window.executeAction = executeAction;
        // Removed populateReplicaSelect global assignment

        // Simulation functions
        window.simulateChat = () => {
            if (!xlnEnv) return;
            
            // Always go to current time when simulating
            currentTimeIndex = -1;
            
            const entities = ['chat', 'trading', 'governance'];
            const users = ['alice', 'bob', 'carol', 'david', 'eve'];
            const messages = [
                'Hello everyone!',
                'How is the consensus working?',
                'This is a test message',
                'Great to see multi-entity support',
                'Byzantine fault tolerance rocks!'
            ];
            
            const entityId = entities[Math.floor(Math.random() * entities.length)];
            const from = users[Math.floor(Math.random() * users.length)];
            const message = messages[Math.floor(Math.random() * messages.length)];
            
            const outputs = XLN.applyServerInput(xlnEnv, {
                serverTxs: [],
                entityInputs: [{
                    entityId,
                    signerId: 'alice', // Always send to alice as proposer
                    entityTxs: [{
                        type: 'chat',
                        data: { from, message }
                    }]
                }]
            });
            
            // Process outputs
            while (outputs.length > 0) {
                const newOutputs = XLN.applyServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: outputs
                });
                outputs.splice(0, outputs.length, ...newOutputs);
            }
            
            renderEntities();
        };

        window.simulateProposal = () => {
            if (!xlnEnv) return;
            
            // Always go to current time when simulating
            currentTimeIndex = -1;
            
            const entities = ['trading', 'governance']; // Skip chat for proposals
            const proposers = ['alice', 'bob', 'carol'];
            const proposals = [
                'Increase transaction fees',
                'Update consensus parameters',
                'Add new validator node',
                'Implement new governance rules',
                'Emergency protocol update'
            ];
            
            const entityId = entities[Math.floor(Math.random() * entities.length)];
            const proposer = proposers[Math.floor(Math.random() * proposers.length)];
            const message = proposals[Math.floor(Math.random() * proposals.length)];
            
            const outputs = XLN.applyServerInput(xlnEnv, {
                serverTxs: [],
                entityInputs: [{
                    entityId,
                    signerId: 'alice',
                    entityTxs: [{
                        type: 'propose',
                        data: {
                            action: {
                                type: 'collective_message',
                                data: { message }
                            },
                            proposer
                        }
                    }]
                }]
            });
            
            // Process outputs
            while (outputs.length > 0) {
                const newOutputs = XLN.applyServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: outputs
                });
                outputs.splice(0, outputs.length, ...newOutputs);
            }
            
            renderEntities();
        };

        window.simulateVoting = () => {
            if (!xlnEnv) return;
            
            // Always go to current time when simulating
            currentTimeIndex = -1;
            
            // Find entities with pending proposals
            const entitiesWithProposals = [];
            xlnEnv.replicas.forEach((replica, key) => {
                if (replica.state.proposals.size > 0) {
                    replica.state.proposals.forEach((proposal, proposalId) => {
                        if (proposal.status === 'pending') {
                            entitiesWithProposals.push({
                                entityId: replica.entityId,
                                proposalId,
                                proposal
                            });
                        }
                    });
                }
            });
            
            if (entitiesWithProposals.length === 0) {
                alert('No pending proposals found. Create a proposal first!');
                return;
            }
            
            const target = entitiesWithProposals[Math.floor(Math.random() * entitiesWithProposals.length)];
            const voters = ['alice', 'bob', 'carol', 'david', 'eve'];
            const voter = voters[Math.floor(Math.random() * voters.length)];
            const choice = Math.random() > 0.3 ? 'yes' : 'no'; // 70% yes, 30% no
            
            const outputs = XLN.applyServerInput(xlnEnv, {
                serverTxs: [],
                entityInputs: [{
                    entityId: target.entityId,
                    signerId: 'alice',
                    entityTxs: [{
                        type: 'vote',
                        data: {
                            proposalId: target.proposalId,
                            voter,
                            choice
                        }
                    }]
                }]
            });
            
            // Process outputs
            while (outputs.length > 0) {
                const newOutputs = XLN.applyServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: outputs
                });
                outputs.splice(0, outputs.length, ...newOutputs);
            }
            
            renderEntities();
        };

        window.simulateStress = () => {
            if (!xlnEnv) return;
            
            // Always go to current time when simulating
            currentTimeIndex = -1;
            
            // Send multiple transactions across different entities
            const entities = ['chat', 'trading', 'governance'];
            const users = ['alice', 'bob', 'carol', 'david', 'eve'];
            const txCount = 5 + Math.floor(Math.random() * 10); // 5-15 transactions
            
            const entityInputs = entities.map(entityId => ({
                entityId,
                signerId: 'alice',
                entityTxs: Array.from({ length: txCount }, (_, i) => ({
                    type: 'chat',
                    data: {
                        from: users[i % users.length],
                        message: `Stress test message ${i + 1} for ${entityId}`
                    }
                }))
            }));
            
            const outputs = XLN.applyServerInput(xlnEnv, {
                serverTxs: [],
                entityInputs
            });
            
            // Process outputs
            while (outputs.length > 0) {
                const newOutputs = XLN.applyServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: outputs
                });
                outputs.splice(0, outputs.length, ...newOutputs);
            }
            
            renderEntities();
        };

        window.refreshView = () => {
            renderEntities();
        };

        window.checkForUpdates = () => {
            checkForChanges();
        };

        // Simple entity formation functions
        window.addValidatorRow = () => {
            const validatorsList = document.getElementById('validatorsList');
            const newValidatorId = Date.now(); // Simple unique ID
            const newRow = document.createElement('div');
            newRow.className = 'validator-row';
            newRow.setAttribute('data-validator-id', newValidatorId);
            newRow.innerHTML = `
                <div class="validator-selector-container">
                    <div class="validator-selector" onclick="openValidatorDropdown(${newValidatorId})">
                        <img class="validator-avatar" src="" alt="" style="width: 24px; height: 24px; border-radius: 12px; margin-right: 8px;">
                        <span class="validator-display">Select signer...</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="validator-dropdown" id="validatorDropdown${newValidatorId}" style="display: none;">
                        <div class="validator-search">
                            <input type="text" placeholder="Search signers..." oninput="searchValidators(${newValidatorId}, this.value)" onclick="event.stopPropagation()">
                        </div>
                        <div class="validator-options" id="validatorOptions${newValidatorId}">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                <input type="number" class="validator-weight" placeholder="1" value="1" min="1" oninput="updateTotalWeight(); updateExpectedEntityId()">
                <button class="btn btn-danger btn-small" onclick="removeValidator(this)">❌</button>
            `;
            validatorsList.appendChild(newRow);
            
            // Initialize the new validator selector
            initializeValidatorSelector(newValidatorId);
            updateTotalWeight();
            
            // Show remove buttons for all validators when there's more than one
            if (validatorsList.children.length > 1) {
                validatorsList.querySelectorAll('.btn-danger').forEach(button => {
                    button.style.visibility = 'visible';
                });
            }
        };

        window.removeValidator = (button) => {
            const row = button.parentElement;
            const validatorsList = document.getElementById('validatorsList');
            if (validatorsList.children.length > 1) {
                row.remove();
                updateTotalWeight();
                updateExpectedEntityId();
                
                // If only one validator left, hide its remove button
                if (validatorsList.children.length === 1) {
                    const lastRemoveButton = validatorsList.querySelector('.btn-danger');
                    if (lastRemoveButton) {
                        lastRemoveButton.style.visibility = 'hidden';
                    }
                }
            } else {
                alert('Must have at least one validator');
            }
        };

        window.updateTotalWeight = () => {
            const weightInputs = document.querySelectorAll('.validator-weight');
            let totalWeight = 0;
            weightInputs.forEach(input => {
                const weight = parseInt(input.value) || 0;
                totalWeight += weight;
            });
            document.getElementById('totalWeight').textContent = totalWeight;
            
            // Update threshold slider max value
            const thresholdSlider = document.getElementById('thresholdSlider');
            thresholdSlider.max = totalWeight;
            
            // Ensure threshold doesn't exceed total weight
            const currentThreshold = parseInt(thresholdSlider.value);
            if (currentThreshold > totalWeight) {
                thresholdSlider.value = totalWeight;
                updateThreshold();
            }
        };

        // Validator selector functions
        window.openValidatorDropdown = (validatorId) => {
            console.log('🔍 Opening validator dropdown:', validatorId);
            
            // Close any other open dropdowns
            document.querySelectorAll('.validator-dropdown').forEach(dropdown => {
                if (dropdown.id !== `validatorDropdown${validatorId}`) {
                    dropdown.style.display = 'none';
                    const selector = dropdown.parentElement.querySelector('.validator-selector');
                    if (selector) selector.classList.remove('open');
                }
            });
            
            const dropdown = document.getElementById(`validatorDropdown${validatorId}`);
            const selector = dropdown.parentElement.querySelector('.validator-selector');
            
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                selector.classList.add('open');
                populateValidatorOptions(validatorId);
                
                // Focus search input
                const searchInput = dropdown.querySelector('input');
                if (searchInput) {
                    setTimeout(() => searchInput.focus(), 50);
                }
            } else {
                dropdown.style.display = 'none';
                selector.classList.remove('open');
            }
        };

        window.searchValidators = (validatorId, query) => {
            console.log('🔍 Searching validators:', validatorId, query);
            populateValidatorOptions(validatorId, query);
        };

        window.selectValidatorOption = (validatorId, signerName) => {
            console.log('✅ Selected validator:', validatorId, signerName);
            
            const row = document.querySelector(`[data-validator-id="${validatorId}"]`);
            if (!row) return;
            
            const display = row.querySelector('.validator-display');
            const avatar = row.querySelector('.validator-avatar');
            const dropdown = document.getElementById(`validatorDropdown${validatorId}`);
            const selector = row.querySelector('.validator-selector');
            
            // Update display
            display.textContent = `${signerName}.eth`;
            
            // Update avatar
            if (XLN.generateSignerAvatar) {
                const avatarSvg = XLN.generateSignerAvatar(signerName);
                const avatarUrl = avatarSvg.startsWith('data:') ? avatarSvg : `data:image/svg+xml;charset=utf-8,${encodeURIComponent(avatarSvg)}`;
                avatar.src = avatarUrl;
                avatar.style.display = 'inline-block';
                
                avatar.onerror = () => {
                    avatar.style.display = 'none';
                    console.log('❌ Validator avatar failed to load');
                };
            }
            
            // Store selected value
            row.setAttribute('data-selected-signer', signerName);
            
            // Close dropdown
            dropdown.style.display = 'none';
            selector.classList.remove('open');
            
            // Update entity preview
            updateExpectedEntityId();
        };

        const populateValidatorOptions = (validatorId, searchQuery = '') => {
            const optionsContainer = document.getElementById(`validatorOptions${validatorId}`);
            if (!optionsContainer) return;
            
            optionsContainer.innerHTML = '';
            
            // Demo signers
            const demoSigners = ['alice', 'bob', 'carol', 'david', 'eve'];
            
            // Filter by search query
            const filteredSigners = demoSigners.filter(signer => 
                signer.toLowerCase().includes(searchQuery.toLowerCase()) ||
                `${signer}.eth`.toLowerCase().includes(searchQuery.toLowerCase())
            );
            
            // Get currently selected validators to avoid duplicates
            const selectedValidators = new Set();
            document.querySelectorAll('.validator-row').forEach(row => {
                const selectedSigner = row.getAttribute('data-selected-signer');
                if (selectedSigner) selectedValidators.add(selectedSigner);
            });
            
            filteredSigners.forEach(signer => {
                const option = document.createElement('div');
                option.className = 'validator-option';
                
                // Create avatar
                const avatar = document.createElement('img');
                avatar.style.cssText = 'width: 20px; height: 20px; border-radius: 10px; margin-right: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.2);';
                
                if (XLN.generateSignerAvatar) {
                    const avatarSvg = XLN.generateSignerAvatar(signer);
                    const avatarUrl = avatarSvg.startsWith('data:') ? avatarSvg : `data:image/svg+xml;charset=utf-8,${encodeURIComponent(avatarSvg)}`;
                    avatar.src = avatarUrl;
                    
                    avatar.onerror = () => {
                        avatar.style.display = 'none';
                    };
                }
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'signer-name';
                nameSpan.textContent = `${signer}.eth`;
                
                // Dim if already selected
                if (selectedValidators.has(signer)) {
                    option.style.opacity = '0.5';
                    option.style.pointerEvents = 'none';
                    nameSpan.textContent += ' (already selected)';
                }
                
                option.appendChild(avatar);
                option.appendChild(nameSpan);
                
                if (!selectedValidators.has(signer)) {
                    option.onclick = () => selectValidatorOption(validatorId, signer);
                }
                
                optionsContainer.appendChild(option);
            });
            
            if (filteredSigners.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'validator-option';
                noResults.style.textAlign = 'center';
                noResults.style.color = '#666';
                noResults.textContent = 'No signers found';
                optionsContainer.appendChild(noResults);
            }
        };

        window.initializeValidatorSelector = (validatorId) => {
            // For existing validators, set initial values
            const row = document.querySelector(`[data-validator-id="${validatorId}"]`);
            if (!row) return;
            
            const display = row.querySelector('.validator-display');
            const currentText = display.textContent;
            
            // If it's already showing a signer name, set up the avatar
            if (currentText.includes('.eth') && currentText !== 'Select signer...') {
                const signerName = currentText.replace('.eth', '');
                row.setAttribute('data-selected-signer', signerName);
                
                const avatar = row.querySelector('.validator-avatar');
                if (XLN.generateSignerAvatar && avatar) {
                    const avatarSvg = XLN.generateSignerAvatar(signerName);
                    const avatarUrl = avatarSvg.startsWith('data:') ? avatarSvg : `data:image/svg+xml;charset=utf-8,${encodeURIComponent(avatarSvg)}`;
                    avatar.src = avatarUrl;
                    avatar.style.display = 'inline-block';
                    
                    avatar.onerror = () => {
                        avatar.style.display = 'none';
                    };
                }
            }
        };

        window.updateThreshold = () => {
            const thresholdSlider = document.getElementById('thresholdSlider');
            const thresholdValue = document.getElementById('thresholdValue');
            thresholdValue.textContent = thresholdSlider.value;
            // Update entity ID preview when threshold changes
            updateExpectedEntityId();
        };

        // Jurisdiction management functions
        function populateJurisdictions() {
            // Jurisdiction configurations will be set via onJurisdictionChange
            console.log(`📋 Multiple jurisdiction support enabled`);
        }

        async function onJurisdictionChange() {
            const jurisdictionSelect = document.getElementById('jurisdictionSelect');
            const jurisdictionInfo = document.getElementById('jurisdictionInfo');
            const selectedPort = jurisdictionSelect.value;
            
            if (selectedPort) {
                try {
                    // Use server.js function to get jurisdictions
                    const jurisdictions = await XLN.getAvailableJurisdictions();
                    
                    // Find jurisdiction by port
                    let jurisdiction = null;
                    for (const [key, jur] of Object.entries(jurisdictions)) {
                        if (jur.address.includes(`:${selectedPort}`)) {
                            jurisdiction = jur;
                            break;
                        }
                    }
                    
                    if (jurisdiction) {
                        // Show jurisdiction details
                        document.getElementById('networkName').textContent = jurisdiction.name;
                        document.getElementById('rpcPort').textContent = selectedPort;
                        document.getElementById('contractAddress').textContent = jurisdiction.entityProviderAddress;
                        jurisdictionInfo.style.display = 'block';
                        
                        console.log(`🏛️  Selected jurisdiction: ${jurisdiction.name} on port ${selectedPort}`);
                        console.log(`📝 Contract address: ${jurisdiction.entityProviderAddress}`);
                    } else {
                        // Show error state
                        document.getElementById('networkName').textContent = 'Jurisdiction not found';
                        document.getElementById('rpcPort').textContent = selectedPort;
                        document.getElementById('contractAddress').textContent = 'Not deployed';
                        jurisdictionInfo.style.display = 'block';
                        console.log(`❌ No jurisdiction found for port ${selectedPort}`);
                    }
                } catch (error) {
                    console.error('❌ Failed to load jurisdictions:', error);
                    // Show loading state
                    document.getElementById('networkName').textContent = 'Loading...';
                    document.getElementById('rpcPort').textContent = selectedPort;
                    document.getElementById('contractAddress').textContent = 'Loading contract address...';
                    jurisdictionInfo.style.display = 'block';
                }
            } else {
                // Hide jurisdiction details
                jurisdictionInfo.style.display = 'none';
                console.log(`🏛️  No jurisdiction selected`);
            }
        }

        async function getJurisdictionByPort(port) {
            try {
                const jurisdictions = await XLN.getAvailableJurisdictions();
                
                // Find jurisdiction by port
                for (const [key, jurisdiction] of Object.entries(jurisdictions)) {
                    if (jurisdiction.address.includes(`:${port}`)) {
                        return {
                            name: jurisdiction.name,
                            address: jurisdiction.address,
                            chainId: jurisdiction.chainId,
                            entityProviderAddress: jurisdiction.entityProviderAddress,
                            depositoryAddress: jurisdiction.depositoryAddress
                        };
                    }
                }
                return null;
            } catch (error) {
                console.error('Failed to load jurisdictions:', error);
                return null;
            }
        }

        // Make functions global
        window.populateJurisdictions = populateJurisdictions;
        window.onJurisdictionChange = onJurisdictionChange;
        window.getJurisdictionByPort = getJurisdictionByPort;

        // Update expected entity ID preview
        window.updateExpectedEntityId = async () => {
            const expectedEntityIdDiv = document.getElementById('expectedEntityId');
            const quorumHashDiv = document.getElementById('quorumHash');
            if (!expectedEntityIdDiv) return;
            
            try {
                const entityType = document.getElementById('entityTypeSelect')?.value || 'lazy';
                const entityName = document.getElementById('entityNameInput')?.value || 'ACME';
                
                // Get validator data using new selector system
                const validators = [];
                const validatorRows = document.querySelectorAll('.validator-row');
                validatorRows.forEach(row => {
                    const selectedSigner = row.getAttribute('data-selected-signer');
                    const weight = parseInt(row.querySelector('.validator-weight')?.value) || 1;
                    if (selectedSigner) {
                        validators.push({ name: selectedSigner, weight });
                    }
                });
                
                if (validators.length === 0) {
                    expectedEntityIdDiv.textContent = 'Add validators to see entity ID preview';
                    if (quorumHashDiv) {
                        quorumHashDiv.textContent = 'Configure validators and threshold to see quorum hash';
                    }
                    return;
                }
                
                // Always calculate and display quorum hash
                const threshold = BigInt(document.getElementById('thresholdValue')?.textContent || '2');
                console.log('Threshold value from DOM:', document.getElementById('thresholdValue')?.textContent, 'Parsed as BigInt:', threshold);
                console.log('Validators:', validators);
                const quorumHash = XLN.generateLazyEntityId(validators, threshold);
                if (quorumHashDiv) {
                    quorumHashDiv.textContent = quorumHash;
                }
                
                let expectedId = '';
                
                if (entityType === 'lazy') {
                    // For lazy entities, use the same quorum hash
                    expectedId = quorumHash;
                } else if (entityType === 'numbered') {
                    // For numbered entities, show just the number
                    try {
                        const nextNumber = await XLN.getNextEntityNumber();
                        expectedId = `#${nextNumber}`;
                    } catch (error) {
                        expectedId = `#XX (blockchain disconnected)`;
                    }
                } else if (entityType === 'named') {
                    // For named entities, show just the name
                    expectedId = entityName;
                }
                
                expectedEntityIdDiv.textContent = expectedId;
                
            } catch (error) {
                expectedEntityIdDiv.textContent = 'Error generating preview';
                console.error('Error updating entity ID preview:', error);
            }
        };

        // Entity type selection handler
        window.onEntityTypeChange = async () => {
            const entityTypeSelect = document.getElementById('entityTypeSelect');
            const entityType = entityTypeSelect.value;
            const entityNameInput = document.getElementById('entityNameInput');
            const entityNameHint = document.getElementById('entityNameHint');
            const jurisdictionSelect = document.getElementById('jurisdictionSelect');
            const nextNumberInfo = document.getElementById('nextNumberInfo');
            const nextNumberDisplay = document.getElementById('nextNumberDisplay');
            
            // Add null checks
            if (!entityTypeSelect || !entityNameInput || !entityNameHint || !jurisdictionSelect) {
                console.error('Required form elements not found');
                return;
            }
            
            if (entityType === 'lazy') {
                entityNameInput.placeholder = 'e.g., MyTradingBot, ChatGroup';
                entityNameHint.textContent = '🔒 Display name only - ID will be hash(validators). Free and instant!';
                if (nextNumberInfo) nextNumberInfo.style.display = 'none';
                
            } else if (entityType === 'numbered') {
                entityNameInput.placeholder = 'e.g., TradingEntity, MyDAO';
                entityNameHint.textContent = '🔢 Display name - you\'ll get a sequential number like #42. Requires gas.';
                
                // Show and fetch next number
                if (nextNumberInfo && nextNumberDisplay) {
                    nextNumberInfo.style.display = 'block';
                    nextNumberDisplay.textContent = 'Loading...';
                    try {
                        // Get selected jurisdiction
                        const selectedJurisdiction = jurisdictionSelect.value;
                        if (selectedJurisdiction) {
                            const jurisdictions = await XLN.getAvailableJurisdictions();
                            const jurisdiction = jurisdictions.get(selectedJurisdiction);
                            if (jurisdiction) {
                                const nextNumber = await XLN.getNextEntityNumber(jurisdiction);
                        nextNumberDisplay.textContent = `#${nextNumber}`;
                            } else {
                                nextNumberDisplay.textContent = 'Select jurisdiction first';
                            }
                        } else {
                            nextNumberDisplay.textContent = 'Select jurisdiction first';
                        }
                    } catch (error) {
                        nextNumberDisplay.textContent = 'Error loading';
                        console.error('Failed to fetch next entity number:', error);
                    }
                }
                
            } else if (entityType === 'named') {
                entityNameInput.placeholder = 'e.g., coinbase, uniswap, mycompany';
                entityNameHint.textContent = '🏷️ Custom name that becomes your identity. Requires gas + admin approval.';
                
                // Show and fetch next number (named entities also get a number first)
                if (nextNumberInfo && nextNumberDisplay) {
                    nextNumberInfo.style.display = 'block';
                    nextNumberDisplay.textContent = 'Loading...';
                    try {
                        // Get selected jurisdiction
                        const selectedJurisdiction = jurisdictionSelect.value;
                        if (selectedJurisdiction) {
                            const jurisdictions = await XLN.getAvailableJurisdictions();
                            const jurisdiction = jurisdictions.get(selectedJurisdiction);
                            if (jurisdiction) {
                                const nextNumber = await XLN.getNextEntityNumber(jurisdiction);
                        nextNumberDisplay.textContent = `#${nextNumber} (then named)`;
                            } else {
                                nextNumberDisplay.textContent = 'Select jurisdiction first';
                            }
                        } else {
                            nextNumberDisplay.textContent = 'Select jurisdiction first';
                        }
                    } catch (error) {
                        nextNumberDisplay.textContent = 'Error loading';
                        console.error('Failed to fetch next entity number:', error);
                    }
                }
            }
            
            // Update entity ID preview
            updateExpectedEntityId();
        };

        window.createSimpleEntity = async () => {
            if (!xlnEnv) return;
            
            // Always go to current time when creating entities
            currentTimeIndex = -1;
            
            const entityTypeSelect = document.getElementById('entityTypeSelect');
            const entityType = entityTypeSelect.value;
            const entityName = document.getElementById('entityNameInput').value.trim();
            const thresholdElement = document.getElementById('thresholdSlider');
            const thresholdValue = thresholdElement ? thresholdElement.value : '';
            const threshold = parseInt(thresholdValue);
            const jurisdictionSelect = document.getElementById('jurisdictionSelect');
            const selectedJurisdiction = jurisdictionSelect.value;
            
            console.log(`Form values: entityType="${entityType}", entityName="${entityName}", thresholdValue="${thresholdValue}", threshold=${threshold}`);
            
            if (isNaN(threshold)) {
                alert(`Invalid threshold value: "${thresholdValue}". Please check the threshold slider.`);
                return;
            }
            
            // Validation
            if (!entityName) {
                alert('Please enter an entity name');
                return;
            }
            
            // Require jurisdiction selection
            if (!selectedJurisdiction) {
                alert('Please select a jurisdiction to continue');
                return;
            }
            
            // Name validation for named entities
            if (entityType === 'named') {
                if (!/^[a-zA-Z0-9_-]+$/.test(entityName)) {
                    alert('Named entity names can only contain letters, numbers, underscores, and hyphens');
                return;
                }
                if (entityName.length < 3 || entityName.length > 32) {
                    alert('Named entity names must be between 3 and 32 characters');
                    return;
                }
            }
            
            // Collect validators and weights
            const validatorRows = document.querySelectorAll('.validator-row');
            const validators = [];
            const shares = {};
            let totalShares = 0;
            
            validatorRows.forEach((row, index) => {
                // Use the new selector system - get selected signer from data attribute
                const selectedSigner = row.getAttribute('data-selected-signer');
                const weightInput = row.querySelector('.validator-weight');
                
                if (selectedSigner && weightInput) {
                    const weight = parseInt(weightInput.value.trim()) || 1;
                    
                    if (weight > 0) {
                        validators.push(selectedSigner);
                        shares[selectedSigner] = BigInt(weight);
                        totalShares += weight;
                    }
                } else if (!selectedSigner) {
                    // Show which validator is not selected
                    const validatorDisplay = row.querySelector('.validator-display');
                    const displayText = validatorDisplay ? validatorDisplay.textContent : 'Unknown';
                    alert(`Please select a signer for validator: ${displayText}`);
                    return;
                }
            });
            
            // Validation
            if (validators.length === 0) {
                alert('Please add at least one validator');
                    return;
                }
                
            if (threshold > totalShares) {
                alert(`Threshold (${threshold}) cannot be greater than total weight (${totalShares})`);
                    return;
                }
                
            // Check for duplicate validator names
            const uniqueValidators = new Set(validators);
            if (uniqueValidators.size !== validators.length) {
                alert('Validator names must be unique');
                    return;
                }
                
            let jurisdictionConfig = await window.getJurisdictionByPort(selectedJurisdiction);
            if (!jurisdictionConfig) {
                alert('Invalid jurisdiction selected');
                return;
            }
            
            console.log(`🏛️ Creating ${entityType} entity: ${entityName}`);
            if (jurisdictionConfig) console.log(`   Jurisdiction: ${jurisdictionConfig.name}`);
            console.log(`   Validators: ${validators.join(', ')}`);
            console.log(`   Threshold: ${threshold}/${totalShares}`);
            
            let config;
            let entityId;
            let entityNumber;
            
            console.log(`Creating ${entityType} entity: ${entityName}`);
            
            try {
                // Create entity using new 3-tier system
                if (entityType === 'lazy') {
                    config = XLN.createLazyEntity(entityName, validators, BigInt(threshold), jurisdictionConfig);
                    entityId = XLN.generateLazyEntityId(validators, BigInt(threshold));
                    console.log(`🔒 Lazy Entity ID: ${entityId}`);
                    
                } else if (entityType === 'numbered') {
                    const result = await XLN.createNumberedEntity(entityName, validators, BigInt(threshold), jurisdictionConfig);
                    config = result.config;
                    entityNumber = result.entityNumber;
                    entityId = XLN.generateNumberedEntityId(entityNumber);
                    console.log(`🔢 Numbered Entity: #${entityNumber}`);
                    console.log(`🆔 Entity ID: ${entityId}`);
                    
                    // Simulate blockchain registration
                    try {
                        const regResult = await XLN.registerNumberedEntityOnChain(config, entityName);
                        console.log(`✅ Entity registered on-chain: ${regResult.txHash}`);
                        alert(`Numbered entity #${regResult.entityNumber} created successfully!\nTransaction: ${regResult.txHash.slice(0, 10)}...`);
                    } catch (error) {
                        console.error('❌ Registration failed:', error);
                        alert(`Registration failed: ${error.message}`);
                return;
            }
            
                } else if (entityType === 'named') {
                    // First create a numbered entity
                    const result = await XLN.createNumberedEntity(entityName, validators, BigInt(threshold), jurisdictionConfig);
                    config = result.config;
                    entityNumber = result.entityNumber;
                    entityId = XLN.generateNumberedEntityId(entityNumber);
                    
                    // Register the numbered entity first
                    const regResult = await XLN.registerNumberedEntityOnChain(config, entityName);
                    console.log(`🔢 Created numbered entity #${regResult.entityNumber} for name assignment`);
                    
                    // Request name assignment from admin
                    try {
                        const requestId = await XLN.requestNamedEntity(entityName, regResult.entityNumber, jurisdictionConfig);
                        console.log(`🏷️ Name assignment requested: ${requestId}`);
                        alert(`Named entity request submitted!\n\nEntity Number: #${regResult.entityNumber}\nName: "${entityName}"\nRequest ID: ${requestId}\n\nYour entity is functional now. Admin will assign the name later.`);
                    } catch (error) {
                        console.error('❌ Name request failed:', error);
                        alert(`Name request failed: ${error.message}\n\nYour numbered entity #${regResult.entityNumber} is still functional.`);
                    }
                }
                
                // Check if entity already exists with this ID
                const existingEntity = Array.from(xlnEnv.replicas.keys()).find(key => 
                    key.startsWith(entityId + ':') || key.startsWith(entityName + ':')
                );
                if (existingEntity) {
                    alert(`Entity with this configuration already exists: ${existingEntity}`);
                return;
            }
            
                // Create server transactions for all validators using the generated entityId
            const serverTxs = validators.map((signerId, index) => ({
                type: 'importReplica',
                    entityId: entityId, // Use the generated entity ID
                signerId: signerId,
                data: {
                    config: config,
                    isProposer: index === 0 // First validator is proposer
                }
            }));
            
            // Process the server transactions
                let outputs = XLN.applyServerInput(xlnEnv, {
                serverTxs: serverTxs,
                entityInputs: []
            });
            
            // Process outputs until empty
            while (outputs.length > 0) {
                const newOutputs = XLN.applyServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: outputs
                });
                outputs.splice(0, outputs.length, ...newOutputs);
            }
            
                // Perform jurisdiction registration if selected
                if (jurisdictionConfig) {
                    console.log(`🏛️  Entity "${entityName}" configured with jurisdiction "${jurisdictionConfig.name}"`);
                    console.log(`    EntityProvider: ${jurisdictionConfig.entityProviderAddress}`);
                    console.log(`    Depository: ${jurisdictionConfig.depositoryAddress}`);
                    console.log(`    Chain ID: ${jurisdictionConfig.chainId}`);
                    console.log(`    📝 Note: Full blockchain registration will be implemented in next iteration`);
                }
                
                // Success feedback - only for lazy entities (numbered/named have specific alerts)
                if (entityType === 'lazy') {
                    const jurisdictionMessage = jurisdictionConfig 
                        ? `\n🏛️ Jurisdiction: ${jurisdictionConfig.name}` 
                        : '\n⚠️ Warning: No jurisdiction selected';
                    
                    alert(`✅ Entity "${entityName}" created successfully!${jurisdictionMessage}\n\nValidators: ${validators.join(', ')}\nThreshold: ${threshold}/${totalShares}`);
                }
            
            // Clear form and refresh view
            clearSimpleForm();
            renderEntities();
            } catch (error) {
                console.error('Failed to create entity:', error);
                alert(`Failed to create entity: ${error.message}`);
            }
        };

        window.clearSimpleForm = () => {
            document.getElementById('entityNameInput').value = '';
            
            // Reset jurisdiction selection
            document.getElementById('jurisdictionSelect').value = '';
            document.getElementById('jurisdictionInfo').style.display = 'none';
            
            // Reset to default 3 validators
            const validatorsList = document.getElementById('validatorsList');
            validatorsList.innerHTML = `
                <div class="validator-row">
                    <input type="text" class="validator-name" placeholder="alice" value="alice">
                    <input type="number" class="validator-weight" placeholder="1" value="1" min="1" oninput="updateTotalWeight()">
                    <button class="btn btn-danger btn-small" onclick="removeValidator(this)">❌</button>
                </div>
                <div class="validator-row">
                    <input type="text" class="validator-name" placeholder="bob" value="bob">
                    <input type="number" class="validator-weight" placeholder="1" value="1" min="1" oninput="updateTotalWeight()">
                    <button class="btn btn-danger btn-small" onclick="removeValidator(this)">❌</button>
                </div>
                <div class="validator-row">
                    <input type="text" class="validator-name" placeholder="carol" value="carol">
                    <input type="number" class="validator-weight" placeholder="1" value="1" min="1" oninput="updateTotalWeight()">
                    <button class="btn btn-danger btn-small" onclick="removeValidator(this)">❌</button>
                </div>
            `;
            
            document.getElementById('thresholdSlider').value = '2';
            updateTotalWeight();
            updateThreshold();
        };

        // Tab switching function
        window.switchTab = (tabName) => {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            const targetContent = document.getElementById(tabName + 'TabContent');
            const targetButton = document.getElementById(tabName + 'Tab');
            
            if (targetContent && targetButton) {
                targetContent.classList.add('active');
                targetButton.classList.add('active');
                
                // If switching to jurisdictions tab, refresh data
                if (tabName === 'jurisdictions') {
                    refreshAllJurisdictions();
                }
            }
        };

        // Jurisdictions functions
        window.refreshAllJurisdictions = async () => {
            const ports = [8545, 8546, 8547];
            const networks = ['Ethereum', 'Polygon', 'Arbitrum'];
            
            for (let i = 0; i < ports.length; i++) {
                await refreshJurisdictionData(ports[i], networks[i]);
            }
        };

        const refreshJurisdictionData = async (port, networkName) => {
            try {
                const statusElement = document.getElementById(`status-${port}`);
                statusElement.textContent = '🔄 Checking...';
                statusElement.className = 'connection-status checking';
                
                // Test blockchain connection
                const response = await fetch(`http://localhost:${port}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_blockNumber',
                        params: [],
                        id: 1
                    })
                });
                
                if (!response.ok) throw new Error('Network unavailable');
                
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                const blockNumber = parseInt(data.result, 16);
                
                // Update UI with success
                statusElement.textContent = '✅ Connected';
                statusElement.className = 'connection-status connected';
                
                // Update details
                document.getElementById(`chainId-${port}`).textContent = `31337`;
                document.getElementById(`blockNumber-${port}`).textContent = blockNumber;
                document.getElementById(`lastUpdate-${port}`).textContent = new Date().toLocaleTimeString();
                
                // Get contract address and next number
                try {
                    const rpcUrl = `http://localhost:${port}`;
                    
                    // Get contract address from server.js
                    const jurisdictionConfig = await getJurisdictionByPort(port);
                    if (!jurisdictionConfig?.entityProviderAddress) {
                        throw new Error('Contract address not available');
                    }
                    const contractAddress = jurisdictionConfig.entityProviderAddress;
                    
                    // Check if contract is deployed by testing getCode
                    const codeResponse = await fetch(rpcUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'eth_getCode',
                            params: [contractAddress, 'latest'],
                            id: 2
                        })
                    });
                    
                    const codeData = await codeResponse.json();
                    const isDeployed = codeData.result && codeData.result !== '0x';
                    
                    if (isDeployed) {
                        // Contract is deployed
                        document.getElementById(`contract-${port}`).textContent = contractAddress;
                        
                        // Get next entity number using the connectToEthereum method
                        if (port === 8545) {
                            // For port 8545, we can use the existing function
                            const nextNumber = await XLN.getNextEntityNumber(jurisdictionConfig);
                            document.getElementById(`nextNumber-${port}`).textContent = `#${nextNumber}`;
                        } else {
                            // For other ports, call the contract directly via RPC
                            const nextNumberResponse = await fetch(rpcUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'eth_call',
                                    params: [{
                                        to: contractAddress,
                                        data: '0x848202fe' // nextNumber() function selector
                                    }, 'latest'],
                                    id: 3
                                })
                            });
                            
                            const nextNumberData = await nextNumberResponse.json();
                            if (nextNumberData.result) {
                                const nextNumber = parseInt(nextNumberData.result, 16);
                                document.getElementById(`nextNumber-${port}`).textContent = `#${nextNumber}`;
                            } else {
                                document.getElementById(`nextNumber-${port}`).textContent = 'Error';
                            }
                        }
                        
                        // Get registered entities
                        await refreshEntitiesList(port);
                        
                    } else {
                        // Contract not deployed
                        document.getElementById(`contract-${port}`).textContent = 'Not deployed';
                        document.getElementById(`nextNumber-${port}`).textContent = 'N/A';
                        document.getElementById(`entities-${port}`).textContent = 'Contract not deployed';
                    }
                    
                } catch (contractError) {
                    document.getElementById(`contract-${port}`).textContent = 'Error checking';
                    document.getElementById(`nextNumber-${port}`).textContent = 'N/A';
                    document.getElementById(`entities-${port}`).textContent = `Error: ${contractError.message}`;
                }
                
            } catch (error) {
                // Update UI with error
                const statusElement = document.getElementById(`status-${port}`);
                statusElement.textContent = '❌ Disconnected';
                statusElement.className = 'connection-status disconnected';
                
                document.getElementById(`chainId-${port}`).textContent = '-';
                document.getElementById(`blockNumber-${port}`).textContent = '-';
                document.getElementById(`lastUpdate-${port}`).textContent = 'Failed';
                document.getElementById(`contract-${port}`).textContent = '-';
                document.getElementById(`nextNumber-${port}`).textContent = '-';
                document.getElementById(`entities-${port}`).textContent = `Error: ${error.message}`;
            }
        };

        const refreshEntitiesList = async (port) => {
            try {
                const entitiesDiv = document.getElementById(`entities-${port}`);
                entitiesDiv.textContent = 'Loading entities...';
                
                            const rpcUrl = `http://localhost:${port}`;
            
            // Get contract address from server.js
            const jurisdictionConfig = await getJurisdictionByPort(port);
            if (!jurisdictionConfig?.entityProviderAddress) {
                entitiesDiv.textContent = 'Contract address not available';
                return;
            }
            const contractAddress = jurisdictionConfig.entityProviderAddress;
                
                // Get next number to know how many numbered entities exist
                const nextNumberResponse = await fetch(rpcUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_call',
                        params: [{
                            to: contractAddress,
                            data: '0x848202fe' // nextNumber() function selector
                        }, 'latest'],
                        id: 1
                    })
                });
                
                const nextNumberData = await nextNumberResponse.json();
                if (!nextNumberData.result) {
                    throw new Error('Failed to get next number');
                }
                
                const nextNumber = parseInt(nextNumberData.result, 16);
                const entities = [];
                
                // Query numbered entities from 1 to nextNumber-1
                for (let i = 1; i < nextNumber; i++) {
                    try {
                        // Check if entity exists by calling entities(bytes32)
                        // Convert number to bytes32 (pad to 32 bytes)
                        const entityIdBytes32 = '0x' + i.toString(16).padStart(64, '0');
                        
                        const entityResponse = await fetch(rpcUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                jsonrpc: '2.0',
                                method: 'eth_call',
                                params: [{
                                    to: contractAddress,
                                    data: '0xe5b338fd' + entityIdBytes32.slice(2) // entities(bytes32) function selector + entityId
                                }, 'latest'],
                                id: i + 10
                            })
                        });
                        
                        const entityData = await entityResponse.json();
                        if (entityData.result && entityData.result !== '0x') {
                            // Parse the result (boardHash, status, activationTime)
                            const result = entityData.result;
                            if (result.length >= 66) { // Has actual data
                                // Extract boardHash (first 32 bytes after the initial offset)
                                const boardHash = '0x' + result.slice(2, 66);
                                
                                // Try to get entity name
                                const nameResponse = await fetch(rpcUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        jsonrpc: '2.0',
                                        method: 'eth_call',
                                        params: [{
                                            to: contractAddress,
                                            data: '0x1ed3d440' + i.toString(16).padStart(64, '0') // numberToName(uint256) function selector + number
                                        }, 'latest'],
                                        id: i + 100
                                    })
                                });
                                
                                const nameData = await nameResponse.json();
                                let name = '';
                                if (nameData.result && nameData.result !== '0x') {
                                    // Decode string from result
                                    try {
                                        const hex = nameData.result.slice(2);
                                        if (hex.length > 64) {
                                            const length = parseInt(hex.slice(64, 128), 16);
                                            if (length > 0) {
                                                const nameHex = hex.slice(128, 128 + length * 2);
                                                name = new TextDecoder().decode(new Uint8Array(nameHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16))));
                                            }
                                        }
                                    } catch (e) {
                                        // Failed to decode name, leave empty
                                    }
                                }
                                
                                entities.push({
                                    id: `#${i}`,
                                    name: name || `Entity ${i}`,
                                    type: 'Numbered',
                                    boardHash: boardHash
                                });
                            }
                        }
                    } catch (e) {
                        // Skip invalid entities
                        console.warn(`Failed to query entity ${i}:`, e);
                    }
                }
                
                // Display the entities
                if (entities.length === 0) {
                    entitiesDiv.innerHTML = `
                        <div class="entity-item">No entities registered yet</div>
                        <div style="margin-top: 10px; font-size: 11px; color: #6c757d;">
                            Create entities to see them listed here
                        </div>
                    `;
                } else {
                    entitiesDiv.innerHTML = entities.map(entity => `
                        <div class="entity-item">
                            <strong>${entity.id}</strong>: ${entity.name}
                            <div style="font-size: 11px; color: #6c757d; margin-top: 2px;">
                                Quorum: ${entity.boardHash ? entity.boardHash.slice(0, 10) + '...' : 'N/A'}
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                document.getElementById(`entities-${port}`).textContent = `Error loading entities: ${error.message}`;
            }
        };

        window.deployContracts = async () => {
            try {
                alert('Contract deployment feature coming soon! For now, use: cd contracts && npx hardhat ignition deploy ignition/modules/Depository.ts --network localhost');
            } catch (error) {
                alert(`Deployment error: ${error.message}`);
            }
        };

        // Time machine functions
        window.goToHistoryStart = () => {
            const history = XLN.getHistory();
            if (history.length > 0) {
                currentTimeIndex = 0;
                console.log('🕰️ Go to history start (index 0)');
                updateTimeMachineUI();
                
                // Update all tabs with current time state (same as slider)
                if (typeof tabSystem !== 'undefined' && tabSystem.tabs) {
                    tabSystem.tabs.forEach(tab => {
                        if (tab.entityId && tab.signer) {
                            renderEntityInTab(tab.id, tab.signer, tab.entityId);
                        }
                    });
                }
                
                renderEntities();
            }
        };

        window.goToHistoryEnd = () => {
            currentTimeIndex = -1; // Current time
            console.log('🕰️ Go to history end (live)');
            updateTimeMachineUI();
            
            // Update all tabs with current time state (same as slider)
            if (typeof tabSystem !== 'undefined' && tabSystem.tabs) {
                tabSystem.tabs.forEach(tab => {
                    if (tab.entityId && tab.signer) {
                        renderEntityInTab(tab.id, tab.signer, tab.entityId);
                    }
                });
            }
            
            renderEntities();
        };

        window.stepBackward = () => {
            const history = XLN.getHistory();
            if (history.length === 0) return;
            
            if (currentTimeIndex === -1) {
                // Currently at live, go to most recent meaningful snapshot (skip latest duplicate)
                currentTimeIndex = Math.max(0, history.length - 1);
            } else {
                // Go one step back, but not below 0
                currentTimeIndex = Math.max(0, currentTimeIndex - 1);
            }
            
            console.log('🕰️ Step backward to index:', currentTimeIndex);
            updateTimeMachineUI();
            
            // Update all tabs with current time state (same as slider)
            if (typeof tabSystem !== 'undefined' && tabSystem.tabs) {
                tabSystem.tabs.forEach(tab => {
                    if (tab.entityId && tab.signer) {
                        renderEntityInTab(tab.id, tab.signer, tab.entityId);
                    }
                });
            }
            
            renderEntities();
        };

        window.stepForward = () => {
            const history = XLN.getHistory();
            if (history.length === 0) return;
            
            if (currentTimeIndex === -1) {
                // Already at live, can't go further
                return;
            } else if (currentTimeIndex < history.length - 1) {
                // Normal forward step
                currentTimeIndex++;
            } else {
                // At last meaningful snapshot, go to live
                currentTimeIndex = -1;
            }
            
            console.log('🕰️ Step forward to index:', currentTimeIndex);
            updateTimeMachineUI();
            
            // Update all tabs with current time state (same as slider)
            if (typeof tabSystem !== 'undefined' && tabSystem.tabs) {
                tabSystem.tabs.forEach(tab => {
                    if (tab.entityId && tab.signer) {
                        renderEntityInTab(tab.id, tab.signer, tab.entityId);
                    }
                });
            }
            
                renderEntities();
            };

        // Step functions are now properly defined above with consistent behavior

        // Time slider event handler and keyboard shortcuts
        document.addEventListener('DOMContentLoaded', () => {
            const timeSlider = document.getElementById('timeSlider');
            timeSlider.addEventListener('input', (e) => {
                const history = XLN.getHistory();
                const sliderValue = parseInt(e.target.value);
                const maxMeaningfulIndex = Math.max(0, history.length - 1);
                const sliderContainer = document.querySelector('.time-slider-container');
                
                if (sliderValue > maxMeaningfulIndex) {
                    currentTimeIndex = -1; // Current time (skip latest snapshot which is same as live)
                    // Update progress immediately for live state
                    sliderContainer.style.setProperty('--progress', '100%');
                } else {
                    currentTimeIndex = sliderValue;
                    // Update progress immediately for historical state - use same logic as updateTimeMachineUI
                    const sliderMax = maxMeaningfulIndex + 1;
                    const progressPercent = sliderMax > 0 ? (sliderValue / sliderMax) * 100 : 0;
                    sliderContainer.style.setProperty('--progress', `${progressPercent}%`);
                }
                
                console.log('🕰️ Time slider changed to index:', currentTimeIndex);
                updateTimeMachineUI();
                
                // Update all tabs with current time state
                if (typeof tabSystem !== 'undefined' && tabSystem.tabs) {
                    tabSystem.tabs.forEach(tab => {
                        if (tab.entityId && tab.signer) {
                            renderEntityInTab(tab.id, tab.signer, tab.entityId);
                        }
                    });
                }
                
                renderEntities();
            });

            // Keyboard shortcuts for time machine
            document.addEventListener('keydown', (e) => {
                // Only activate when not typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        stepBackward();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        stepForward();
                        break;
                    case 'Home':
                        e.preventDefault();
                        goToHistoryStart();
                        break;
                    case 'End':
                        e.preventDefault();
                        goToHistoryEnd();
                        break;
                }
            });
            
            // Initialize simple entity formation
            updateTotalWeight();
        });

        // Entity filtering now handled by unified dropdown - no separate listener needed

        // Initialization handled by DOMContentLoaded main() function

        // Clear database and run demo now handled by top bar buttons - no separate listeners needed

        // Function to reinitialize after database clear (instead of page reload)
        window.reinitializeAfterClear = async function() {
            try {
                console.log('🔄 Reinitializing application after database clear...');
                
                // Reset global state
                xlnEnv = null;
                window.xlnEnv = null;
                
                // Clear UI state
                const entitiesGrid = document.getElementById('entitiesGrid');
                if (entitiesGrid) entitiesGrid.innerHTML = '';
                
                // Reinitialize environment from scratch
                xlnEnv = await XLN.main();
                window.xlnEnv = xlnEnv;
                
                // Re-render UI
                setupEntitySearch(); // Reinitialize autocomplete search
                renderEntities();
                updateTimeMachineUI();
                
                console.log('✅ Application reinitialized successfully');
            } catch (error) {
                console.error('❌ Failed to reinitialize after clear:', error);
                // Fallback to page reload if reinit fails
                        location.reload();
            }
        };

        // === ENTITY NAME SEARCH AUTOCOMPLETE ===
        
        let searchTimeout;
        const searchInput = document.getElementById('entitySearchInput');
        const searchResults = document.getElementById('entitySearchResults');
        
        // Setup autocomplete functionality
        const setupEntitySearch = () => {
            if (!searchInput || !searchResults) return;
            
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }
                
                // Debounce search
                searchTimeout = setTimeout(async () => {
                    try {
                        const results = await XLN.searchEntityNames(query, 5);
                        displaySearchResults(results);
                    } catch (error) {
                        console.error('Search error:', error);
                        searchResults.style.display = 'none';
                    }
                }, 300);
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
            
            // Focus/clear on click
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.trim().length >= 2) {
                    searchResults.style.display = 'block';
                }
            });
        };
        
        const displaySearchResults = (results) => {
            if (!results || results.length === 0) {
                searchResults.style.display = 'none';
                return;
            }
            
            const html = results.map(result => `
                <div class="search-result-item" style="
                    padding: 12px; 
                    border-bottom: 1px solid #eee; 
                    cursor: pointer; 
                    display: flex; 
                    align-items: center; 
                    gap: 10px;
                    transition: background-color 0.2s;
                " 
                onmouseover="this.style.backgroundColor='#404040'" 
                onmouseout="this.style.backgroundColor='#2d2d2d'"
                onclick="selectEntity('${result.entityId}', '${result.name}')">
                    <img src="${result.avatar}" alt="Avatar" style="width: 24px; height: 24px; border-radius: 50%;">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;">${result.name}</div>
                        <div style="font-size: 12px; color: #9d9d9d;">Entity ${XLN.formatEntityDisplay(result.entityId)}</div>
                    </div>
                </div>
            `).join('');
            
            searchResults.innerHTML = html;
            searchResults.style.display = 'block';
        };
        
        // Old selectEntity function removed - now handled by unified dropdown

        // --- Main Application Entry Point ---
        // Entity card expand/collapse functionality
        function toggleEntityDetails(cardId) {
            const detailsDiv = document.getElementById(`details-${cardId}`);
            const entityCard = document.querySelector(`[data-card-id="${cardId}"]`);
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                entityCard.classList.add('expanded');
                entityCard.title = 'Click to collapse details';
                } else {
                detailsDiv.style.display = 'none';
                entityCard.classList.remove('expanded');
                entityCard.title = 'Click to expand details';
            }
        }

        // Make toggleEntityDetails available globally
        window.toggleEntityDetails = toggleEntityDetails;

        // Theme toggle functionality
        let isDarkMode = true; // Start with dark mode
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const root = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            
            if (isDarkMode) {
                // Dark mode
                document.body.style.background = '#1e1e1e';
                document.body.style.color = '#d4d4d4';
                themeIcon.textContent = '🌙';
            } else {
                // Light mode  
                document.body.style.background = '#ffffff';
                document.body.style.color = '#333333';
                themeIcon.textContent = '☀️';
            }
        }
        window.toggleTheme = toggleTheme;

        // Unified dropdown functionality
        let dropdownData = {
            selectedJurisdiction: null,
            selectedSigner: null,
            selectedEntity: null
        };

        function populateUnifiedDropdown() {
            if (!xlnEnv) return;

            const dropdownContent = document.getElementById('dropdownContent');
            dropdownContent.innerHTML = '';

            // Add search field as first item
            const searchContainer = document.createElement('div');
            searchContainer.className = 'dropdown-search-container';
            searchContainer.innerHTML = `
                <div class="dropdown-item search-item">
                    <span class="item-icon">🔍</span>
                    <input type="text" 
                           placeholder="Find entity... (e.g., 1, 0x000..., alice.eth, 4.eth)" 
                           class="dropdown-search-input"
                           onclick="event.stopPropagation()"
                           oninput="handleDropdownSearch(this.value)"
                           style="background: transparent; border: none; color: #d4d4d4; flex: 1; outline: none;">
                </div>
            `;
            dropdownContent.appendChild(searchContainer);

            // Add separator
            const separator = document.createElement('div');
            separator.className = 'dropdown-separator';
            separator.style.cssText = 'height: 1px; background: #444; margin: 4px 0;';
            dropdownContent.appendChild(separator);

            // Full hierarchy tree: Jurisdictions → Signers → Entities
            const jurisdictions = [
                { key: 'ethereum', name: 'Ethereum', icon: '⟠' },
                { key: 'polygon', name: 'Polygon', icon: '◆' },
                { key: 'arbitrum', name: 'Arbitrum', icon: '△' }
            ];
            
            // Get all replicas for tree structure
            const replicasArray = xlnEnv.replicas ? 
                (Array.isArray(xlnEnv.replicas) ? xlnEnv.replicas : Array.from(xlnEnv.replicas.values())) : [];
            
            // Group entities by signer
            const entitiesBySigner = {};
            replicasArray.forEach(replica => {
                if (!entitiesBySigner[replica.signerId]) {
                    entitiesBySigner[replica.signerId] = [];
                }
                entitiesBySigner[replica.signerId].push(replica);
            });
            
            // All demo signers (show even if no entities)
            const demoSigners = ['alice', 'bob', 'carol', 'david', 'eve'];
            
            jurisdictions.forEach(jurisdiction => {
                // Add jurisdiction
                const jurisdictionItem = createDropdownItemWithAvatar(jurisdiction.icon, '', jurisdiction.name, jurisdiction.key, false, 0);
                jurisdictionItem.onclick = () => selectJurisdiction(jurisdiction.key);
                dropdownContent.appendChild(jurisdictionItem);
                
                // Filter entities by jurisdiction first
                const jurisdictionReplicas = replicasArray.filter(replica => {
                    // Check if replica's jurisdiction matches current jurisdiction
                    const replicaJurisdiction = replica.state?.config?.jurisdiction;
                    if (!replicaJurisdiction) return false;
                    
                    // Match jurisdiction by name (more robust than key matching)
                    return replicaJurisdiction.name === jurisdiction.name;
                });
                
                // Group jurisdiction entities by signer
                const jurisdictionEntitiesBySigner = {};
                jurisdictionReplicas.forEach(replica => {
                    if (!jurisdictionEntitiesBySigner[replica.signerId]) {
                        jurisdictionEntitiesBySigner[replica.signerId] = [];
                    }
                    jurisdictionEntitiesBySigner[replica.signerId].push(replica);
                });
                
                // Add signers that have entities in this jurisdiction
                const signersWithEntities = Object.keys(jurisdictionEntitiesBySigner);
                signersWithEntities.forEach(signer => {
                    // Get signer avatar
                    const signerAvatar = XLN.generateSignerAvatar ? XLN.generateSignerAvatar(signer) : '';
                    
                    // Create signer item (no emoji, only avatar)
                    const signerItem = createDropdownItemWithAvatar('', signerAvatar, `${signer}.eth`, signer, false, 1);
                    signerItem.onclick = () => selectSigner(signer);
                    dropdownContent.appendChild(signerItem);

                    // Add entities under this signer in this jurisdiction
                    const signerEntities = jurisdictionEntitiesBySigner[signer] || [];
                    signerEntities.forEach(replica => {
                        const entityDisplay = XLN.formatEntityDisplay ? XLN.formatEntityDisplay(replica.entityId) : replica.entityId;
                        const entityAvatar = XLN.generateEntityAvatar ? XLN.generateEntityAvatar(replica.entityId) : '';
                        
                        const entityItem = createDropdownItemWithAvatar('', entityAvatar, `${entityDisplay}`, replica.entityId, false, 2);
                        entityItem.onclick = () => selectEntity(replica.entityId, replica.signerId);
                        dropdownContent.appendChild(entityItem);
                    });
                });
            });
        }

        function createDropdownItem(icon, text, value, isHeader = false, indent = 0) {
            const item = document.createElement('div');
            item.className = `dropdown-item ${isHeader ? 'header' : ''} ${indent > 0 ? `indent-${indent}` : ''}`;
            
            item.innerHTML = `
                <span class="item-icon">${icon}</span>
                <span class="item-text">${text}</span>
            `;
            
            if (value) {
                item.dataset.value = value;
            }
            
            return item;
        }

        function createDropdownItemWithAvatar(icon, avatarSvg, text, value, isHeader = false, indent = 0) {
            const item = document.createElement('div');
            item.className = `dropdown-item ${isHeader ? 'header' : ''} ${indent > 0 ? `indent-${indent}` : ''}`;
            
            // Create icon span (only if no avatar)
            let iconSpan = null;
            if (!avatarSvg && icon) {
                iconSpan = document.createElement('span');
                iconSpan.className = 'item-icon';
                iconSpan.textContent = icon;
            }
            
            // Create avatar span if avatar is provided
            let avatarSpan = null;
            if (avatarSvg) {
                avatarSpan = document.createElement('span');
                avatarSpan.className = 'item-avatar';
                avatarSpan.style.cssText = 'display: inline-block; width: 32px; height: 32px; margin-right: 12px; vertical-align: middle;';
                
                // Fix encoding issue - the avatar might already be a data URL
                const avatarUrl = avatarSvg.startsWith('data:') ? avatarSvg : `data:image/svg+xml;charset=utf-8,${encodeURIComponent(avatarSvg)}`;
                
                // Create img element for avatar
                const avatarImg = document.createElement('img');
                avatarImg.src = avatarUrl;
                avatarImg.style.cssText = 'width: 100%; height: 100%; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);';
                
                // Create fallback div
                const fallbackDiv = document.createElement('div');
                fallbackDiv.style.cssText = 'width: 32px; height: 32px; border-radius: 16px; background: #333; display: none; align-items: center; justify-content: center; color: #9d9d9d; font-size: 16px; margin-right: 12px;';
                fallbackDiv.textContent = '👤'; // Default fallback
                
                // Add error handler
                avatarImg.onerror = () => {
                    console.log('❌ Dropdown avatar failed to load');
                    avatarImg.style.display = 'none';
                    fallbackDiv.style.display = 'flex';
                };
                
                avatarSpan.appendChild(avatarImg);
                avatarSpan.appendChild(fallbackDiv);
            }
            
            // Create text span
            const textSpan = document.createElement('span');
            textSpan.className = 'item-text';
            textSpan.textContent = text;
            
            // Append elements
            if (iconSpan) {
                item.appendChild(iconSpan);
            }
            if (avatarSpan) {
                item.appendChild(avatarSpan);
            }
            item.appendChild(textSpan);
            
            if (value) {
                item.dataset.value = value;
            }
            
            return item;
        }

        function selectJurisdiction(jurisdiction) {
            dropdownData.selectedJurisdiction = jurisdiction;
            dropdownData.selectedSigner = null;
            dropdownData.selectedEntity = null;
            updateDropdownText();
        }

        function selectSigner(signer) {
            dropdownData.selectedSigner = signer;
            dropdownData.selectedEntity = null;
            updateDropdownText();
        }

        function selectEntity(entityId, signerId) {
            dropdownData.selectedEntity = entityId;
            dropdownData.selectedSigner = signerId; // Also set the signer
            dropdownData.selectedJurisdiction = 'ethereum'; // Also set jurisdiction
            updateDropdownText();
            
            // Find and render the selected entity
            if (xlnEnv.replicas) {
                // Convert replicas Map to array before finding
                const replicasArray = Array.isArray(xlnEnv.replicas) ? xlnEnv.replicas : Array.from(xlnEnv.replicas.values());
                const selectedReplica = replicasArray.find(replica => 
                    replica.entityId === entityId && replica.signerId === signerId
                );
                if (selectedReplica) {
                    console.log(`🎯 Selected entity: ${XLN.formatEntityDisplay ? XLN.formatEntityDisplay(entityId) : entityId} (${signerId}.eth)`);
                    console.log('📊 Selected replica:', selectedReplica);
                    renderSelectedEntity(selectedReplica);
                    console.log('✅ renderSelectedEntity called');
                } else {
                    console.log(`❌ Entity not found: ${entityId} for signer ${signerId}`);
                    console.log('📋 Available replicas:', replicasArray.map(r => `${XLN.formatEntityDisplay ? XLN.formatEntityDisplay(r.entityId) : r.entityId} (${r.signerId})`));
                }
            }
            
            // Close dropdown
            toggleUnifiedDropdown();
        }

        function updateDropdownText() {
            const dropdownText = document.getElementById('dropdownText');
            const dropdownIcon = document.querySelector('.dropdown-icon');
            
            // Get jurisdiction display name
            const jurisdictionNames = {
                'ethereum': 'Ethereum',
                'polygon': 'Polygon', 
                'arbitrum': 'Arbitrum'
            };
            const jurisdictionDisplay = dropdownData.selectedJurisdiction ? 
                jurisdictionNames[dropdownData.selectedJurisdiction] || dropdownData.selectedJurisdiction : 
                'Select Jurisdiction';
            
            if (dropdownData.selectedEntity && dropdownData.selectedSigner) {
                const entityDisplay = XLN.formatEntityDisplay ? XLN.formatEntityDisplay(dropdownData.selectedEntity) : dropdownData.selectedEntity;
                dropdownText.textContent = `${jurisdictionDisplay} → ${dropdownData.selectedSigner}.eth → ${entityDisplay}`;
                dropdownIcon.textContent = '🏢';
            } else if (dropdownData.selectedSigner) {
                dropdownText.textContent = `${jurisdictionDisplay} → ${dropdownData.selectedSigner}.eth → Select Entity`;
                dropdownIcon.textContent = '👤';
            } else if (dropdownData.selectedJurisdiction) {
                dropdownText.textContent = `${jurisdictionDisplay} → Select Signer → Entity`;
                dropdownIcon.textContent = '⟠';
            } else {
                dropdownText.textContent = 'Select Jurisdiction → Signer → Entity';
                dropdownIcon.textContent = '⟠';
            }
        }

        function updateSelectedEntityFromTimeIndex() {
            console.log('🕰️ Updating selected entity from time index:', currentTimeIndex);
            
            let replicas;
            if (currentTimeIndex === -1) {
                // Live data
                replicas = xlnEnv.replicas;
                console.log('🕰️ Using live data');
            } else {
                // Historical data
                const history = XLN.getHistory();
                console.log('🕰️ History length:', history.length);
                if (currentTimeIndex < history.length) {
                    const snapshot = history[currentTimeIndex];
                    console.log('🕰️ Using historical data from index:', currentTimeIndex);
                    console.log('🕰️ Snapshot structure:', Object.keys(snapshot));
                    
                    // The snapshot IS the environment data, not wrapped in .env
                    replicas = snapshot.replicas;
                } else {
                    console.log('❌ Invalid time index:', currentTimeIndex, 'history length:', history.length);
                    return;
                }
            }
            
            if (!replicas) {
                console.log('❌ No replicas available');
                return;
            }
            
            console.log('🕰️ Replicas type:', typeof replicas, 'size:', replicas.size || replicas.length);
            
            // Find the selected entity in the current time slice
            const replicasArray = Array.isArray(replicas) ? replicas : Array.from(replicas.values());
            console.log('🕰️ Searching for entity:', dropdownData.selectedEntity, 'signer:', dropdownData.selectedSigner);
            console.log('🕰️ Available replicas:', replicasArray.map(r => `${r.entityId}:${r.signerId}`));
            
            const selectedReplica = replicasArray.find(replica => 
                replica.entityId === dropdownData.selectedEntity && replica.signerId === dropdownData.selectedSigner
            );
            
            if (selectedReplica) {
                console.log('🕰️ Found replica for time index, updating view');
                renderSelectedEntity(selectedReplica);
            } else {
                console.log('❌ Selected entity not found in current time slice');
            }
        }

        window.handleDropdownSearch = function(query) {
            if (!query.trim()) {
                populateUnifiedDropdown(); // Show full tree if search is empty
                return;
            }

            const dropdownContent = document.getElementById('dropdownContent');
            
            // Preserve the search input and only update results below it
            const existingSearchContainer = dropdownContent.querySelector('.dropdown-search-container');
            const existingSearchInput = existingSearchContainer ? existingSearchContainer.querySelector('input') : null;
            
            // Clear everything except search container
            const elementsToRemove = Array.from(dropdownContent.children).filter(child => 
                !child.classList.contains('dropdown-search-container')
            );
            elementsToRemove.forEach(element => element.remove());
            
            // Update search input value if it exists and is different
            if (existingSearchInput && existingSearchInput.value !== query) {
                existingSearchInput.value = query;
            }

            // Add separator
            const separator = document.createElement('div');
            separator.className = 'dropdown-separator';
            separator.style.cssText = 'height: 1px; background: #444; margin: 4px 0;';
            dropdownContent.appendChild(separator);

            const results = [];
            const lowerQuery = query.toLowerCase();

            // Search jurisdictions
            const jurisdictions = [
                { key: 'ethereum', name: 'Ethereum', icon: '⟠', terms: ['ethereum', 'eth'] },
                { key: 'polygon', name: 'Polygon', icon: '◆', terms: ['polygon', 'matic', 'poly'] },
                { key: 'arbitrum', name: 'Arbitrum', icon: '△', terms: ['arbitrum', 'arb'] }
            ];
            
            jurisdictions.forEach(jurisdiction => {
                if (jurisdiction.terms.some(term => term.includes(lowerQuery)) || jurisdiction.name.toLowerCase().includes(lowerQuery)) {
                    results.push({
                        type: 'jurisdiction',
                        icon: jurisdiction.icon,
                        text: jurisdiction.name,
                        value: jurisdiction.key,
                        onClick: () => selectJurisdiction(jurisdiction.key)
                    });
                }
            });

            // Search signers
            const demoSigners = ['alice', 'bob', 'carol', 'david', 'eve'];
            demoSigners.forEach(signer => {
                const signerText = `${signer}.eth`;
                if (signerText.includes(lowerQuery) || signer.includes(lowerQuery)) {
                    const signerAvatar = XLN.generateSignerAvatar ? XLN.generateSignerAvatar(signer) : '';
                    results.push({
                        type: 'signer',
                        icon: '👤',
                        avatar: signerAvatar,
                        text: signerText,
                        value: signer,
                        onClick: () => selectSigner(signer)
                    });
                }
            });

            // Search entities
            if (xlnEnv.replicas) {
                const replicasArray = Array.isArray(xlnEnv.replicas) ? xlnEnv.replicas : Array.from(xlnEnv.replicas.values());
                replicasArray.forEach(replica => {
                    const entityDisplay = XLN.formatEntityDisplay ? XLN.formatEntityDisplay(replica.entityId) : replica.entityId;
                    const searchTargets = [
                        entityDisplay.toLowerCase(),
                        replica.entityId.toLowerCase(),
                        `${entityDisplay}.eth`.toLowerCase(),
                        `${replica.signerId}.eth`.toLowerCase()
                    ];

                    if (searchTargets.some(target => target.includes(lowerQuery))) {
                        const entityAvatar = XLN.generateEntityAvatar ? XLN.generateEntityAvatar(replica.entityId) : '';
                        results.push({
                            type: 'entity',
                            icon: '🏢',
                            avatar: entityAvatar,
                            text: `${entityDisplay} (${replica.signerId}.eth)`,
                            value: replica.entityId,
                            onClick: () => selectEntity(replica.entityId, replica.signerId)
                        });
                    }
                });
            }

            // Display results
            if (results.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'dropdown-item';
                noResults.innerHTML = `<span class="item-icon">❌</span><span class="item-text">No results found</span>`;
                dropdownContent.appendChild(noResults);
            } else {
                results.forEach(result => {
                    const item = createDropdownItemWithAvatar(result.icon, result.avatar || '', result.text, result.value, false, 0);
                    item.onclick = result.onClick;
                    // Highlight search term
                    const textSpan = item.querySelector('.item-text');
                    if (textSpan) {
                        textSpan.innerHTML = highlightSearchTerm(textSpan.textContent, query);
                    }
                    dropdownContent.appendChild(item);
                });
            }
        }



        function toggleUnifiedDropdown() {
            const dropdownBtn = document.querySelector('.unified-dropdown-btn');
            const dropdownContent = document.getElementById('dropdownContent');
            
            dropdownBtn.classList.toggle('open');
            dropdownContent.classList.toggle('show');
            
            if (dropdownContent.classList.contains('show')) {
                populateUnifiedDropdown();
            }
        }
        window.toggleUnifiedDropdown = toggleUnifiedDropdown;

        // Close dropdowns when clicking outside (for individual tab dropdowns)
        document.addEventListener('click', function(event) {
            // Close all tab dropdowns if clicking outside
            const clickedDropdown = event.target.closest('.unified-dropdown');
            if (!clickedDropdown) {
                document.querySelectorAll('.unified-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('open');
                });
            }
        });
        

        

        
        function renderSelectedEntity(replica) {
            console.log('🖼️ renderSelectedEntity called with:', replica);
            const selectedEntityView = document.getElementById('selectedEntityView');
            
            if (!selectedEntityView) {
                console.error('❌ selectedEntityView element not found!');
                return;
            }
            
            // Make the selected entity view visible
            selectedEntityView.style.display = 'block';
            console.log('👁️ selectedEntityView made visible');
            
            // Create comprehensive entity profile page
            selectedEntityView.innerHTML = '';
            
            const config = replica.state.config;
            const shares = config.validators.includes(replica.signerId) ? 1 : 0;
            const totalShares = config.validators.length;
            const sharePercent = totalShares > 0 ? ((shares / totalShares) * 100).toFixed(1) : '0.0';
            const isProposer = replica.isProposer;
            // Mode class removed - we don't show gossip/proposer distinction
            
            // Get avatars
            console.log('🖼️ Getting avatars for entity:', replica.entityId, 'signer:', replica.signerId);
            console.log('🔍 XLN.generateEntityAvatar available:', !!XLN.generateEntityAvatar);
            console.log('🔍 XLN.generateSignerAvatar available:', !!XLN.generateSignerAvatar);
            
            const entityAvatar = XLN.generateEntityAvatar ? XLN.generateEntityAvatar(replica.entityId) : '';
            const signerAvatar = XLN.generateSignerAvatar ? XLN.generateSignerAvatar(replica.signerId) : '';
            
            console.log('🖼️ Entity avatar length:', entityAvatar.length);
            console.log('🖼️ Signer avatar length:', signerAvatar.length);
            
            if (entityAvatar.length > 100) {
                console.log('🖼️ Entity avatar preview:', entityAvatar.substring(0, 100) + '...');
            }
            if (signerAvatar.length > 100) {
                console.log('🖼️ Signer avatar preview:', signerAvatar.substring(0, 100) + '...');
            }
            
            const profilePage = document.createElement('div');
            profilePage.className = 'entity-profile-page';
            profilePage.style.cssText = 'padding: 24px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333;';
            
            // Create avatar HTML with fallbacks
            // Fix encoding issue - the avatar might already be a data URL
            const entityAvatarUrl = entityAvatar.startsWith('data:') ? entityAvatar : `data:image/svg+xml;charset=utf-8,${encodeURIComponent(entityAvatar)}`;
            const signerAvatarUrl = signerAvatar.startsWith('data:') ? signerAvatar : `data:image/svg+xml;charset=utf-8,${encodeURIComponent(signerAvatar)}`;
            
            console.log('🔧 Entity avatar URL length:', entityAvatarUrl.length);
            console.log('🔧 Signer avatar URL length:', signerAvatarUrl.length);
            
            const entityAvatarImg = entityAvatar ? 
                `<img src="${entityAvatarUrl}" 
                      style="width: 80px; height: 80px; border-radius: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);" 
                      onerror="console.log('❌ Entity avatar failed to load'); this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                 <div style="width: 80px; height: 80px; border-radius: 40px; background: #333; display: none; align-items: center; justify-content: center; color: #9d9d9d; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">🏢</div>` :
                `<div style="width: 80px; height: 80px; border-radius: 40px; background: #333; display: flex; align-items: center; justify-content: center; color: #9d9d9d; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">🏢</div>`;
                
            const signerAvatarImg = signerAvatar ?
                `<img src="${signerAvatarUrl}" 
                      style="width: 24px; height: 24px; border-radius: 12px; margin-right: 8px;" 
                      onerror="console.log('❌ Signer avatar failed to load'); this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                 <div style="width: 24px; height: 24px; border-radius: 12px; background: #333; display: none; align-items: center; justify-content: center; color: #9d9d9d; font-size: 12px; margin-right: 8px;">👤</div>` :
                `<div style="width: 24px; height: 24px; border-radius: 12px; background: #333; display: flex; align-items: center; justify-content: center; color: #9d9d9d; font-size: 12px; margin-right: 8px;">👤</div>`;
            
            profilePage.innerHTML = `
                <div class="profile-header" style="display: flex; align-items: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid #333;">
                    <div class="entity-avatar" style="margin-right: 20px;">
                        ${entityAvatarImg}
                    </div>
                    <div class="entity-title-section">
                        <h1 style="margin: 0 0 8px 0; color: #fff; font-size: 32px; font-weight: 600;">
                            Entity ${XLN.formatEntityDisplay ? XLN.formatEntityDisplay(replica.entityId) : replica.entityId}
                        </h1>
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            ${signerAvatarImg}
                            <span style="color: #9d9d9d; font-size: 18px;">${XLN.formatSignerDisplay ? XLN.formatSignerDisplay(replica.signerId) : replica.signerId}</span>
                        </div>
                        <div class="entity-mode ${modeClass}" style="display: inline-block; padding: 4px 12px; border-radius: 16px; font-size: 14px; font-weight: 500;">${config.mode}</div>
                    </div>
                </div>
                
                <div class="profile-metrics" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px;">
                    <div class="metric-card" style="background: #2d2d2d; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 600; color: #007acc; margin-bottom: 4px;">${sharePercent}%</div>
                        <div style="color: #9d9d9d; font-size: 14px;">Voting Power</div>
                    </div>
                    <div class="metric-card" style="background: #2d2d2d; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 600; color: #007acc; margin-bottom: 4px;">${replica.state.messages.length}</div>
                        <div style="color: #9d9d9d; font-size: 14px;">Messages</div>
                    </div>
                    <div class="metric-card" style="background: #2d2d2d; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 600; color: #007acc; margin-bottom: 4px;">${replica.state.proposals.size}</div>
                        <div style="color: #9d9d9d; font-size: 14px;">Proposals</div>
                    </div>
                    <div class="metric-card" style="background: #2d2d2d; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 600; color: #007acc; margin-bottom: 4px;">${replica.state.height}</div>
                        <div style="color: #9d9d9d; font-size: 14px;">Height</div>
                    </div>
                </div>
                
                <div class="profile-sections" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="section-card" style="background: #2d2d2d; padding: 20px; border-radius: 8px;">
                        <h3 style="margin: 0 0 16px 0; color: #fff; font-size: 18px; font-weight: 600;">🔧 Configuration</h3>
                        <div style="color: #d4d4d4; line-height: 1.6;">
                            <div><strong>Entity ID:</strong></div>
                            <div style="font-family: monospace; color: #9d9d9d; word-break: break-all; margin-bottom: 12px;">${replica.entityId}</div>
                            <div><strong>Signer:</strong> <span style="font-family: monospace; color: #9d9d9d;">${replica.signerId}</span></div>
                            <div><strong>Role:</strong> ${isProposer ? '👑 Proposer' : '✅ Validator'}</div>
                            <div><strong>Consensus:</strong> ${config.threshold}/${config.validators.length} threshold</div>
                            <div><strong>Mode:</strong> ${config.mode}</div>
                            <div><strong>Validators:</strong> ${config.validators.join(', ')}</div>
                        </div>
                    </div>
                    
                    <div class="section-card" style="background: #2d2d2d; padding: 20px; border-radius: 8px;">
                        <h3 style="margin: 0 0 16px 0; color: #fff; font-size: 18px; font-weight: 600;">📊 State Info</h3>
                        <div style="color: #d4d4d4; line-height: 1.6;">
                            <div><strong>Height:</strong> ${replica.state.height}</div>
                            <div><strong>Timestamp:</strong> ${new Date(replica.state.timestamp).toLocaleString()}</div>
                            <div><strong>Mempool:</strong> ${replica.mempool.length} transactions</div>
                            <div><strong>Nonces:</strong> ${replica.state.nonces.size} tracked</div>
                            ${replica.proposal ? `<div><strong>Current Proposal:</strong> Height ${replica.proposal.height}</div>` : ''}
                            ${replica.lockedFrame ? `<div><strong>Locked Frame:</strong> Height ${replica.lockedFrame.height}</div>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="profile-sections" style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-top: 24px;">
                    <div class="section-card" style="background: #2d2d2d; padding: 20px; border-radius: 8px;">
                        <h3 style="margin: 0 0 16px 0; color: #fff; font-size: 18px; font-weight: 600;">💬 Messages (${replica.state.messages.length})</h3>
                        <div style="max-height: 200px; overflow-y: auto; background: #1e1e1e; border-radius: 4px; padding: 12px;">
                            ${replica.state.messages.length > 0 ? 
                                replica.state.messages.slice(-10).map((msg, i) => 
                                    `<div style="color: #d4d4d4; padding: 4px 0; border-bottom: 1px solid #333; font-family: monospace; font-size: 13px;">${i + 1}. ${msg}</div>`
                                ).join('') : 
                                '<div style="color: #666; text-align: center; padding: 20px;">No messages yet</div>'
                            }
                        </div>
                    </div>
                </div>
                
                <div class="profile-sections" style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-top: 24px;">
                    <div class="section-card" style="background: #2d2d2d; padding: 20px; border-radius: 8px;">
                        <h3 style="margin: 0 0 16px 0; color: #fff; font-size: 18px; font-weight: 600;">📋 Proposals (${replica.state.proposals.size})</h3>
                        <div style="max-height: 300px; overflow-y: auto; background: #1e1e1e; border-radius: 4px; padding: 12px;">
                            ${replica.state.proposals.size > 0 ? 
                                Array.from(replica.state.proposals.entries()).slice(-5).map(([propId, proposal]) => 
                                    `<div style="background: #333; margin-bottom: 12px; padding: 16px; border-radius: 4px;">
                                        <div style="color: #007acc; font-weight: 600; margin-bottom: 8px;">${propId}</div>
                                        <div style="color: #d4d4d4; margin-bottom: 4px;"><strong>By:</strong> ${proposal.proposer}</div>
                                        <div style="color: #d4d4d4; margin-bottom: 4px;"><strong>Status:</strong> <span style="color: ${proposal.status === 'passed' ? '#4CAF50' : proposal.status === 'failed' ? '#f44336' : '#ff9800'};">${proposal.status}</span></div>
                                        <div style="color: #d4d4d4; margin-bottom: 8px;"><strong>Votes:</strong> ${proposal.votes.size}/${config.validators.length}</div>
                                        <div style="color: #9d9d9d; font-size: 13px; font-family: monospace;">${proposal.action.data.message}</div>
                                    </div>`
                                ).join('') : 
                                '<div style="color: #666; text-align: center; padding: 20px;">No proposals yet</div>'
                            }
                        </div>
                    </div>
                </div>
                
                ${replica.mempool.length > 0 ? `
                <div class="profile-sections" style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-top: 24px;">
                    <div class="section-card" style="background: #2d2d2d; padding: 20px; border-radius: 8px;">
                        <h3 style="margin: 0 0 16px 0; color: #fff; font-size: 18px; font-weight: 600;">⏳ Mempool (${replica.mempool.length})</h3>
                        <div style="max-height: 200px; overflow-y: auto; background: #1e1e1e; border-radius: 4px; padding: 12px;">
                            ${replica.mempool.slice(-5).map((tx, i) => 
                                `<div style="color: #d4d4d4; padding: 8px; margin-bottom: 4px; background: #333; border-radius: 4px; font-family: monospace; font-size: 13px;">
                                    <div><strong>Type:</strong> ${tx.type}</div>
                                    <div><strong>Data:</strong> ${JSON.stringify(tx.data, (key, value) => typeof value === 'bigint' ? value.toString() : value).slice(0, 100)}...</div>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                </div>` : ''}
            `;
            
            selectedEntityView.appendChild(profilePage);
            console.log('✅ Entity card appended to selectedEntityView');
            console.log('🎯 renderSelectedEntity completed successfully');
        }
        
        // Event handlers for dropdowns
        // No longer needed - unified dropdown handles its own events
        
        // Placeholder functions for admin buttons
        function showEntityCreator() {
            console.log('🏛️ Show entity creator');
            // TODO: Show entity creation modal
            alert('Entity Creator coming soon! Use the Controls section in any panel for now.');
        }

        // Expose to global scope
        window.showEntityCreator = showEntityCreator;
        
        function showSettings() {
            console.log('Show settings');
            
            // Create settings modal if it doesn't exist
            let settingsModal = document.getElementById('settingsModal');
            if (!settingsModal) {
                settingsModal = document.createElement('div');
                settingsModal.id = 'settingsModal';
                settingsModal.className = 'modal-overlay';
                settingsModal.innerHTML = `
                    <div class="modal-content settings-modal">
                        <div class="modal-header">
                            <h3>⚙️ Settings</h3>
                            <button class="modal-close" onclick="closeSettings()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-group">
                                <label for="dropdownModeToggle">
                                    <strong>Dropdown Hierarchy Mode</strong>
                                    <br><small>Toggle between Jurisdiction→Signer→Entity vs Jurisdiction→Entity→Signers</small>
                                </label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="dropdownModeToggle" onchange="toggleDropdownMode()">
                                    <span class="toggle-slider"></span>
                                </div>
                                <div class="toggle-labels">
                                    <span>Jur→Signer→Entity</span>
                                    <span>Jur→Entity→Signers</span>
                                </div>
                            </div>
                            
                            <div class="setting-group">
                                <label for="serverDelaySlider">
                                    <strong>Server Processing Delay</strong>
                                    <br><small>Simulate network delay in consensus processing (0ms = instant)</small>
                                </label>
                                <div class="slider-container">
                                    <input type="range" id="serverDelaySlider" min="0" max="1000" value="0" oninput="updateServerDelay(this.value)">
                                    <div class="slider-value">
                                        <span id="delayValue">0</span> ms
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(settingsModal);
                
                // Load current settings
                const currentDropdownMode = localStorage.getItem('xln-dropdown-mode') === 'entity-first';
                document.getElementById('dropdownModeToggle').checked = currentDropdownMode;
                
                const currentDelay = parseInt(localStorage.getItem('xln-server-delay') || '0');
                document.getElementById('serverDelaySlider').value = currentDelay;
                document.getElementById('delayValue').textContent = currentDelay;
            }
            
            settingsModal.style.display = 'flex';
        }
        
        function closeSettings() {
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.style.display = 'none';
            }
        }
        
        function updateServerDelay(value) {
            document.getElementById('delayValue').textContent = value;
            localStorage.setItem('xln-server-delay', value);
            // Apply the delay to processUntilEmpty - we'll need to modify that function
            window.serverDelay = parseInt(value);
        }
        
        window.populateUnifiedDropdown = populateUnifiedDropdown;
        window.toggleUnifiedDropdown = toggleUnifiedDropdown;
        window.showEntityCreator = showEntityCreator;
        window.showSettings = showSettings;
        window.closeSettings = closeSettings;
        window.updateServerDelay = updateServerDelay;
        window.submitChatMessage = submitChatMessage;
        window.submitProposal = submitProposal;
        window.submitVote = submitVote;
        // Removed voteOnProposal - replaced with dropdown-based voting

        // History I/O collapse functionality
        function toggleHistoryIO() {
            const historyContent = document.getElementById('historyContent');
            const historyToggle = document.getElementById('historyToggle');
            
            if (historyContent.style.display === 'none') {
                historyContent.style.display = 'block';
                historyToggle.textContent = '▼';
                historyToggle.classList.remove('collapsed');
            } else {
                historyContent.style.display = 'none';
                historyToggle.textContent = '▶';
                historyToggle.classList.add('collapsed');
            }
        }
        window.toggleHistoryIO = toggleHistoryIO;

        async function main() {
            try {
                // Wait for the environment to load from the database
                xlnEnv = await XLN.main();
                window.xlnEnv = xlnEnv; // Make it globally accessible
                console.log('🎯 XLN Environment loaded:', xlnEnv);
                console.log('💡 Access via: window.xlnEnv');

                // 3. Perform initial UI setup and render

                setupEntitySearch(); // Initialize autocomplete search
                initializeTabSystem(); // Initialize the tab system
                updateTotalWeight();
                populateJurisdictions(); // Populate available jurisdictions
                window.onEntityTypeChange(); // Initialize entity type display
        window.onJurisdictionChange(); // Initialize jurisdiction with Ethereum default
        setTimeout(() => window.updateExpectedEntityId(), 100); // Initialize entity ID preview
                // Entities now rendered by unified dropdown selection - no need for initial renderEntities call

                // Time machine event handling is done in DOMContentLoaded above

                // 3. Initialize validator selectors on the form
                document.querySelectorAll('.validator-row[data-validator-id]').forEach(row => {
                    const validatorId = row.getAttribute('data-validator-id');
                    if (validatorId) {
                        initializeValidatorSelector(validatorId);
                    }
                });

                // 4. Add global click handler to close validator dropdowns
                document.addEventListener('click', (event) => {
                    // Close validator dropdowns if click is outside
                    if (!event.target.closest('.validator-selector-container')) {
                        document.querySelectorAll('.validator-dropdown').forEach(dropdown => {
                            dropdown.style.display = 'none';
                            const selector = dropdown.parentElement.querySelector('.validator-selector');
                            if (selector) selector.classList.remove('open');
                        });
                    }
                });

                // 4. Start the continuous render loop for live updates
                setInterval(renderEntities, 1000);

            } catch (error) {
                console.error('Failed to initialize XLN environment:', error);
                // Optionally update some status element on the page
            }
        }

        // Run the main function when the document is ready
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html> 
</html> 
</html> 